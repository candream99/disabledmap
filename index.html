<!DOCTYPE html>
<html lang="ko">
<head>
    <script type="text/javascript">
    // 접속한 기기가 모바일인지 확인하는 함수
    function isMobile() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    // 데스크톱(PC)일 경우, 내부에 만든 'pc' 폴더의 index.html로 이동
    if (!isMobile()) {
        // 도메인을 유지하면서 폴더만 이동합니다.
        window.location.href = "./pc/index.html"; 
    }
   </script> <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>네이버 벡터맵 테스트 - 무장애 시설 팝업 최종본 (층별 경계 분리)</title>
    <style>
        /* ------------------------------------------------ */
        /* 모바일 스크롤 잠금 */
        /* ------------------------------------------------ */
        body { 
            margin: 0;
            padding: 0; 
            height: 100vh; 
            font-family: 'Malgun Gothic', sans-serif;
            overflow: hidden; 
        }
        #map { width: 100%;
            height: 100%; 
        }
        
        /* ------------------------------------------------ */
        /* 검색창 스타일 */
        /* ------------------------------------------------ */
        #searchBox {
            position: absolute;
            top: 20px; 
            left: 50%;
            transform: translateX(-50%);
            width: 80vw; 
            max-width: 500px; 
            height: 48px;
            background: #ffffff;
            border-radius: 24px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.2); 
            display: flex;
            align-items: center;
            padding: 0 15px; 
            z-index: 2000;
        }
        #hamburgerBtn {
            width: 24px;
            height: 24px;
            background: none;
            border: none;
            padding: 0;
            margin-right: 10px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            align-items: center;
        }
        .burger-line {
            display: block;
            width: 18px;
            height: 2px;
            background-color: #333;
            border-radius: 1px;
        }
        /* 초기 플레이스홀더 스타일 */
        #searchPlaceholder {
            flex-grow: 1;
            font-size: 16px;
            color: #a0a0a0; 
            pointer-events: auto; 
            user-select: none;
        }
        
        /* 검색 입력 필드 스타일 */
        #searchInput {
            flex-grow: 1; 
            font-size: 16px;
            border: none;
            outline: none; 
            padding: 0;
            margin: 0;
            color: #333;
            background: transparent;
            width: calc(100% - 70px); 
            display: none; 
        }
        
        /* 검색 버튼 및 닫기 버튼 공통 스타일 */
        .search-icon-btn {
            width: 24px;
            height: 24px;
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #333;
            font-size: 18px;
        }

        #searchBtn {
            margin-left: 5px; 
            display: none; 
        }

        #closeSearchBtn {
            margin-left: 5px; 
            display: none; 
        }
        
        /* ------------------------------------------------ */
        /* coordDisplay 스타일 */
        /* ------------------------------------------------ */
        #coordDisplay {
            position: absolute;
            top: 79px;
            left: 50%;
            transform: translateX(-50%);
            width: 80vw;
            max-width: 500px;
            height: 24px;
            background: rgba(255, 255, 255, 0.9);
            color: #000000;
            border-radius: 24px;
            display: flex;
            justify-content: center; 
            align-items: center; 
            padding: 0 15px; 
            font-size: 14px;
            z-index: 1500;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2); 
            transition: all 0.3s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: unset; 
        }

        /* ------------------------------------------------ */
        /* 검색 목록 컨테이너 스타일 */
        /* ------------------------------------------------ */
        #searchListContainer {
            position: absolute;
            top: 108px; /* coordDisplay 아래에 드롭다운 */
            left: 50%;
            transform: translateX(-50%);
            width: 80vw;
            max-width: 500px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
            z-index: 1500;
            padding: 0 10px; /* 내부 padding 조정 */
            display: none; 
            max-height: 55vh; /* 최대 높이 지정 */
            overflow-y: auto; /* 스크롤 가능 */
            overscroll-behavior: contain;
        }

        /* 단일 검색 결과 항목 스타일 */
        .search-result-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 0;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }

        .search-result-item:hover {
            background-color: #f9f9f9;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        /* 이미지 스타일 */
        .result-image {
            width: 60px; 
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            flex-shrink: 0;
        }

        /* 텍스트 정보 스타일 */
        .result-text-info {
            flex-grow: 1;
        }

        .result-name {
            font-weight: bold;
            font-size: 0.95rem;
            margin-bottom: 2px;
            color: #333;
        }

        /* 주소/영업시간 항목 스타일 */
        .result-info-item {
            display: flex;
            align-items: flex-start;
            font-size: 0.75rem;
            color: #777;
            line-height: 1.3;
        }
        .result-info-item i {
            width: 12px;
            text-align: center;
            margin-right: 4px;
            line-height: 1.3;
        }
        
        /* ------------------------------------------------ */
        /* 공통 원형 버튼 스타일 */
        .map-btn-circle {
            width: 40px;
            height: 40px;
            padding: 0;
            cursor: pointer;
            background: #ffffff;
            border: none; 
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            color: #000;
            font-weight: normal;
            font-size: 14px;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            line-height: 1;
        }

        /* 현재 위치 버튼 스타일 */
        #geolocationBtn {
            position: absolute;
            bottom: 18px; 
            left: 10px;
            z-index: 1500;
            font-size: 0; 
        }

        /* ----- Geolocation 아이콘 스타일 ----- */
        #geolocationBtn .geo-icon {
            display: block;
            width: 18px;
            height: 18px;
            border: 2px solid #333; 
            border-radius: 50%;
            position: relative;
            box-sizing: border-box;
            background-color: transparent;
        }

        #geolocationBtn .geo-icon::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 4px;
            height: 4px;
            background-color: #333; 
            border-radius: 50%;
        }

        #geolocationBtn.active .geo-icon {
            border: none;
            background-color: transparent;
            width: 0;
            height: 0;
            transform: none; 
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 12px solid #007bff;
            margin-bottom: 6px; 
        }

        #geolocationBtn.active .geo-icon::after {
            content: none;
        }
        /* ------------------------------------- */
        
        /* 층 컨트롤 컨테이너 스타일 */
        #floorControls {
            position: absolute;
            bottom: 88px; 
            left: 10px;
            display: none;
            flex-direction: column-reverse; 
            gap: 8px; 
            z-index: 1500;
            background: transparent;
            padding: 0;
            box-shadow: none;
        }

        /* 층 버튼/액세스 버튼 스타일 (공통 원형 스타일 상속) */
        .floor-btn {
            font-size: 14px;
        }

        /* 클릭된 버튼 활성 스타일 */
        .map-btn-circle.active {
            background: #007bff;
            color: #fff;
            font-weight: bold;
        }

        /* ------------------------------------- */
        /* 무장애 시설 버튼 이미지 스타일 */
        /* ------------------------------------- */
        #accessInfoBtn {
            margin-bottom: 18px;
            font-size: 0;
            line-height: 0; 
        }
        
        /* Icon (span inside button) */
        #accessInfoBtn .i-icon {
            display: block;
            width: 25px; 
            height: 25px;
            background-size: contain; 
            background-repeat: no-repeat;
            background-position: center;
            background-image: url('https://raw.githubusercontent.com/candream99/disabledmap/main/i_button.png');
        }

        /* 활성화 시 이미지 (파란색 배경) */
        #accessInfoBtn.active .i-icon {
            background-image: url('https://raw.githubusercontent.com/candream99/disabledmap/main/i_button2.png');
        }
        /* ------------------------------------- */
        
        /* 무장애 팝업 (수정: max-height와 overflow-y 추가) */
        #accessPopup {
            position: absolute;
            left: auto; /* JS에서 위치 계산 */
            width: 90%;
            max-width: 240px;
            background: white;
            padding: 10px;
            border-radius: 6px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
            display: none;
            z-index: 2000;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }

        /* --- 팝업 섹션 스타일 --- */
        .popup-section {
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee; /* 섹션 구분선 */
        }

        .popup-section:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        /* 1. 건물 정보 섹션 레이아웃 */
        #buildingInfoSection {
            display: flex;
            align-items: flex-start;
            gap: 10px; /* 사진과 텍스트 사이 간격 */
        }

        /* 건물 사진 */
        #buildingImage {
            width: 33.33%;
            height: auto;
            object-fit: cover;
            border-radius: 4px;
        }

        /* 건물 정보 텍스트 컨테이너 */
        #buildingTextInfo {
            flex-grow: 1;
        }
        
        /* 건물 이름 */
        #buildingName {
            font-weight: bold;
            font-size: 1rem;
            margin-bottom: 4px;
        }

        /* 주소 및 영업시간 항목 */
        .info-item {
            display: flex;
            align-items: flex-start;
            font-size: 0.85rem;
            color: #555;
            margin-bottom: 2px;
        }
        
        .info-item i {
            width: 14px;
            text-align: center;
            margin-right: 5px;
            line-height: 1.5; /* 텍스트와 심볼 높이 맞추기 */
        }
        
        /* 무장애 시설 정보 항목 스타일 */
        .access-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .access-status {
            font-weight: 600;
            min-width: 40px;
            text-align: right;
        }

        .status-positive {
            color: #10b981;
        }

        .status-negative {
            color: #ef4444;
        }
        /* [추가] 우측 하단 버튼 그룹 (지하철, 소개) 스타일 */
.right-bottom-btn {
    position: absolute;
    right: 20px;        /* 오른쪽 여백 */
    width: 45px;        /* 기존 현재위치 버튼과 비슷한 크기 */
    height: 45px;
    background-color: #ffffff;
    border: 1px solid #ccc;
    border-radius: 4px; /* 사각형 모서리 둥글게 (기존 버튼 스타일에 맞춤) */
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    z-index: 1000;      /* 지도 위에 표시 */
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 0;
}

/* 버튼 내부 이미지 크기 조절 */
.right-bottom-btn img {
    width: 28px;
    height: 28px;
    object-fit: contain;
}

/* 위치 지정 */
#introBtn {
    bottom: 20px; /* 현재위치 버튼과 동일선상 (바닥에서 20px) */
}

#subwayBtn {
    bottom: 75px; /* 소개 버튼(45px) + 간격(10px) + 여백(20px) = 75px */
}

/* [추가] 소개 팝업창 스타일 */
#mobileIntroOverlay {
    display: none; /* 기본 숨김 */
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6); /* 반투명 검은 배경 */
    z-index: 9999;
    justify-content: center;
    align-items: center;
}

.mobile-intro-content {
    position: relative;
    width: 90%;
    max-width: 400px;
    background: transparent; /* 배경 투명 (이미지 자체만 보여줌) */
    text-align: center;
}

.mobile-intro-content img {
    width: 100%;
    height: auto;
    border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

.mobile-intro-close {
    position: absolute;
    top: -40px;
    right: 0;
    font-size: 30px;
    color: white;
    background: none;
    border: none;
    cursor: pointer;
}

    </style>
</head>
<body>
    <div id="map"></div>
    
    <div id="searchBox">
        <button id="hamburgerBtn" title="메뉴">
            <span class="burger-line"></span>
            <span class="burger-line"></span>
            <span class="burger-line"></span>
        </button>
        <div id="searchPlaceholder">건물이름을 검색하세요</div>
        <input type="text" id="searchInput" placeholder="건물이름을 입력하세요">
        <button id="searchBtn" class="search-icon-btn" title="검색">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
            </svg>
        </button>
        <button id="closeSearchBtn" class="search-icon-btn" title="검색 취소">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
            </svg>
        </button>
    </div>
    
    <div id="coordDisplay" 
class="outdoor-mode-coord">건물을 
 클릭하면 실내지도를 볼 수 있어요</div>
    <button id="subwayBtn" class="right-bottom-btn" title="지하철 노선도 보기">
    <img src="https://raw.githubusercontent.com/candream99/disabledmap/main/pc/subway.png" alt="지하철">
</button>

<button id="introBtn" class="right-bottom-btn" title="서비스 소개">
    <img src="https://raw.githubusercontent.com/candream99/disabledmap/main/pc/subway.png" alt="소개">
</button>

<div id="mobileIntroOverlay">
    <div class="mobile-intro-content">
        <button class="mobile-intro-close" onclick="document.getElementById('mobileIntroOverlay').style.display='none'">&times;</button>
        <img src="https://raw.githubusercontent.com/candream99/disabledmap/main/intro-01.png" alt="회사 소개">
    </div>
</div>
    
    <div id="searchListContainer">
        </div>
 
    <button id="geolocationBtn" class="map-btn-circle" title="현재 위치 찾기"><span class="geo-icon"></span></button>
    
    <div id="floorControls">
        <button id="accessInfoBtn" class="floor-btn map-btn-circle" data-floor="access" title="무장애 시설 정보"><span class="i-icon"></span></button>
        </div>

    <div id="accessPopup" style="display:none;">
        <span id="accessPopupClose" style="position:absolute; top:6px; right:10px; font-size:22px; cursor:pointer;
color:#777;">×</span>
        
        <div id="accessPopupBody">
            <div id="buildingInfoSection" class="popup-section">
                </div>
            
            <div id="accessFacilitySection" class="popup-section">
                </div>
        </div>
  
       </div>

    <script>
        
        var NCP_KEY_ID = 'q1d23mmkof';
        var script = document.createElement('script');
        script.src = 'https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=' + NCP_KEY_ID + '&vmode=3';

        script.onload = function () 
{
            // 전역 DOM 요소 변수
            var mapContainer = document.getElementById('map');
            var searchBox = document.getElementById('searchBox'); 
            var coordDisplay = document.getElementById('coordDisplay');
  
            // 검색 관련 DOM 요소 변수
            var searchPlaceholder = document.getElementById('searchPlaceholder');
            var searchInput = document.getElementById('searchInput');
            var searchBtn = document.getElementById('searchBtn');
            var closeSearchBtn = document.getElementById('closeSearchBtn');
            var searchListContainer = document.getElementById('searchListContainer'); 
    searchListContainer.addEventListener('touchstart', function () {
    if (document.activeElement === searchInput) {
        searchInput.blur();
    }
});

            var floorControlsContainer = document.getElementById('floorControls');
            var popup = document.getElementById('accessPopup');
            var buildingInfoSection = document.getElementById('buildingInfoSection');
            var accessFacilitySection = document.getElementById('accessFacilitySection');
            
            var accessBtn = document.getElementById('accessInfoBtn');
            var popupClose = document.getElementById('accessPopupClose');
            var geolocationBtn = document.getElementById('geolocationBtn');
            
            // 지도 옵션
            var mapOptions = {
                center: new naver.maps.LatLng(37.5710, 126.9784),
                zoom: 17, 
                zoomControl: false, 
                scrollWheelZoom: false, 
                pinchZoom: true,
                mapTypes: new naver.maps.MapTypeRegistry({
               normal: naver.maps.NaverStyleMapTypeOptions.getVectorMap(),
               
  }),
            
};
            // 지도 초기화
            var map = new naver.maps.Map('map', mapOptions);
            map.setMapTypeId('normal');
            var labelLayer = new naver.maps.LabelLayer();
            labelLayer.setMap(map);

            // 마우스 휠 이벤트 리스너 추가 (미세 조정)
            var ZOOM_STEP = 0.1;
            mapContainer.addEventListener("wheel", function (e) {
                e.preventDefault();     

                var currentZoom = map.getZoom();
                var newZoom = currentZoom;

                if (e.deltaY < 0) newZoom += ZOOM_STEP;   
         
 
                else newZoom -= ZOOM_STEP;                

                newZoom = Math.round(newZoom * 100) / 100;
                newZoom = Math.min(Math.max(newZoom, 1), 21);

                map.setZoom(newZoom);
            }, { passive: false });
            
            var groundOverlay = null; 
            var currentBuildingId = null; 
            var currentPositionMarker = null;
            
            // =========================================================
            // 빌딩별 데이터 정의 (층별 경계 분리 적용)
            // =========================================================
            var ky_default_bounds = new naver.maps.LatLngBounds(
                new naver.maps.LatLng(37.570512, 126.977632), // 기존 SW
                new naver.maps.LatLng(37.571415, 126.978244)  // 기존 NE
            );
            var dt_default_bounds = new naver.maps.LatLngBounds(
                new naver.maps.LatLng(37.570459, 126.978649), 
                new naver.maps.LatLng(37.571626, 126.979210)  
            );

            var buildings = {
                'ky': { // 건물 1 (예시: 교보빌딩)
                    polygonCoords: [
                        new naver.maps.LatLng(37.571350, 126.977670),
                        new naver.maps.LatLng(37.571360, 126.978059),
                        new naver.maps.LatLng(37.571275, 126.978063),
                        new naver.maps.LatLng(37.571275, 126.978173),
                        new naver.maps.LatLng(37.570870, 126.978184),
                        new naver.maps.LatLng(37.570872, 126.978082),
                        new naver.maps.LatLng(37.570543, 126.978094),
                        new naver.maps.LatLng(37.570539, 126.977702),
                    ],
                    floors: ['b1', '1f', '2f'],
                    images: {
                        'b1': 'https://raw.githubusercontent.com/candream99/disabledmap/main/kb/kb_b11.jpg',
                        '1f': 'https://raw.githubusercontent.com/candream99/disabledmap/main/kb/ky11.png', 
                        '2f': 'https://raw.githubusercontent.com/candream99/disabledmap/main/kb/ky_1.jpg',
                    },
                    // 층별 경계 정보를 객체로 분리하여 저장
                    floorBounds: { 
                        'b1': new naver.maps.LatLngBounds( // B1: 사용자가 요청한 새로운 경계
                            new naver.maps.LatLng(37.571590, 126.978531), // SW
                            new naver.maps.LatLng(37.570465, 126.977552)  // NE
                        ),
                        '1f': ky_default_bounds, // 1F: 기존 경계 사용
                        '2f': ky_default_bounds, // 2F: 기존 경계 사용
                    },
                    currentFloor: '1f', 
                    polygon: null,
                    accessInfo: {
                        '주출입구 경사로': true,
                        '장애인 화장실': false,
                        '징애인 주차장': true,
                        '엘리베이터': true,
                        '주출입구 단차': false 
                    },
                    // 건물 상세 정보
                    buildingInfo: {
                        name: '교보빌딩',
                        image_url: 'https://raw.githubusercontent.com/candream99/disabledmap/main/kb/kyobo_gwanghwamun.jpg', 
                        address: '서울특별시 종로구 종로 1',
                        operating_hours: '09:00 - 18:00 (월요일 휴무)'
                    }
                },
                'dt': { 
                    // 건물 2 (예시: 광화문 D타워)
                    polygonCoords: [
                        new naver.maps.LatLng(37.571470, 126.978762),
                        new naver.maps.LatLng(37.571476, 126.979161),
                        new naver.maps.LatLng(37.570627, 126.979181),
                        new naver.maps.LatLng(37.570557, 126.979117),
                        new naver.maps.LatLng(37.570553, 126.978777),
                    ],
                    floors: ['b4', '1f'], 
                    images: {
                        'b4': 'https://raw.githubusercontent.com/candream99/disabledmap/main/dt/dt_b4.png',
                        '1f': 'https://raw.githubusercontent.com/candream99/disabledmap/main/dt/dt1.png',
                    },
                    // 층별 경계 정보를 객체로 분리하여 저장
                    floorBounds: { 
                        'b4': dt_default_bounds, // B4: 기존 경계 사용
                        '1f': dt_default_bounds, // 1F: 기존 경계 사용
                    },
                    currentFloor: '1f',
                    polygon: null,
                    accessInfo: {
                        '주출입구 경사로': false,
                        '장애인 화장실': true, 
                        '장애인 주차장': false,
                        '엘리베이터': true,
                        '주출입구 단차': true 
                    },
                    // 건물 상세 정보
                    buildingInfo: {
                        name: '광화문 D타워',
                        image_url: 'https://raw.githubusercontent.com/candream99/disabledmap/main/dt/d_tower.jpg', 
                        address: '서울특별시 종로구 종로3길 17',
                        operating_hours: '10:00 - 21:00 (매일 운영)'
                    }
                },
                't8': { // 건물 3: 타워8
                    polygonCoords: [
                        new naver.maps.LatLng(37.570859, 126.980318),
                        new naver.maps.LatLng(37.570854, 126.980784),
                        new naver.maps.LatLng(37.570515, 126.980785),
                        new naver.maps.LatLng(37.570514, 126.980841),
                        new naver.maps.LatLng(37.570417, 126.980840),
                        new naver.maps.LatLng(37.570418, 126.980288),
                        new naver.maps.LatLng(37.570518, 126.980287),
                        new naver.maps.LatLng(37.570518, 126.980315),
                    ],
                    floors: ['b2', 'b1', '1f'], // 요청하신 층별 버튼 순서
                    images: {
                        'b2': 'https://raw.githubusercontent.com/candream99/disabledmap/main/T8/T8_b2.png',
                        'b1': 'https://raw.githubusercontent.com/candream99/disabledmap/main/T8/T8_b1.png',
                        '1f': 'https://raw.githubusercontent.com/candream99/disabledmap/main/T8/T8_1.png',
                    },
                    // 층별 경계 정보를 객체로 분리하여 저장
                    floorBounds: { 
                        // 요청하신 동일한 북동(NE) 및 남서(SW) 좌표를 모든 층에 적용
                        'b2': new naver.maps.LatLngBounds( 
                            new naver.maps.LatLng(37.570405, 126.980209), // SW
                            new naver.maps.LatLng(37.570902, 126.981077)  // NE
                        ),
                        'b1': new naver.maps.LatLngBounds( 
                            new naver.maps.LatLng(37.570405, 126.980209), // SW
                            new naver.maps.LatLng(37.570902, 126.981077)  // NE
                        ),
                        '1f': new naver.maps.LatLngBounds( 
                            new naver.maps.LatLng(37.570405, 126.980209), // SW
                            new naver.maps.LatLng(37.570902, 126.981077)  // NE
                        ),
                    },
                    currentFloor: '1f',
                    polygon: null,
                    // 임의의 무장애 시설 정보
                    accessInfo: {
                        '주출입구 경사로': false,
                        '장애인 화장실': true, 
                        '장애인 주차장': true,
                        '엘리베이터': true,
                        '주출입구 단차': false 
                    },
                    // 건물 상세 정보
                    buildingInfo: {
                        name: '타워8',
                        image_url: 'https://raw.githubusercontent.com/candream99/disabledmap/main/T8/t88.jpg', 
                        address: '서울특별시 종로구 종로5길 7',
                        operating_hours: '09:00 - 22:00 (주말 포함)'
                    }
                },
                'dp': { // 건물 (사용자 요청 추가): 덕수궁 디팰리스
                    polygonCoords: [
                        new naver.maps.LatLng(37.568747, 126.971657),
                        new naver.maps.LatLng(37.568764, 126.971716),
                        new naver.maps.LatLng(37.568785, 126.971707),
                        new naver.maps.LatLng(37.568924, 126.972264),
                        new naver.maps.LatLng(37.568905, 126.972278),
                        new naver.maps.LatLng(37.568918, 126.972331),
                        new naver.maps.LatLng(37.568654, 126.972437),
                        new naver.maps.LatLng(37.568638, 126.972382),
                        new naver.maps.LatLng(37.568619, 126.972390),
                        new naver.maps.LatLng(37.568479, 126.971828),
                        new naver.maps.LatLng(37.568501, 126.971818),
                        new naver.maps.LatLng(37.568483, 126.971760),
                    ],
                    floors: ['1f', 'b1', 'b3'], // 1F, B1, B3 버튼 생성
                    images: {
                        '1f': 'https://raw.githubusercontent.com/candream99/disabledmap/main/dp/dp_1.png',
                        'b1': 'https://raw.githubusercontent.com/candream99/disabledmap/main/dp/dp_2.png',
                        'b3': 'https://raw.githubusercontent.com/candream99/disabledmap/main/dp/dp_3.png',
                    },
                    // 층별 이미지 경계 정보
                    floorBounds: { 
                        '1f': new naver.maps.LatLngBounds( 
                            new naver.maps.LatLng(37.568384, 126.971603), // 1F SW
                            new naver.maps.LatLng(37.569001, 126.972464)  // 1F NE
                        ),
                        'b1': new naver.maps.LatLngBounds( 
                            new naver.maps.LatLng(37.568245, 126.971606), // B1 SW
                            new naver.maps.LatLng(37.569161, 126.972561)  // B1 NE
                        ),
                        'b3': new naver.maps.LatLngBounds( 
                            new naver.maps.LatLng(37.568245, 126.971606), // B3 SW
                            new naver.maps.LatLng(37.569161, 126.972561)  // B3 NE
                        ),
                    },
                    currentFloor: '1f',
                    polygon: null,
                    // 임의의 무장애 시설 정보
                    accessInfo: {
                        '주출입구 경사로': false,
                        '장애인 화장실': true,
                        '장애인 주차장': true,
                        '엘리베이터': true,
                        '주출입구 단차': false 
                    },
                    // 건물 상세 정보 (검색 리스트 및 팝업용)
                    buildingInfo: {
                        name: '덕수궁 디팰리스',
                        image_url: 'https://raw.githubusercontent.com/candream99/disabledmap/main/dp/dp.png', // 검색 및 팝업 이미지
                        address: '서울특별시 종로구 새문안로2길 10', // 임의 주소
                        operating_hours: '09:00 - 21:00 (매일 운영)' // 임의 운영시간
                    }
                },
                'officia': { // 건물 4: 광화문 오피시아
    polygonCoords: [
        new naver.maps.LatLng(37.569884, 126.974610), // 위도, 경도
        new naver.maps.LatLng(37.569882, 126.975265),
        new naver.maps.LatLng(37.569580, 126.975261),
        new naver.maps.LatLng(37.569581, 126.974603),
    ],
    floors: ['b2', 'b1', '1f'], // 요청하신 층: B2, B1, 1F
    images: {
        // 모든 층에 동일한 이미지 URL 적용
        'b2': 'https://raw.githubusercontent.com/candream99/disabledmap/main/officia/officia_b1.png',
        'b1': 'https://raw.githubusercontent.com/candream99/disabledmap/main/officia/officia_b1.png',
        '1f': 'https://raw.githubusercontent.com/candream99/disabledmap/main/officia/officia_1f.png',
    },
    // 층별 경계 정보 (요청하신 대로 층마다 분리하여 동일한 경계 적용)
    floorBounds: { 
        'b2': new naver.maps.LatLngBounds(
            new naver.maps.LatLng(37.569519, 126.974473), // SW (남서)
            new naver.maps.LatLng(37.569976, 126.975331)  // NE (북동)
        ),
        'b1': new naver.maps.LatLngBounds(
            new naver.maps.LatLng(37.569519, 126.974473), // SW
            new naver.maps.LatLng(37.569976, 126.975331)  // NE
        ),
        '1f': new naver.maps.LatLngBounds(
            new naver.maps.LatLng(37.569519, 126.974473), // SW
            new naver.maps.LatLng(37.569976, 126.975331)  // NE
        ),
    },
    currentFloor: '1f',
    polygon: null,
    // 임의의 무장애 시설 정보
    accessInfo: {
        '주출입구 경사로': false,
        '장애인 화장실': false, 
        '장애인 주차장': true,
        '엘리베이터': true,
        '주출입구 단차': false 
    },
    // 건물 상세 정보 (검색 리스트 및 팝업용)
    buildingInfo: {
        name: '광화문 오피시아',
        image_url: 'https://raw.githubusercontent.com/candream99/disabledmap/main/officia/officia_.jpg', // I버튼 팝업 및 검색 리스트 이미지
        address: '서울특별시 종로구 새문안로 92',
        operating_hours: '10:00 - 21:00 (주말 휴무, 임의)'
    }
},
                'st': { // 건물 5: S타워
    polygonCoords: [
        new naver.maps.LatLng(37.569910, 126.973684), // 위도, 경도
        new naver.maps.LatLng(37.569904, 126.974217),
        new naver.maps.LatLng(37.569688, 126.974214),
        new naver.maps.LatLng(37.569688, 126.973680),
    ],
    floors: ['b2', 'b1', '1f'], // 요청하신 층: B2, B1, 1F
    images: {
        // 모든 층에 동일한 이미지 URL 적용
        'b2': 'https://raw.githubusercontent.com/candream99/disabledmap/main/st/st_b1.png',
        'b1': 'https://raw.githubusercontent.com/candream99/disabledmap/main/st/st_b1.png',
        '1f': 'https://raw.githubusercontent.com/candream99/disabledmap/main/st/st_1.png',
    },
    // 층별 경계 정보 (요청하신 대로 층마다 분리하여 동일한 경계 적용)
    floorBounds: { 
        'b2': new naver.maps.LatLngBounds(
            new naver.maps.LatLng(37.569473, 126.973510), // SW (남서)
            new naver.maps.LatLng(37.569981, 126.974348)  // NE (북동)
        ),
        'b1': new naver.maps.LatLngBounds(
            new naver.maps.LatLng(37.569473, 126.973510), // SW
            new naver.maps.LatLng(37.569981, 126.974348)  // NE
        ),
        '1f': new naver.maps.LatLngBounds(
            new naver.maps.LatLng(37.569473, 126.973510), // SW
            new naver.maps.LatLng(37.569981, 126.974348)  // NE
        ),
    },
    currentFloor: '1f',
    polygon: null,
    // 임의의 무장애 시설 정보
    accessInfo: {
        '주출입구 경사로': true,
        '장애인 화장실': false, 
        '장애인 주차장': true,
        '엘리베이터': true,
        '주출입구 단차': false 
    },
    // 건물 상세 정보 (검색 리스트 및 팝업용)
    buildingInfo: {
        name: 'S타워',
        image_url: 'https://raw.githubusercontent.com/candream99/disabledmap/main/st/s_t.jpg', // I버튼 팝업 및 검색 리스트 이미지
        address: '서울특별시 종로구 새문안로 82',
        operating_hours: '평일 09:00 - 21:00 (임의)'
    }
},
                'yp': { // 건물 6: 영풍빌딩 (사용자 요청 추가)
                    polygonCoords: [
                        new naver.maps.LatLng(37.569881, 126.981938),
                        new naver.maps.LatLng(37.569879, 126.982329),
                        new naver.maps.LatLng(37.569829, 126.982332),
                        new naver.maps.LatLng(37.569828, 126.982395),
                        new naver.maps.LatLng(37.569780, 126.982395),
                        new naver.maps.LatLng(37.569777, 126.982463),
                        new naver.maps.LatLng(37.569463, 126.982461),
                        new naver.maps.LatLng(37.569462, 126.982068),
                        new naver.maps.LatLng(37.569565, 126.981938),
                    ],
                    floors: ['b1', '1f'], // 요청하신 층: B1, 1F
                    images: {
                        'b1': 'https://raw.githubusercontent.com/candream99/disabledmap/main/yp/yp1.png', // 모든 층 동일 이미지
                        '1f': 'https://raw.githubusercontent.com/candream99/disabledmap/main/yp/yp1.png',
                    },
                    // 층별 경계 정보 (요청하신 동일한 북동(NE) 및 남서(SW) 좌표를 모든 층에 적용)
                    floorBounds: { 
                        'b1': new naver.maps.LatLngBounds( 
                            new naver.maps.LatLng(37.569438, 126.981870), // SW: 위도: 37.569438, 경도: 126.981870
                            new naver.maps.LatLng(37.569943, 126.982556)  // NE: 위도: 37.569943, 경도: 126.982556
                        ),
                        '1f': new naver.maps.LatLngBounds( 
                            new naver.maps.LatLng(37.569438, 126.981870), // SW
                            new naver.maps.LatLng(37.569943, 126.982556)  // NE
                        ),
                    },
                    currentFloor: '1f',
                    polygon: null,
                    // 임의의 무장애 시설 정보
                    accessInfo: {
                        '주출입구 경사로': true,
                        '장애인 화장실': false, 
                        '장애인 주차장': true, // 임의
                        '엘리베이터': true,
                        '주출입구 단차': true 
                    },
                    // 건물 상세 정보 (검색 리스트 및 팝업용)
                    buildingInfo: { 
                        name: '영풍빌딩', 
                        image_url: 'https://raw.githubusercontent.com/candream99/disabledmap/main/yp/yp_i.jpg', // I버튼 팝업 및 검색 리스트 이미지
                        address: '서울 종로구 청계천로 41 (임의 주소)', 
                        operating_hours: '09:00 - 22:00 (임의)'
                    }
                },
                'sc': { // 건물 6: 제일은빌딩 (사용자 요청 추가)
                    polygonCoords: [
                        new naver.maps.LatLng(37.571274, 126.982109),
                        new naver.maps.LatLng(37.571257, 126.982778),
                        new naver.maps.LatLng(37.570935, 126.982765),
                        new naver.maps.LatLng(37.570934, 126.982725),
                        new naver.maps.LatLng(37.570863, 126.982721),
                        new naver.maps.LatLng(37.570672, 126.982456),
                        new naver.maps.LatLng(37.570674, 126.982384),
                        new naver.maps.LatLng(37.570612, 126.982302),
                        new naver.maps.LatLng(37.570616, 126.982153),
new naver.maps.LatLng(37.570712, 126.982050),
new naver.maps.LatLng(37.570974, 126.982058),
new naver.maps.LatLng(37.570969, 126.982094),
                    ],
                    floors: ['b1', '1f'], // 요청하신 층: B1, 1F
                    images: {
                        'b1': 'https://raw.githubusercontent.com/candream99/disabledmap/main/sc/sc_1.png', // 모든 층 동일 이미지
                        '1f': 'https://raw.githubusercontent.com/candream99/disabledmap/main/sc/sc_1.png',
                    },
                    // 층별 경계 정보 (요청하신 동일한 북동(NE) 및 남서(SW) 좌표를 모든 층에 적용)
                    floorBounds: { 
                        'b1': new naver.maps.LatLngBounds( 
                            new naver.maps.LatLng(37.570605, 126.981884), // SW: 위도: 37.569438, 경도: 126.981870
                            new naver.maps.LatLng(37.571639, 126.982899)  // NE: 위도: 37.569943, 경도: 126.982556
                        ),
                        '1f': new naver.maps.LatLngBounds( 
                            new naver.maps.LatLng(37.570605, 126.981884), // SW
                            new naver.maps.LatLng(37.571639, 126.982899)  // NE
                        ),
                    },
                    currentFloor: '1f',
                    polygon: null,
                    // 임의의 무장애 시설 정보
                    accessInfo: {
                        '주출입구 경사로': false,
                        '장애인 화장실': false, 
                        '장애인 주차장': true, // 임의
                        '엘리베이터': true,
                        '주출입구 단차': false 
                    },
                    // 건물 상세 정보 (검색 리스트 및 팝업용)
                    buildingInfo: { 
                        name: 'SC제일은행', 
                        image_url: 'https://raw.githubusercontent.com/candream99/disabledmap/main/sc/sc_i.jpg', // I버튼 팝업 및 검색 리스트 이미지
                        address: '서울특별시 종로구 종로 47', 
                        operating_hours: '09:00 - 16:00'
                    }
                },
                'ks': { // 한국무역보험공사 (K-SURE)
                    polygonCoords: [
                        // 외곽선 좌표 (시계방향: NE-SE-SW-NW와 유사)
                        new naver.maps.LatLng(37.569913, 126.978610), // 위도: 37.569913, 경도: 126.978610
                        new naver.maps.LatLng(37.569910, 126.979151), // 위도: 37.569910, 경도: 126.979151
                        new naver.maps.LatLng(37.569719, 126.979148), // 위도: 37.569719, 경도: 126.979148
                        new naver.maps.LatLng(37.569722, 126.978609)  // 위도: 37.569722, 경도: 126.978609
                    ],
                    floors: ['b2', 'b1', '1f'], 
                    images: {
                        'b2': 'https://raw.githubusercontent.com/candream99/disabledmap/main/ks/ks_b12.png',
                        'b1': 'https://raw.githubusercontent.com/candream99/disabledmap/main/ks/ks_b11.png',
                        '1f': 'https://raw.githubusercontent.com/candream99/disabledmap/main/ks/ks_1.png',
                    },
                    // 층별 이미지 경계 정보 (LatLngBounds: SW, NE 순서)
                    floorBounds: { 
                        // B2 이미지 경계 (B2, B1은 동일)
                        'b2': new naver.maps.LatLngBounds( 
                            new naver.maps.LatLng(37.569583, 126.978495), // SW: 위도: 37.569583, 경도: 126.978495
                            new naver.maps.LatLng(37.570013, 126.979220)  // NE: 위도: 37.570013, 경도: 126.979220
                        ),
                        // B1 이미지 경계
                        'b1': new naver.maps.LatLngBounds( 
                            new naver.maps.LatLng(37.569583, 126.978495), // SW
                            new naver.maps.LatLng(37.570013, 126.979220)  // NE
                        ),
                        // 1F 이미지 경계
                        '1f': new naver.maps.LatLngBounds( 
                            new naver.maps.LatLng(37.569618, 126.978522), // SW: 위도: 37.569618, 경도: 126.978522
                            new naver.maps.LatLng(37.570012, 126.979214)  // NE: 위도: 37.570012, 경도: 126.979214
                        ),
                    },
                    currentFloor: '1f',
                    polygon: null,
                    // 무장애 시설 정보 (요청에 따라 임의의 값 설정)
                    accessInfo: {
                        '주출입구 경사로': true,
                        '장애인 화장실': false, 
                        '장애인 주차장': true,
                        '엘리베이터': true,
                        '주출입구 단차': true 
                    },
                    // 건물 상세 정보 (검색 리스트 및 팝업용)
                    buildingInfo: {
                        name: '한국무역보험공사',
                        image_url: 'https://raw.githubusercontent.com/candream99/disabledmap/main/ks/ks.jpg', 
                        address: '서울특별시 종로구 종로 14',
                        operating_hours: '오전9시부터 오후 6시까지'
                    }
                }
            };

            // =========================================================
            // 모바일 터치 이벤트 버블링/스크롤 방지
            // =========================================================

            function preventTouchMove(elementId) {
                var element = document.getElementById(elementId);
 
                if (element) {
                    element.addEventListener('touchmove', function(e) {
                        e.preventDefault();
                    }, { passive: false });
                }
            }

            preventTouchMove('searchBox');
            preventTouchMove('floorControls');
                        
            // =========================================================
            // 핵심 로직 함수
            // =========================================================

            /**
             * 실내 모드 진입 시 UI 변경
             */
            function enterIndoorMode(buildingId) {
                // 검색 모드 종료
                exitSearchMode(); 
            
                searchBox.style.display = 'none';
                coordDisplay.style.top = '10px';
                
                var config = buildings[buildingId];
                if (config && config.polygonCoords && config.polygonCoords.length > 0) {
                    var bounds = new naver.maps.LatLngBounds();
                    config.polygonCoords.forEach(function(coord) { bounds.extend(coord); });
                    
                    var centerPoint = bounds.getCenter();
                    map.setCenter(centerPoint);
                    map.setZoom(18); 
                }
                
                currentBuildingId = buildingId;
                labelLayer.setMap(null);
                floorControlsContainer.style.display = 'flex';
                coordDisplay.textContent = '일반지도로 돌아가려면 실내지도를 클릭하세요';
            }

            /**
             * 실내 모드를 종료하고 일반 지도로 돌아갑니다.
             */
            function exitIndoorMode() {
                if (!currentBuildingId) return;
                if (groundOverlay) {
                    groundOverlay.setMap(null);
                }
                
                // 팝업창 닫기 및 'i' 버튼 active 해제
                popup.style.display = 'none';
                accessBtn.classList.remove('active');
                
                // 모든 건물 폴리곤 복원
                for (var id in buildings) {
                    if (buildings[id].polygon) {
                        buildings[id].polygon.setMap(map);
                        buildings[id].polygon.setOptions({ fillColor: 'transparent' }); 
                    }
                }
            
                floorControlsContainer.style.display = 'none';
                labelLayer.setMap(map);
                currentBuildingId = null; 
            
                // 일반 모드로 복귀 시 UI 변경
                searchBox.style.display = 'flex';
                coordDisplay.style.top = '78px';
                coordDisplay.textContent = '건물을 클릭하면 실내지도를 볼 수 있어요';
            }

            // 층 지도(GroundOverlay) 표시 (수정된 부분: floorBounds 사용)
            function showFloor(buildingId, floor) {
                var config = buildings[buildingId];
                // 💥 수정: config.floorBounds[floor]를 사용하여 층별 경계를 가져옵니다.
                var floorBound = config?.floorBounds[floor];
                
                if (!config || !config.images[floor] || !floorBound) {
                    console.error('해당 층의 이미지 또는 경계 정보가 없습니다:', buildingId, floor);
                    return;
                }

                currentBuildingId = buildingId;
                config.currentFloor = floor; 
                
                if (groundOverlay) groundOverlay.setMap(null);
                // 다른 건물 폴리곤 숨기기
                for (var id in buildings) {
                    if (id !== buildingId && buildings[id].polygon) {
                        buildings[id].polygon.setMap(null);
                    }
                }

                // 현재 위치 마커가 있다면 제거
                if (currentPositionMarker) {
                    currentPositionMarker.setMap(null);
                    geolocationBtn.classList.remove('active'); 
                }

                groundOverlay = new naver.maps.GroundOverlay(
                    config.images[floor],
                    floorBound, // 👈 층별 경계 사용
                    {
                        map: map,
                        clickable: true,
                        opacity: 1,
                    }
                );
                // 버튼 상태 업데이트: 층 버튼만 비활성화 후 선택된 버튼 활성화
                document.querySelectorAll('#floorControls .floor-btn:not(#accessInfoBtn)').forEach(function(btn) { btn.classList.remove('active'); });
                var floorBtn = document.querySelector('#floorControls .floor-btn[data-floor="' + floor + '"]');
                if (floorBtn) floorBtn.classList.add('active');

                // 실내 모드 종료 리스너 (GroundOverlay 클릭 시)
                naver.maps.Event.addListener(groundOverlay, 'click', function (e) {
                    e.stopOverlays = true;
                    exitIndoorMode(); 
                });
            }

            // 층 버튼 동적 생성 및 렌더링
            function renderFloorButtons(buildingId) {
                var config = buildings[buildingId];
                // 기존 층 버튼만 제거 (i 버튼 제외)
                document.querySelectorAll('#floorControls .floor-btn:not(#accessInfoBtn)').forEach(function(btn) { btn.remove(); });
                var defaultFloor = config.floors.includes('1f') ? '1f' : config.floors[0];
                config.currentFloor = defaultFloor;
                // 새로운 층 버튼 생성 및 추가
                config.floors.forEach(function(floor) {
                    var btn = document.createElement('button');
                    btn.className = 'floor-btn map-btn-circle'; 
                    btn.dataset.floor = floor;
                    btn.textContent = floor.toUpperCase();
                    
                    // 'i' 버튼 바로 위에 오도록 prepend
                    floorControlsContainer.prepend(btn);

                    if (floor === defaultFloor) {
                        btn.classList.add('active');
                    }

                    btn.addEventListener('click', function() {
                       showFloor(buildingId, floor);
                    });
                });
            }

            /**
             * 무장애 시설 정보 팝업 내용을 동적으로 업데이트합니다.
             */
            function updateAccessPopup(buildingId) {
                var config = buildings[buildingId];
                var accessInfo = config?.accessInfo;
                var buildingInfo = config?.buildingInfo;
                
                // 팝업 내용 전체 초기화 
                buildingInfoSection.innerHTML = '';
                accessFacilitySection.innerHTML = '';


                // 1. 건물 정보 섹션 렌더링
                if (buildingInfo) {
                    buildingInfoSection.innerHTML = `
                        <img id="buildingImage" src="${buildingInfo.image_url}" alt="${buildingInfo.name} 사진">
                        <div id="buildingTextInfo">
                            <div id="buildingName">${buildingInfo.name}</div>
                            <div class="info-item">
                                <i>🏠︎</i>
                                <span>${buildingInfo.address}</span>
                            </div>
                            <div class="info-item">
                                <i>◴</i>
                                <span>${buildingInfo.operating_hours}</span>
                            </div>
                        </div>
                    `;
                } else {
                    buildingInfoSection.innerHTML = '<div>건물 기본 정보가 없습니다.</div>';
                }

                
                // 2. 무장애 시설 정보 섹션 렌더링 
                if (!accessInfo) {
                    accessFacilitySection.innerHTML = '<div>건물에 대한 무장애 시설 정보가 없습니다.</div>';
                    return;
                }

                var html = '';
                html += '<div style="font-size:1.0rem; font-weight:700; margin-bottom:12px; color:#1e3a8a;">무장애 시설정보</div>';
                for (var facility in accessInfo) {
                    var isAvailable = accessInfo[facility];
                    var statusText, statusClass;

                    if (facility.includes('단차')) {
                        statusText = isAvailable ? '있음' : '없음';
                        statusClass = isAvailable ? 'status-negative' : 'status-positive'; 
                    } else {
                        statusText = isAvailable ? '있음' : '없음';
                        statusClass = isAvailable ? 'status-positive' : 'status-negative';
                    }

                    html += `
                        <div class="access-item">
                            <span>• ${facility}</span>
                            <span class="access-status ${statusClass}">${statusText}</span>
                        </div>
                    `;
                }
                accessFacilitySection.innerHTML = html;
            }
            
            // =========================================================
            // 건물 검색 리스트 및 이동 로직 
            // =========================================================
            
            /**
             * 건물 목록을 생성하여 searchListContainer에 렌더링하고 클릭 이벤트를 연결합니다.
             * @param {string} filterQuery - 필터링할 검색어
             */
            function renderBuildingList(filterQuery) { 
                var html = '';
                var isListEmpty = true;
                var normalizedQuery = filterQuery.trim().toLowerCase().replace(/\s/g, ''); 

                for (var id in buildings) {
                    var config = buildings[id];
                    var info = config.buildingInfo;
                    
                    var buildingName = info.name;
                    var buildingAddress = info.address;
                    var buildingHours = info.operating_hours;
                    
                    // 필터링 로직: 검색어와 이름이 일치하는지 확인
                    var normalizedName = buildingName.trim().toLowerCase().replace(/\s/g, '');
                    if (normalizedQuery && !normalizedName.includes(normalizedQuery)) {
                         continue; // 검색어가 있고 이름에 포함되지 않으면 건너뛰기
                    }
                    
                    html += `
                        <div class="search-result-item" data-building-id="${id}" data-building-name="${buildingName}">
                            <img class="result-image" src="${info.image_url}" alt="${buildingName}">
                            <div class="result-text-info">
                                <div class="result-name">${buildingName}</div>
                                <div class="result-info-item">
                                    <i>📍</i>
                                    <span>${buildingAddress}</span>
                                </div>
                                <div class="result-info-item">
                                    <i>🕒</i>
                                    <span>${buildingHours}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    isListEmpty = false;
                }

                if (isListEmpty) {
                    searchListContainer.innerHTML = '<div style="padding:10px; color:#555;">검색 결과가 없습니다.</div>';
                } else {
                    searchListContainer.innerHTML = html;
                }
                
                // 리스트 아이템에 클릭 이벤트 연결
                document.querySelectorAll('.search-result-item').forEach(function(item) {
                    item.addEventListener('click', function() {
                        var buildingId = this.getAttribute('data-building-id');
                        var buildingName = this.getAttribute('data-building-name');
                        searchAndGoToBuilding(buildingName, buildingId);
                    });
                });
            }

            /**
             * 건물 이름으로 지도를 해당 건물 중심으로 이동시키는 함수
             */
            function searchAndGoToBuilding(buildingName, directId) {
                var foundBuildingId = directId;
                
                if (!foundBuildingId) {
                    // 검색 버튼/Enter로 검색했을 경우 (기존 로직 유지)
                    var normalizedName = buildingName.trim().toLowerCase().replace(/\s/g, ''); 
                    for (var id in buildings) { 
                        var configName = buildings[id].buildingInfo.name.trim().toLowerCase().replace(/\s/g, '');
                        if (configName.includes(normalizedName) || normalizedName.includes(configName)) {
                            foundBuildingId = id;
                            break;
                        }
                    }
                }
                
                if (foundBuildingId) {
                    var config = buildings[foundBuildingId];
                    if (config.polygonCoords && config.polygonCoords.length > 0) {
                        var bounds = new naver.maps.LatLngBounds();
                        config.polygonCoords.forEach(function(coord) { bounds.extend(coord); });
                        
                        map.setCenter(bounds.getCenter());
                        map.setZoom(17); 
                        
                        coordDisplay.textContent = `[검색 성공] '${buildingName}'로 이동했습니다.`;
                        exitSearchMode();
                    }
                } else {
                    coordDisplay.textContent = `[검색 실패] '${buildingName}'에 해당하는 건물을 찾을 수 없습니다. (예: 교보빌딩, D타워)`;
                }
            }

            /**
             * 검색 모드 UI로 전환 (입력 필드 활성화 및 목록 표시)
             */
            function enterSearchMode() {
                if (currentBuildingId) {
                    coordDisplay.textContent = '실내 모드에서는 검색할 수 없습니다. 일반 지도로 돌아가세요.';
                    return;
                }
                searchPlaceholder.style.display = 'none';
                searchInput.style.display = 'block';
                searchBtn.style.display = 'flex';
                closeSearchBtn.style.display = 'flex';
                coordDisplay.textContent = '아래 목록에서 건물을 선택하거나 이름을 검색하세요.'; 
                searchInput.focus(); 
                
                // 건물 목록 렌더링 및 표시 (빈 쿼리로 전체 목록 표시)
                renderBuildingList('');
                searchListContainer.style.display = 'block';
            }

            /**
             * 검색 모드 UI를 종료하고 초기 상태로 복원
             */
            function exitSearchMode() {
                searchInput.value = ''; 
                searchInput.style.display = 'none';
                searchBtn.style.display = 'none';
                closeSearchBtn.style.display = 'none';
                searchPlaceholder.style.display = 'block';
                
                // 건물 목록 숨기기 및 초기화
                searchListContainer.style.display = 'none';
                searchListContainer.innerHTML = '';
                
                coordDisplay.textContent = '건물을 클릭하면 실내지도를 볼 수 있어요';
            }
            
            // =========================================================
            // 건물 Polygon 생성 및 리스너 설정 
            // =========================================================

            function setupBuilding(buildingId, config) {
                var polygon = new naver.maps.Polygon({
                    map: map,
                    paths: [config.polygonCoords],
                    fillColor: 'transparent',
                    fillOpacity: 0.5,
                    strokeColor: '#C490E4',
                    strokeOpacity: 1,
                    strokeWeight: 2,
                    clickable: true,
                });
                config.polygon = polygon; 

                // 마우스 오버 리스너 
                naver.maps.Event.addListener(polygon, 'mouseover', function() {
                    if (!groundOverlay || groundOverlay.getMap() === null) {
                        polygon.setOptions({ fillColor: '#C490E4' });
                        coordDisplay.textContent = '클릭해서 실내지도를 보세요';
                    }
                });
                // 마우스 아웃 리스너 
                naver.maps.Event.addListener(polygon, 'mouseout', function() {
                    if (!groundOverlay || groundOverlay.getMap() === null) {
                        polygon.setOptions({ fillColor: 'transparent' });
                        coordDisplay.textContent = '건물을 클릭하면 실내지도를 볼 수 있어요';
                    }
                });
                // 클릭 리스너 (실내 모드 진입)
                naver.maps.Event.addListener(polygon, 'click', function (e) {
                    e.stopOverlays = true;
                    
                    enterIndoorMode(buildingId);

                    polygon.setMap(null);
                    
                    if (currentPositionMarker) {
                        currentPositionMarker.setMap(null);
                        geolocationBtn.classList.remove('active'); 
                    }

                    renderFloorButtons(buildingId);
                    
                    var defaultFloor = config.floors.includes('1f') ? '1f' : config.floors[0];
                    showFloor(buildingId, defaultFloor);
                    
                    updateAccessPopup(buildingId); 
                });
            }

            // =========================================================
            // 현재 위치 (Geolocation) 기능 
            // =========================================================
            geolocationBtn.addEventListener('click', function() {
                var isIndoorMode = currentBuildingId !== null; 

                // 1. 이미 활성화 상태라면 (파란색 버튼) 
                if (geolocationBtn.classList.contains('active')) {
                    if (currentPositionMarker) {
                        currentPositionMarker.setMap(null);
                    }
                    geolocationBtn.classList.remove('active');
                    
                    if (isIndoorMode) {
                        coordDisplay.textContent = '일반지도로 돌아가려면 실내지도를 클릭하세요';
                    } else {
                        coordDisplay.textContent = '건물을 클릭하면 실내지도를 볼 수 있어요';
                    }
                    return;
                }

                
                // 2. Geolocation 시작
                if (navigator.geolocation) {
                    coordDisplay.textContent = '현재 위치를 찾는 중입니다...';
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            var lat = position.coords.latitude;
                            var lng = position.coords.longitude;
                            var currentLatLng = new naver.maps.LatLng(lat, lng);

                            map.setCenter(currentLatLng);
                            map.setZoom(17); 

                            // 기존 마커 제거
                            if (currentPositionMarker) {
                                currentPositionMarker.setMap(null);
                            }

                            // 새로운 현재 위치 마커 생성 (파란색 도트)
                            currentPositionMarker 
                            = new naver.maps.Marker({
                                map: map,
                                position: currentLatLng,
                                icon: {
                                    content: 
                                        '<div style="width:12px; height:12px; background-color:#007bff; border-radius:50%; border:2px solid #ffffff; box-shadow:0 0 5px rgba(0,0,0,0.5);"></div>',
                                    size: new naver.maps.Size(12, 12),
                                    anchor: new naver.maps.Point(6, 6)
                               },
                                zIndex: 9999
                            });
                            
                            // 문구 업데이트
                            if (isIndoorMode) {
                                coordDisplay.textContent = '현재 위치로 이동했습니다. 실내지도는 그대로 표시됩니다.';
                            } else {
                                coordDisplay.textContent = '현재 위치로 이동했습니다! 건물을 클릭하면 실내지도를 볼 수 있어요';
                            }
                            geolocationBtn.classList.add('active'); 

                        },
                        function(error) {
                            console.error("Geolocation Error:", error);
                            
                            var errorMsg = '위치 정보를 찾을 수 없거나 접근이 거부되었습니다.';
                            if (error.code === 1) {
                                errorMsg = '위치 정보 접근 권한이 거부되었습니다.';
                            } else if (error.code === 2) {
                                errorMsg = '위치 정보를 찾을 수 없습니다.';
                            }
                            
                            if (isIndoorMode) {
                                coordDisplay.textContent = `[에러] ${errorMsg}. 일반지도로 돌아가려면 클릭하세요`;
                            } else {
                                coordDisplay.textContent = `[에러] ${errorMsg}. 건물을 클릭하면 실내지도를 볼 수 있어요`;
                            }
                            
                            if (currentPositionMarker) {
                                currentPositionMarker.setMap(null);
                            }
                            geolocationBtn.classList.remove('active');
                        },
                        { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 } 
                    );
                } else {
                    coordDisplay.textContent = 'Geolocation 미지원: 건물을 클릭하면 실내지도를 볼 수 있어요';
                }
            });
            
            // =========================================================
            // 초기화 및 이벤트 리스너 설정 
            // =========================================================

            // 모든 건물 설정
            for (var id in buildings) {
                setupBuilding(id, buildings[id]);
            }

            // 지도 클릭 리스너 (기본 문구 유지 및 검색 모드 종료)
            naver.maps.Event.addListener(map, 'click', function (e) {
                if (!groundOverlay || groundOverlay.getMap() === null) {
                     // 검색 모드일 경우 검색 모드를 종료
                    if (searchInput.style.display === 'block') {
                        exitSearchMode();
                    }
                    coordDisplay.textContent = '건물을 클릭하면 실내지도를 볼 수 있어요';
                }
            });
            
            // 검색 플레이스홀더 클릭 리스너 (검색 모드 진입)
            searchPlaceholder.addEventListener('click', enterSearchMode);
            
            // 검색 입력 필드에서 입력이 발생할 때마다 리스트를 필터링
            searchInput.addEventListener('input', function() {
                renderBuildingList(searchInput.value);
            });
            
            // 검색 버튼 클릭 리스너 (검색 후 지도로 이동)
            searchBtn.addEventListener('click', function() {
                var query = searchInput.value;
                if (query.trim() !== '') {
                    searchAndGoToBuilding(query);
                } else {
                    coordDisplay.textContent = '검색어를 입력해주세요.';
                }
            });

            // 검색 입력 필드에서 Enter 키 입력 리스너 (검색 후 지도로 이동)
            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    var query = searchInput.value;
                    if (query.trim() !== '') {
                        searchAndGoToBuilding(query);
                    } else {
                        coordDisplay.textContent = '검색어를 입력해주세요.';
                    }
                }
            });

            // 검색 취소 버튼 클릭 리스너
            closeSearchBtn.addEventListener('click', exitSearchMode);

            // 무장애시설 버튼 ('i' 버튼) 클릭 리스너 
            accessBtn.addEventListener('click', function() {
                if (!currentBuildingId) {
                    coordDisplay.textContent = '무장애 시설 정보는 건물을 클릭하여 실내 모드 진입 후 확인할 수 있어요.';
                    return;
                }

                var isOpen = popup.style.display === 'block';
                
                if (!isOpen) {
                    var buttonRect = accessBtn.getBoundingClientRect();
                    var newPopupLeft = buttonRect.right + 5;

                    popup.style.bottom = '20px';
                    popup.style.left = newPopupLeft + 'px'; 
                    
                    popup.style.display = 'block';
                    this.classList.add('active');
                } else {
                    // 팝업 닫기
                    popup.style.display = 'none';
                    this.classList.remove('active');
                }
            });
            
            // 무장애 시설정보 팝업 닫기 이벤트 (X 버튼 클릭)
            if (popupClose) {
                popupClose.onclick = function() {
                    popup.style.display = 'none';
                    accessBtn.classList.remove('active');
                };
            }
        };
        // API 로드 실패 시 에러 메시지
        script.onerror = function () {
            console.error('네이버 지도 API 로드 실패! URL 또는 Key를 확인하세요.');
        };

        document.head.appendChild(script);
       /* ------------------------------------------------ */
    /* [추가] 우측 하단 버튼 이벤트 처리 */
    /* ------------------------------------------------ */

    // 1. 지하철 버튼 클릭 시 -> 새 창으로 서울교통공사 연결
    document.getElementById('subwayBtn').addEventListener('click', function() {
        window.open('http://www.seoulmetro.co.kr/kr/cyberStation.do', '_blank');
    });

    // 2. 소개 버튼 클릭 시 -> 팝업 열기
    document.getElementById('introBtn').addEventListener('click', function() {
        document.getElementById('mobileIntroOverlay').style.display = 'flex';
    });

    // 3. 팝업 배경 클릭 시 -> 팝업 닫기 (선택사항: 편의성 위해 추가)
    document.getElementById('mobileIntroOverlay').addEventListener('click', function(e) {
        if (e.target === this) {
            this.style.display = 'none';
        }
    }); 
    </script>
</body>
</html>
































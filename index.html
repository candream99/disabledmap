<!DOCTYPE html>
<html>
<head>
    <title>네이버 지도 기반 광화문 교보빌딩 실내 지도</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <meta charset="utf-8">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Malgun Gothic', '맑은 고딕', sans-serif;
        }
        #map {
            height: 100%;
        }
        
        #floor-picker {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 999; 
            background-color: white;
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            display: none;
        }
        .floor-button {
            display: block;
            padding: 10px 15px;
            margin: 5px 0;
            cursor: pointer;
            border: none;
            background-color: #f7f7f7;
            color: #333;
            border-radius: 6px;
            text-align: center;
            font-size: 15px;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s;
            user-select: none;
        }
        .floor-button:hover {
            background-color: #e0e0e0;
        }
        .floor-button.active {
            background-color: #4A90E2;
            color: white;
        }
        
        #coord-guide {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background-color: #f44336;
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            cursor: pointer;
        }

        .naver-control, .nmap_logo, .nmap_copyright {
            display: none !important;
        }
        
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="floor-picker"></div>
    
    <div id="coord-guide" title="클릭하면 좌표 추출 모드가 종료됩니다.">
        <i class="fas fa-crosshairs"></i> 좌표 추출 모드 활성화됨. 지도 클릭 시 좌표 표시.
    </div>

    <script type="text/javascript" 
        src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=q1d23mmkof">
    </script>

    <script>
        const COORDS = {
            NW: { lat: 37.571346, lng: 126.977674 },
            NE: { lat: 37.571349, lng: 126.978057 },
            SE: { lat: 37.570542, lng: 126.978087 },
            SW: { lat: 37.570541, lng: 126.977699 }
        };

        const centerLat = (COORDS.NW.lat + COORDS.SE.lat) / 2;
        const centerLng = (COORDS.NW.lng + COORDS.SE.lng) / 2;

        const BUILDING_CONFIGS = {
            'kyobo': {
                center: new naver.maps.LatLng(centerLat, centerLng),
                bounds: new naver.maps.LatLngBounds(
                    new naver.maps.LatLng(COORDS.NW.lat, COORDS.NW.lng),
                    new naver.maps.LatLng(COORDS.SE.lat, COORDS.SE.lng)
                ),
                polygonPaths: [
                    [
                        new naver.maps.LatLng(COORDS.NW.lat, COORDS.NW.lng),
                        new naver.maps.LatLng(COORDS.NE.lat, COORDS.NE.lng),
                        new naver.maps.LatLng(COORDS.SE.lat, COORDS.SE.lng),
                        new naver.maps.LatLng(COORDS.SW.lat, COORDS.SW.lng)
                    ]
                ],
                floors: {
                    'B1': {
                        label: '지하 1층',
                        imageUrl: 'https://placehold.co/1000x800/2962FF/FFFFFF?text=KYOBODB+B1',
                        imageBounds: new naver.maps.LatLngBounds(
                            new naver.maps.LatLng(COORDS.NW.lat, COORDS.NW.lng),
                            new naver.maps.LatLng(COORDS.SE.lat, COORDS.SE.lng)
                        ),
                    },
                    '1F': {
                        label: '1층',
                        imageUrl: 'https://placehold.co/1000x800/1DE9B6/333333?text=KYOBODB+1F',
                        imageBounds: new naver.maps.LatLngBounds(
                            new naver.maps.LatLng(COORDS.NW.lat, COORDS.NW.lng),
                            new naver.maps.LatLng(COORDS.SE.lat, COORDS.SE.lng)
                        ),
                    },
                    '2F': {
                        label: '2층',
                        imageUrl: 'https://placehold.co/1000x800/FFEA00/333333?text=KYOBODB+2F',
                        imageBounds: new naver.maps.LatLngBounds(
                            new naver.maps.LatLng(COORDS.NW.lat, COORDS.NW.lng),
                            new naver.maps.LatLng(COORDS.SE.lat, COORDS.SE.lng)
                        ),
                    }
                }
            }
        };

        let mapInstance = null;
        let labelLayer = null;
        let isIndoorModeActive = false;
        let activeBuildingId = null;
        let currentFloorId = null;
        let clickListener = null;

        const buildingPolygons = {};
        const floorOverlays = {};

        function setFloorOverlay(floorId) {
            const key = `${activeBuildingId}_${floorId}`;
            if (currentFloorId) {
                const oldKey = `${activeBuildingId}_${currentFloorId}`;
                const oldOverlay = floorOverlays[oldKey];
                if (oldOverlay) oldOverlay.setMap(null);
            }
            const newOverlay = floorOverlays[key];
            if (newOverlay) {
                newOverlay.setMap(mapInstance);
                currentFloorId = floorId;
                updateFloorButtonState(floorId);
            }
        }

        function showIndoorControls(map, buildingId) {
            disableCoordExtraction();

            isIndoorModeActive = true;
            activeBuildingId = buildingId;

            hideAllPolygons(map, buildingId);

            const config = BUILDING_CONFIGS[buildingId];

            map.setZoom(20);
            map.setCenter(config.center);

            map.setMapTypeId('vector');   // ★ 실내모드: 벡터지도 전환
            labelLayer.setMap(null);      // ★ 라벨 제거

            const floorPicker = document.getElementById('floor-picker');
            floorPicker.innerHTML = '';

            const floorKeys = Object.keys(config.floors).reverse();
            floorKeys.forEach(floorId => {
                const button = document.createElement('div');
                button.className = 'floor-button';
                button.textContent = config.floors[floorId].label;
                button.dataset.floorId = floorId;

                button.addEventListener('click', () => setFloorOverlay(floorId));
                floorPicker.appendChild(button);
            });

            floorPicker.style.display = 'block';
            setFloorOverlay(floorKeys[0]);
        }

        function hideIndoorControls(map) {
            isIndoorModeActive = false;

            if (currentFloorId) {
                const key = `${activeBuildingId}_${currentFloorId}`;
                floorOverlays[key].setMap(null);
            }

            currentFloorId = null;
            activeBuildingId = null;

            document.getElementById('floor-picker').style.display = 'none';

            map.setZoom(19);
            map.setMapTypeId('normal');   // ★ 실외: 라스터 지도 복귀
            labelLayer.setMap(map);       // ★ 라벨 복귀

            showAllPolygons(map);
            enableCoordExtraction();
        }

        function updateFloorButtonState(activeFloorId) {
            document.querySelectorAll('.floor-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.floorId === activeFloorId);
            });
        }

        function hideAllPolygons(map, exceptId) {
            Object.keys(buildingPolygons).forEach(id => {
                if (id !== exceptId) {
                    buildingPolygons[id].setMap(null);
                } else {
                    buildingPolygons[id].setOptions({
                        fillColor: '#4A90E2',
                        fillOpacity: 0.2,
                        strokeColor: '#4A90E2',
                        strokeWeight: 4
                    });
                }
            });
        }

        function showAllPolygons(map) {
            Object.keys(buildingPolygons).forEach(id => {
                buildingPolygons[id].setMap(map);
                buildingPolygons[id].setOptions({
                    fillColor: '#FFC107',
                    fillOpacity: 0.15,
                    strokeColor: '#FFC107',
                    strokeWeight: 2
                });
            });
        }

        function enableCoordExtraction() {
            if (!mapInstance) return;

            document.getElementById('coord-guide').style.display = 'block';

            if (clickListener) naver.maps.Event.removeListener(clickListener);

            clickListener = naver.maps.Event.addListener(mapInstance, 'click', function(e) {
                const lat = e.coord.y.toFixed(6);
                const lng = e.coord.x.toFixed(6);
                showCustomMessage(`위도: ${lat}\n경도: ${lng}`);
                console.log(lat, lng);
            });
        }

        function disableCoordExtraction() {
            if (clickListener) {
                naver.maps.Event.removeListener(clickListener);
                clickListener = null;
            }
            document.getElementById('coord-guide').style.display = 'none';
        }

        function showCustomMessage(msg) {
            const existing = document.getElementById('custom-modal');
            if (existing) existing.remove();

            const modal = document.createElement('div');
            modal.id = 'custom-modal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0;
                width: 100%; height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex; justify-content: center; align-items: center;
                z-index: 2000;
            `;
            const box = document.createElement('div');
            box.style.cssText = `
                background: white; padding: 25px; border-radius: 10px;
                width: 350px; max-width: 90%;
            `;
            box.innerHTML = `
                <h3 style="margin: 0; color:#4A90E2;">좌표 획득</h3>
                <pre>${msg}</pre>
                <button id="modal-close" style="
                    padding: 8px 20px; margin-top: 10px;
                    background: #4A90E2; color:white; border:none; border-radius:5px;
                ">확인</button>
            `;
            modal.appendChild(box);
            document.body.appendChild(modal);
            document.getElementById('modal-close').onclick = () => modal.remove();
        }

        function initMap() {
            mapInstance = new naver.maps.Map('map', {
                center: BUILDING_CONFIGS['kyobo'].center,
                zoom: 19,
                mapTypeControl: false,

                mapTypes: new naver.maps.MapTypeRegistry({
                    'normal': naver.maps.NaverStyleMapTypeOptions.getRasterMap(),
                    'vector': naver.maps.NaverStyleMapTypeOptions.getVectorMap()
                }),
                mapTypeId: 'normal'
            });

            labelLayer = new naver.maps.LabelLayer();
            labelLayer.setMap(mapInstance);

            enableCoordExtraction();
            document.getElementById('coord-guide').addEventListener('click', disableCoordExtraction);

            Object.keys(BUILDING_CONFIGS).forEach(id => {
                const config = BUILDING_CONFIGS[id];

                const polygon = new naver.maps.Polygon({
                    map: mapInstance,
                    paths: config.polygonPaths,
                    fillColor: '#FFC107',
                    fillOpacity: 0.15,
                    strokeColor: '#FFC107',
                    strokeWeight: 2,
                    clickable: true
                });

                polygon.buildingId = id;
                buildingPolygons[id] = polygon;

                naver.maps.Event.addListener(polygon, 'click', (e) => {
                    if (!isIndoorModeActive) {
                        showIndoorControls(mapInstance, id);
                    } else if (activeBuildingId === id) {
                        hideIndoorControls(mapInstance);
                    }
                });

                Object.keys(config.floors).forEach(floorId => {
                    const floor = config.floors[floorId];
                    const overlay = new naver.maps.GroundOverlay(
                        floor.imageUrl,
                        floor.imageBounds,
                        { opacity: 0.8 }
                    );
                    overlay.setMap(null);
                    floorOverlays[`${id}_${floorId}`] = overlay;
                });
            });

            mapInstance.setCenter(BUILDING_CONFIGS['kyobo'].center);
        }

        naver.maps.onJSContentLoaded = initMap;
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>ë„¤ì´ë²„ ë²¡í„°ë§µ í…ŒìŠ¤íŠ¸ - ë‹¤ì¤‘ ê±´ë¬¼ ì§€ì›</title>
    <style>
        body { margin: 0; padding: 0; height: 100vh; font-family: 'Malgun Gothic', sans-serif; }
        #map { width: 100%; height: 100%; }

        #status {
            position: absolute;
            top: 10px; left: 10px;
            background: rgba(255, 99, 71, 0.9);
            color: white; padding: 10px 15px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        #coordDisplay {
            position: absolute;
            top: 10px; left: 10px;
            background: rgba(0, 0, 0, 0.75);
            color: #FFC107;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            z-index: 1500;
            min-width: 200px;
        }

        /* -------------------------
           ê³µí†µ ì›í˜• ë²„íŠ¼ ìŠ¤íƒ€ì¼
        ------------------------- */
        .map-btn-circle {
            width: 45px; height: 45px;
            padding: 0; cursor: pointer;
            background: white;
            border: none; border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            font-size: 14px; display: flex;
            justify-content: center; align-items: center;
        }

        /* -------------------------
           í˜„ì¬ ìœ„ì¹˜ ë²„íŠ¼
        ------------------------- */
        #geolocationBtn {
            position: absolute;
            bottom: 20px; left: 10px;
            z-index: 1500;
            font-size: 0;
        }

        #geolocationBtn .geo-icon {
            width: 18px; height: 18px;
            border: 2px solid #333;
            border-radius: 50%;
            position: relative;
        }

        #geolocationBtn .geo-icon::after {
            content: '';
            width: 4px; height: 4px;
            background: #333;
            border-radius: 50%;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
        }

        #geolocationBtn.active .geo-icon {
            border: none;
            background: transparent;
            width: 0; height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 12px solid #ffffff;
        }

        #geolocationBtn.active .geo-icon::after { content: none; }

        /* -------------------------
           ì¸µ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ
        ------------------------- */
        #floorControls {
            position: absolute;
            bottom: 95px; left: 10px;
            display: none;
            flex-direction: column-reverse;
            gap: 10px;
            z-index: 1500;
        }

        .floor-btn { font-size: 14px; }

        .map-btn-circle.active {
            background: #007bff;
            color: white;
        }

        /* i ë²„íŠ¼ */
        #accessInfoBtn { margin-bottom: 20px; }

        #accessInfoBtn .i-icon {
            width: 25px; height: 25px;
            display: block;
            background-size: contain;
            background-image: url('https://raw.githubusercontent.com/candream99/disabledmap/main/i_button.png');
        }

        #accessInfoBtn.active .i-icon {
            background-image: url('https://raw.githubusercontent.com/candream99/disabledmap/main/i_button2.png');
        }

        /* -------------------------
           ë¬´ì¥ì•  ì •ë³´ íŒì—…
        ------------------------- */
        #accessPopup {
            position: absolute;
            bottom: 180px;
            left: 10px;
            width: 260px;
            background: white;
            padding: 12px;
            border-radius: 8px;
            display: none;
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
            z-index: 2000;
        }

        /* -------------------------
           ğŸ”¥ ëª¨ë°”ì¼ ë²„íŠ¼ í•˜ë‹¨ ê³ ì •
        ------------------------- */
        @media (max-width: 768px) {
            #geolocationBtn {
                bottom: calc(env(safe-area-inset-bottom, 10px) + 10px);
                left: calc(env(safe-area-inset-left, 10px) + 5px);
            }

            #floorControls {
                bottom: calc(env(safe-area-inset-bottom, 10px) + 95px);
                left: calc(env(safe-area-inset-left, 10px) + 5px);
            }

            #accessInfoBtn { margin-bottom: 20px; }
        }
    </style>
</head>
<body>

    <div id="status">API í‚¤ í™•ì¸ ì¤‘...</div>
    <div id="coordDisplay">ê±´ë¬¼ì„ í´ë¦­í•˜ë©´ ì‹¤ë‚´ì§€ë„ë¥¼ ë³¼ ìˆ˜ ìˆì–´ìš”</div>

    <button id="geolocationBtn" class="map-btn-circle"><span class="geo-icon"></span></button>

    <div id="floorControls">
        <button id="accessInfoBtn" class="floor-btn map-btn-circle" data-floor="access">
            <span class="i-icon"></span>
        </button>
    </div>

    <div id="accessPopup">
        <span id="accessPopupClose" style="position:absolute; top:8px; right:12px; font-size:22px;cursor:pointer;">Ã—</span>
        <div style="font-size:1.2rem; font-weight:700; margin-bottom:15px;">ë¬´ì¥ì•  ì‹œì„¤ ì •ë³´</div>
        <div style="display:flex; margin-bottom:8px;"><span>â€¢ ì£¼ì¶œì…êµ¬ ê²½ì‚¬ë¡œ</span><span style="margin-left:auto;color:#10b981;">ìˆìŒ</span></div>
        <div style="display:flex; margin-bottom:8px;"><span>â€¢ ì¥ì• ì¸ í™”ì¥ì‹¤</span><span style="margin-left:auto;color:#10b981;">ìˆìŒ</span></div>
        <div style="display:flex; margin-bottom:8px;"><span>â€¢ ì ìë¸”ë¡</span><span style="margin-left:auto;color:#10b981;">ìˆìŒ</span></div>
        <div style="display:flex; margin-bottom:8px;"><span>â€¢ ì—˜ë¦¬ë² ì´í„°</span><span style="margin-left:auto;color:#10b981;">ìˆìŒ</span></div>
        <div style="display:flex; margin-bottom:8px;"><span>â€¢ ì£¼ì¶œì…êµ¬ ë‹¨ì°¨</span><span style="margin-left:auto;color:#ef4444;">ìˆìŒ</span></div>
    </div>

    <div id="map"></div>

    <script>
        const script = document.createElement('script');
        script.src =
          "https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=q1d23mmkof&vmode=3";

        script.onload = function () {

            const coordDisplay = document.getElementById("coordDisplay");
            const floorControlsContainer = document.getElementById("floorControls");
            const popup = document.getElementById("accessPopup");
            const accessBtn = document.getElementById("accessInfoBtn");
            const popupClose = document.getElementById("accessPopupClose");
            const geolocationBtn = document.getElementById("geolocationBtn");

            const map = new naver.maps.Map("map", {
                center: new naver.maps.LatLng(37.5710, 126.9784),
                zoom: 17,
                zoomControl: false,
                mapTypes: new naver.maps.MapTypeRegistry({
                    normal: naver.maps.NaverStyleMapTypeOptions.getVectorMap(),
                }),
            });

            document.getElementById("status").style.display = "none";

            let groundOverlay = null;
            let currentBuildingId = null;
            let currentPositionMarker = null;

            const buildings = {
                ky: {
                    polygonCoords: [
                        new naver.maps.LatLng(37.571350, 126.977670),
                        new naver.maps.LatLng(37.571360, 126.978059),
                        new naver.maps.LatLng(37.571275, 126.978063),
                        new naver.maps.LatLng(37.571275, 126.978173),
                        new naver.maps.LatLng(37.570870, 126.978184),
                        new naver.maps.LatLng(37.570872, 126.978082),
                        new naver.maps.LatLng(37.570543, 126.978094),
                        new naver.maps.LatLng(37.570539, 126.977702),
                    ],
                    floors: ["b1", "1f", "2f"],
                    images: {
                        b1: "https://raw.githubusercontent.com/candream99/disabledmap/main/kb/ky_1.jpg",
                        1f: "https://raw.githubusercontent.com/candream99/disabledmap/main/kb/ky1.jpg",
                        2f: "https://raw.githubusercontent.com/candream99/disabledmap/main/kb/ky_1.jpg",
                    },
                    imageBounds: new naver.maps.LatLngBounds(
                        new naver.maps.LatLng(37.570512, 126.977632),
                        new naver.maps.LatLng(37.571415, 126.978244)
                    ),
                },

                dt: {
                    polygonCoords: [
                        new naver.maps.LatLng(37.571470, 126.978762),
                        new naver.maps.LatLng(37.571476, 126.979161),
                        new naver.maps.LatLng(37.570627, 126.979181),
                        new naver.maps.LatLng(37.570557, 126.979117),
                        new naver.maps.LatLng(37.570553, 126.978777),
                    ],
                    floors: ["b4", "1f"],
                    images: {
                        b4: "https://raw.githubusercontent.com/candream99/disabledmap/main/dt/dt_b4.png",
                        1f: "https://raw.githubusercontent.com/candream99/disabledmap/main/dt/dt1.png",
                    },
                    imageBounds: new naver.maps.LatLngBounds(
                        new naver.maps.LatLng(37.570459, 126.978649),
                        new naver.maps.LatLng(37.571626, 126.979210)
                    ),
                },
            };

            function exitIndoorMode() {
                if (!currentBuildingId) return;
                if (groundOverlay) groundOverlay.setMap(null);

                popup.style.display = "none";
                accessBtn.classList.remove("active");

                for (const id in buildings) {
                    const poly = buildings[id].polygon;
                    if (poly) {
                        poly.setMap(map);
                        poly.setOptions({ fillColor: "transparent" });
                    }
                }

                floorControlsContainer.style.display = "none";
                currentBuildingId = null;

                coordDisplay.textContent = "ê±´ë¬¼ì„ í´ë¦­í•˜ë©´ ì‹¤ë‚´ì§€ë„ë¥¼ ë³¼ ìˆ˜ ìˆì–´ìš”";
            }

            function showFloor(buildingId, floor) {
                const config = buildings[buildingId];
                if (!config || !config.images[floor]) return;

                currentBuildingId = buildingId;

                if (groundOverlay) groundOverlay.setMap(null);

                groundOverlay = new naver.maps.GroundOverlay(
                    config.images[floor],
                    config.imageBounds,
                    { map, clickable: true, opacity: 1 }
                );

                document
                    .querySelectorAll('#floorControls .floor-btn:not(#accessInfoBtn)')
                    .forEach((b) => b.classList.remove("active"));

                const btn = document.querySelector(
                    `#floorControls .floor-btn[data-floor="${floor}"]`
                );
                if (btn) btn.classList.add("active");

                naver.maps.Event.addListener(groundOverlay, "click", function () {
                    exitIndoorMode();
                });
            }

            function renderFloorButtons(buildingId) {
                const config = buildings[buildingId];

                document
                    .querySelectorAll('#floorControls .floor-btn:not(#accessInfoBtn)')
                    .forEach((b) => b.remove());

                const defaultFloor = config.floors.includes("1f")
                    ? "1f"
                    : config.floors[0];

                config.floors.forEach((f) => {
                    const btn = document.createElement("button");
                    btn.className = "floor-btn map-btn-circle";
                    btn.dataset.floor = f;
                    btn.textContent = f.toUpperCase();

                    floorControlsContainer.prepend(btn);

                    if (f === defaultFloor) btn.classList.add("active");

                    btn.addEventListener("click", () => showFloor(buildingId, f));
                });
            }

            function setupBuilding(id, cfg) {
                const poly = new naver.maps.Polygon({
                    map,
                    paths: [cfg.polygonCoords],
                    fillColor: "transparent",
                    strokeColor: "#C490E4",
                    strokeWeight: 3,
                    clickable: true,
                });
                cfg.polygon = poly;

                naver.maps.Event.addListener(poly, "mouseover", () => {
                    if (!groundOverlay || !groundOverlay.getMap()) {
                        poly.setOptions({ fillColor: "#C490E4" });
                        coordDisplay.textContent = "í´ë¦­í•´ì„œ ì‹¤ë‚´ì§€ë„ë¥¼ ë³´ì„¸ìš”";
                    }
                });
                naver.maps.Event.addListener(poly, "mouseout", () => {
                    if (!groundOverlay || !groundOverlay.getMap()) {
                        poly.setOptions({ fillColor: "transparent" });
                        coordDisplay.textContent =
                            "ê±´ë¬¼ì„ í´ë¦­í•˜ë©´ ì‹¤ë‚´ì§€ë„ë¥¼ ë³¼ ìˆ˜ ìˆì–´ìš”";
                    }
                });

                naver.maps.Event.addListener(poly, "click", () => {
                    poly.setOptions({ fillColor: "#C490E4" });
                    floorControlsContainer.style.display = "flex";

                    renderFloorButtons(id);

                    const df = cfg.floors.includes("1f") ? "1f" : cfg.floors[0];
                    showFloor(id, df);

                    coordDisplay.textContent =
                        "ì¼ë°˜ì§€ë„ë¡œ ëŒì•„ê°€ë ¤ë©´ ì‹¤ë‚´ì§€ë„ë¥¼ í´ë¦­í•˜ì„¸ìš”";
                });
            }

            for (const id in buildings) setupBuilding(id, buildings[id]);

            /* ---------------------------
               Geolocation ë²„íŠ¼
            --------------------------- */
            geolocationBtn.addEventListener("click", () => {
                if (geolocationBtn.classList.contains("active")) {
                    if (currentPositionMarker)
                        currentPositionMarker.setMap(null);

                    geolocationBtn.classList.remove("active");
                    return;
                }

                navigator.geolocation?.getCurrentPosition(
                    (pos) => {
                        const latlng = new naver.maps.LatLng(
                            pos.coords.latitude,
                            pos.coords.longitude
                        );

                        map.setCenter(latlng);

                        if (currentPositionMarker)
                            currentPositionMarker.setMap(null);

                        currentPositionMarker = new naver.maps.Marker({
                            map,
                            position: latlng,
                            icon: {
                                content:
                                    '<div style="width:12px;height:12px;background:#007bff;border-radius:50%;border:2px solid white;"></div>',
                                anchor: new naver.maps.Point(6, 6),
                            },
                            zIndex: 9999,
                        });

                        geolocationBtn.classList.add("active");
                    },
                    () => alert("í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŒ"),
                    { enableHighAccuracy: true }
                );
            });

            /* ---------------------------
               ğŸ”¥ i ë²„íŠ¼ â†’ íŒì—… ìœ„ì¹˜ ì¡°ì • (30px ìœ„)
            --------------------------- */
            accessBtn.addEventListener("click", () => {
                const open = popup.style.display === "block";

                if (!open) {
                    const rect = accessBtn.getBoundingClientRect();
                    const wh = window.innerHeight;

                    const popupBottom = (wh - rect.top) + 30;
                    popup.style.bottom = popupBottom + "px";

                    popup.style.display = "block";
                    accessBtn.classList.add("active");
                } else {
                    popup.style.display = "none";
                    accessBtn.classList.remove("active");
                }
            });

            popupClose.onclick = () => {
                popup.style.display = "none";
                accessBtn.classList.remove("active");
            };
        };

        document.head.appendChild(script);
    </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
    <title>네이버 지도 기반 광화문 교보빌딩 실내 지도</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <meta charset="utf-8">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Malgun Gothic', sans-serif;
        }
        #map {
            height: 100%;
        }

        /* 층 버튼 */
        #floor-picker {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 999;
            background-color: white;
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            display: none;
        }
        .floor-button {
            display: block;
            padding: 10px 15px;
            margin: 5px 0;
            cursor: pointer;
            background-color: #f7f7f7;
            color: #333;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 600;
            user-select: none;
        }
        .floor-button.active {
            background-color: #4A90E2;
            color: #fff;
        }

        #coord-guide {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background-color: #f44336;
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            cursor: pointer;
        }

        .naver-control, .nmap_logo, .nmap_copyright {
            display: none !important;
        }
    </style>
</head>
<body>

    <div id="map"></div>
    <div id="floor-picker"></div>

    <div id="coord-guide">
        <i class="fas fa-crosshairs"></i> 좌표 추출 모드 활성화됨
    </div>

    <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=q1d23mmkof"></script>

    <script>
        /* ============================
               좌표 및 건물 설정
        ============================ */

        const COORDS = {
            NW: { lat: 37.571346, lng: 126.977674 },
            NE: { lat: 37.571349, lng: 126.978057 },
            SE: { lat: 37.570542, lng: 126.978087 },
            SW: { lat: 37.570541, lng: 126.977699 }
        };

        const centerLat = (COORDS.NW.lat + COORDS.SE.lat) / 2;
        const centerLng = (COORDS.NW.lng + COORDS.SE.lng) / 2;

        const BUILDING_CONFIGS = {
            kyobo: {
                center: new naver.maps.LatLng(centerLat, centerLng),
                polygonPaths: [
                    [
                        new naver.maps.LatLng(COORDS.NW.lat, COORDS.NW.lng),
                        new naver.maps.LatLng(COORDS.NE.lat, COORDS.NE.lng),
                        new naver.maps.LatLng(COORDS.SE.lat, COORDS.SE.lng),
                        new naver.maps.LatLng(COORDS.SW.lat, COORDS.SW.lng),
                    ]
                ],
                floors: {
                    B1: {
                        label: "지하 1층",
                        imageUrl: "https://placehold.co/1000x800/2962FF/FFFFFF?text=KYOBODB+B1",
                        imageBounds: new naver.maps.LatLngBounds(
                            new naver.maps.LatLng(COORDS.NW.lat, COORDS.NW.lng),
                            new naver.maps.LatLng(COORDS.SE.lat, COORDS.SE.lng)
                        )
                    },
                    "1F": {
                        label: "1층",
                        imageUrl: "https://placehold.co/1000x800/1DE9B6/333333?text=KYOBODB+1F",
                        imageBounds: new naver.maps.LatLngBounds(
                            new naver.maps.LatLng(COORDS.NW.lat, COORDS.NW.lng),
                            new naver.maps.LatLng(COORDS.SE.lat, COORDS.SE.lng)
                        )
                    },
                    "2F": {
                        label: "2층",
                        imageUrl: "https://placehold.co/1000x800/FFEA00/333333?text=KYOBODB+2F",
                        imageBounds: new naver.maps.LatLngBounds(
                            new naver.maps.LatLng(COORDS.NW.lat, COORDS.NW.lng),
                            new naver.maps.LatLng(COORDS.SE.lat, COORDS.SE.lng)
                        )
                    }
                }
            }
        };

        /* ============================
               전역 상태 변수
        ============================ */

        let mapInstance;
        let vectorMapType, rasterMapType;
        let labelLayer;
        let isIndoorMode = false;
        let activeBuildingId = null;
        let clickListener = null;
        let currentFloorId = null;

        const buildingPolygons = {};
        const floorOverlays = {};

        /* ============================
               좌표 추출 기능
        ============================ */

        function enableCoordExtract() {
            document.getElementById("coord-guide").style.display = "block";

            clickListener = naver.maps.Event.addListener(mapInstance, "click", (e) => {
                alert(`위도: ${e.coord.y.toFixed(6)}\n경도: ${e.coord.x.toFixed(6)}`);
            });
        }

        function disableCoordExtract() {
            if (clickListener) naver.maps.Event.removeListener(clickListener);
            document.getElementById("coord-guide").style.display = "none";
        }

        /* ============================
               층 오버레이 관리
        ============================ */

        function setFloorOverlay(floorId) {
            const key = `${activeBuildingId}_${floorId}`;

            if (currentFloorId) {
                const oldKey = `${activeBuildingId}_${currentFloorId}`;
                if (floorOverlays[oldKey]) floorOverlays[oldKey].setMap(null);
            }

            floorOverlays[key].setMap(mapInstance);
            currentFloorId = floorId;

            document.querySelectorAll(".floor-button").forEach(btn =>
                btn.classList.toggle("active", btn.dataset.floorId === floorId)
            );
        }

        /* ============================
               실내 모드 ON
        ============================ */

        function enterIndoor(buildingId) {
            disableCoordExtract();
            isIndoorMode = true;
            activeBuildingId = buildingId;

            // 벡터 지도 + 라벨 제거
            mapInstance.setMapTypeId("vector");
            labelLayer.setMap(null);

            mapInstance.setZoom(20);
            mapInstance.setCenter(BUILDING_CONFIGS[buildingId].center);

            // 층 버튼 생성
            const picker = document.getElementById("floor-picker");
            picker.innerHTML = "";
            picker.style.display = "block";

            const floors = Object.keys(BUILDING_CONFIGS[buildingId].floors).reverse();
            floors.forEach(floorId => {
                const btn = document.createElement("div");
                btn.className = "floor-button";
                btn.innerText = BUILDING_CONFIGS[buildingId].floors[floorId].label;
                btn.dataset.floorId = floorId;
                btn.addEventListener("click", () => setFloorOverlay(floorId));
                picker.appendChild(btn);
            });

            setFloorOverlay(floors[0]);
        }

        /* ============================
               실내 모드 OFF
        ============================ */

        function exitIndoor() {
            isIndoorMode = false;

            if (currentFloorId) {
                const key = `${activeBuildingId}_${currentFloorId}`;
                floorOverlays[key].setMap(null);
            }

            currentFloorId = null;
            activeBuildingId = null;

            document.getElementById("floor-picker").style.display = "none";

            // 일반 지도 + 라벨 복구
            mapInstance.setMapTypeId("normal");
            labelLayer.setMap(mapInstance);

            mapInstance.setZoom(19);

            enableCoordExtract();
        }

        /* ============================
               지도 초기화
        ============================ */

        function initMap() {
            // Step 1: 지도 스타일 준비
            rasterMapType = naver.maps.NaverStyleMapTypeOptions.getRasterMap();
            vectorMapType = naver.maps.NaverStyleMapTypeOptions.getVectorMap();

            mapInstance = new naver.maps.Map("map", {
                center: BUILDING_CONFIGS["kyobo"].center,
                zoom: 19,
                mapTypes: new naver.maps.MapTypeRegistry({
                    normal: rasterMapType,
                    vector: vectorMapType
                }),
                mapTypeId: "normal"
            });

            // 라벨 레이어 준비
            labelLayer = new naver.maps.LabelLayer();
            labelLayer.setMap(mapInstance);

            enableCoordExtract();

            /* ============================
                   건물 폴리곤 생성
            ============================ */

            Object.keys(BUILDING_CONFIGS).forEach(buildingId => {
                const config = BUILDING_CONFIGS[buildingId];

                const polygon = new naver.maps.Polygon({
                    map: mapInstance,
                    paths: config.polygonPaths,
                    fillColor: "#FFC107",
                    fillOpacity: 0.15,
                    strokeColor: "#FFC107",
                    strokeWeight: 2,
                    clickable: true
                });

                buildingPolygons[buildingId] = polygon;

                naver.maps.Event.addListener(polygon, "click", () => {
                    if (!isIndoorMode) enterIndoor(buildingId);
                    else exitIndoor();
                });

                // 오버레이 미리 생성
                Object.keys(config.floors).forEach(floorId => {
                    const floor = config.floors[floorId];

                    floorOverlays[`${buildingId}_${floorId}`] =
                        new naver.maps.GroundOverlay(floor.imageUrl, floor.imageBounds, {
                            opacity: 0.85
                        });
                });
            });
        }

        naver.maps.onJSContentLoaded = initMap;
    </script>

</body>
</html>

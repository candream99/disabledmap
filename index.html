<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë„¤ì´ë²„ ë²¡í„°ë§µ í…ŒìŠ¤íŠ¸ - ë¬´ì¥ì•  ì‹œì„¤ íŒì—… ìµœì¢…ë³¸ (ë°˜ì‘í˜•)</title>
    <style>
        /* ------------------------------------------------ */
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼: ëª¨ë°”ì¼ ìš°ì„  (768px ì´í•˜) */
        /* ------------------------------------------------ */
        body { 
            margin: 0;
            padding: 0; 
            height: 100vh;
            font-family: 'Malgun Gothic', sans-serif; 
            overflow: hidden; /* ëª¨ë°”ì¼ì—ì„œ í˜ì´ì§€ ìŠ¤í¬ë¡¤ ì ê¸ˆ */
        }
        #map { width: 100%; height: 100%; }

        /* ê²€ìƒ‰ì°½ (ëª¨ë°”ì¼/ë°ìŠ¤í¬í†± ê³µí†µ ë ˆì´ì•„ì›ƒ) */
        #searchBox {
            position: absolute; top: 20px; left: 50%;
            transform: translateX(-50%);
            width: 80vw; max-width: 500px; height: 48px;
            background: #ffffff; border-radius: 24px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.2); 
            display: flex; align-items: center; padding: 0 15px; 
            z-index: 2000;
        }
        
        #hamburgerBtn { 
            width: 24px; height: 24px; background: none; border: none;
            padding: 0; margin-right: 10px; cursor: pointer;
            display: flex; flex-direction: column; justify-content: space-around;
            align-items: center;
        }
        .burger-line { 
            display: block; width: 18px; height: 2px;
            background-color: #333; border-radius: 1px;
        }
        #searchPlaceholder { 
            flex-grow: 1; font-size: 16px; color: #a0a0a0; 
            pointer-events: none; user-select: none;
        }

        /* ì¢Œí‘œ í‘œì‹œ (ëª¨ë°”ì¼ ìœ„ì¹˜) */
        #coordDisplay {
            position: absolute; top: 78px; left: 50%;
            transform: translateX(-50%);
            width: 80vw; max-width: 500px; height: 24px;
            background: rgba(255, 255, 255, 0.9); color: #000000;
            border-radius: 24px; display: flex; justify-content: center; 
            align-items: center; padding: 0 15px; font-size: 14px;
            z-index: 1500; box-shadow: 0 2px 6px rgba(0,0,0,0.2); 
            transition: all 0.3s ease; white-space: nowrap;
            overflow: hidden; text-overflow: ellipsis;
        }
        
        /* ê³µí†µ ì›í˜• ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .map-btn-circle {
            width: 40px; height: 40px; padding: 0; cursor: pointer;
            background: #ffffff; border: none; border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); color: #000;
            font-weight: normal; font-size: 14px; display: flex;
            justify-content: center; align-items: center;
            text-align: center; line-height: 1;
        }

        /* ëŒ€ìœ„ì¹˜ ë²„íŠ¼ ì•„ì´ì½˜ ë³µì› ë° ìŠ¤íƒ€ì¼ */
        #geolocationBtn {
            font-size: 0; /* í…ìŠ¤íŠ¸ ìˆ¨ê¹€ */
            position: absolute; bottom: 18px; left: 10px; z-index: 1500; /* ëª¨ë°”ì¼ ìœ„ì¹˜: ì¢Œì¸¡ í•˜ë‹¨ */
        }
        #geolocationBtn .geo-icon {
            display: block; width: 20px; height: 20px;
            background-image: url('https://raw.githubusercontent.com/candream99/disabledmap/main/icons/geolocation_normal.png');
            background-size: contain; background-repeat: no-repeat;
            background-position: center;
        }
        #geolocationBtn.active .geo-icon {
            background-image: url('https://raw.githubusercontent.com/candream99/disabledmap/main/icons/geolocation_active.png');
        }

        /* ì¸µ ì»¨íŠ¸ë¡¤ ì»¨í…Œì´ë„ˆ (ëª¨ë°”ì¼ ìœ„ì¹˜: ì¢Œì¸¡ í•˜ë‹¨) */
        #floorControls {
            position: absolute; bottom: 88px; left: 10px;
            display: none; flex-direction: column-reverse; 
            gap: 8px; z-index: 1500; background: transparent;
            padding: 0; box-shadow: none;
        }

        /* ------------------------------------------------ */
        /* ë¬´ì¥ì•  íŒì—… (ëª¨ë°”ì¼/ë°ìŠ¤í¬í†± ê³µí†µ ê¸°ë³¸) */
        /* ------------------------------------------------ */
        #accessPopup {
            position: absolute;
            bottom: 20px; 
            width: auto; /* JSì—ì„œ ìœ ë™ì ìœ¼ë¡œ ì„¤ì • */
            background: white; padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
            display: none; z-index: 2000;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }
        
        /* ------------------------------------------------ */
        /* ë°ìŠ¤í¬í†± ìŠ¤íƒ€ì¼ (769px ì´ìƒ) - íŒì—… ìµœëŒ€ ë„ˆë¹„ ì„¤ì • */
        /* ------------------------------------------------ */
        @media (min-width: 769px) {
            body { 
                overflow: auto; 
            }

            /* ë²„íŠ¼ ìœ„ì¹˜: ì¢Œì¸¡ í•˜ë‹¨ */
            #geolocationBtn {
                left: 10px; right: auto;
            }

            /* ì¸µ ì»¨íŠ¸ë¡¤ ìœ„ì¹˜: ì¢Œì¸¡ í•˜ë‹¨ */
            #floorControls {
                left: 10px; right: auto; bottom: 88px;
            }
            
            /* ë¬´ì¥ì•  íŒì—… (ë°ìŠ¤í¬í†± ìŠ¤íƒ€ì¼: ì¢Œì¸¡ ë²„íŠ¼ ì˜†, ìµœëŒ€ ë„ˆë¹„ 350px) */
            #accessPopup {
                top: auto;
                bottom: 20px; 
                max-width: 350px; 
                border-radius: 8px;
                padding: 15px;
            }
        }

        /* ë‚˜ë¨¸ì§€ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .floor-btn { font-size: 14px; }
        .map-btn-circle.active { background: #007bff; color: #fff; font-weight: bold; }
        #accessInfoBtn { margin-bottom: 18px; font-size: 0; line-height: 0; }
        #accessInfoBtn .i-icon { 
            display: block; width: 25px; height: 25px;
            background-size: contain; background-repeat: no-repeat;
            background-position: center;
            background-image: url('https://raw.githubusercontent.com/candream99/disabledmap/main/i_button.png');
        }
        #accessInfoBtn.active .i-icon { 
            background-image: url('https://raw.githubusercontent.com/candream99/disabledmap/main/i_button2.png');
        }
        #accessPopupClose { 
            position:absolute; top:6px; right:10px; font-size:22px; cursor:pointer; color:#777;
        }
        .popup-section { 
            margin-bottom: 12px; padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        .popup-section:last-child { 
            margin-bottom: 0; padding-bottom: 0; border-bottom: none;
        }
        #buildingInfoSection { 
            display: flex; align-items: flex-start; gap: 10px;
        }
        #buildingImage { 
            width: 33.33%; height: auto; object-fit: cover; border-radius: 4px;
        }
        #buildingTextInfo { flex-grow: 1; }
        #buildingName { font-weight: bold; font-size: 1rem; margin-bottom: 4px; }
        .info-item { 
            display: flex; align-items: flex-start; font-size: 0.85rem;
            color: #555; margin-bottom: 2px;
        }
        .info-item i { 
            width: 14px; text-align: center; margin-right: 5px; line-height: 1.5;
        }
        .access-item { 
            display: flex; justify-content: space-between; margin-bottom: 8px;
            font-size: 0.95rem;
        }
        .access-status { 
            font-weight: 600; min-width: 40px; text-align: right;
        }
        .status-positive { color: #10b981; }
        .status-negative { color: #ef4444; }

    </style>
</head>
<body>
    <div id="map"></div>
    
    <div id="searchBox">
        <button id="hamburgerBtn" title="ë©”ë‰´">
            <span class="burger-line"></span>
            <span class="burger-line"></span>
            <span class="burger-line"></span>
        </button>
        <div id="searchPlaceholder">ê±´ë¬¼ì´ë¦„ì„ ê²€ìƒ‰í•˜ì„¸ìš”</div>
    </div>
    
    <div id="coordDisplay" class="outdoor-mode-coord">ê±´ë¬¼ì„ í´ë¦­í•˜ë©´ ì‹¤ë‚´ì§€ë„ë¥¼ ë³¼ ìˆ˜ ìˆì–´ìš”</div>
    
    <!-- ëª¨ë°”ì¼/ë°ìŠ¤í¬í†± ìœ„ì¹˜ëŠ” CSS ë¯¸ë””ì–´ ì¿¼ë¦¬ë¡œ ì¡°ì •ë¨ -->
    <button id="geolocationBtn" class="map-btn-circle" title="í˜„ì¬ ìœ„ì¹˜ ì°¾ê¸°"><span class="geo-icon"></span></button>
    
    <div id="floorControls">
        <button id="accessInfoBtn" class="floor-btn map-btn-circle" data-floor="access" title="ë¬´ì¥ì•  ì‹œì„¤ ì •ë³´"><span class="i-icon"></span></button>
    </div>

    <!-- íŒì—… ìœ„ì¹˜ ë° í¬ê¸°ëŠ” CSS ë¯¸ë””ì–´ ì¿¼ë¦¬ì™€ JS ë¡œì§ìœ¼ë¡œ ì¡°ì •ë¨ -->
    <div id="accessPopup" style="display:none;">
        <span id="accessPopupClose" style="position:absolute; top:6px; right:10px; font-size:22px; cursor:pointer; color:#777;">Ã—</span>
        
        <div id="accessPopupBody">
            <div id="buildingInfoSection" class="popup-section"></div>
            <div id="accessFacilitySection" class="popup-section"></div>
        </div>
    </div>

    <script>
        
        const NCP_KEY_ID = 'q1d23mmkof';
        const script = document.createElement('script');
        script.src = `https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=${NCP_KEY_ID}&vmode=3`;

        // ---------------------------------------------------------
        // í•µì‹¬: ëª¨ë°”ì¼/ë°ìŠ¤í¬í†± í™˜ê²½ êµ¬ë¶„ í•¨ìˆ˜
        // ---------------------------------------------------------
        function isMobile() {
            // 768px ì´í•˜ë¥¼ ëª¨ë°”ì¼ë¡œ ê°„ì£¼
            return window.matchMedia("(max-width: 768px)").matches;
        }
        // ---------------------------------------------------------

        script.onload = function () 
        {
            // ì „ì—­ DOM ìš”ì†Œ ë³€ìˆ˜
            const mapContainer = document.getElementById('map');
            const searchBox = document.getElementById('searchBox'); 
            const coordDisplay = document.getElementById('coordDisplay');
            const floorControlsContainer = document.getElementById('floorControls');
            const popup = document.getElementById('accessPopup');
            const buildingInfoSection = document.getElementById('buildingInfoSection');
            const accessFacilitySection = document.getElementById('accessFacilitySection');
            const accessBtn = document.getElementById('accessInfoBtn');
            const popupClose = document.getElementById('accessPopupClose');
            const geolocationBtn = document.getElementById('geolocationBtn');

            // ì§€ë„ ì˜µì…˜
            const mapOptions = {
                center: new naver.maps.LatLng(37.5710, 126.9784),
                zoom: 17, 
                zoomControl: false, 
                scrollWheelZoom: isMobile() ? false : true, // ë°ìŠ¤í¬í†±ì—ì„œ íœ  ì¤Œ ê¸°ë³¸ í™œì„±í™”
                pinchZoom: true,
                mapTypes: new naver.maps.MapTypeRegistry({
                    normal: naver.maps.NaverStyleMapTypeOptions.getVectorMap(),
                }),
            };
            const map = new naver.maps.Map('map', mapOptions);
            map.setMapTypeId('normal');
            const labelLayer = new naver.maps.LabelLayer();
            labelLayer.setMap(map);

            // ---------------------------------------------------------
            // ë°ìŠ¤í¬í†±ì—ì„œë§Œ ì»¤ìŠ¤í…€ íœ  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
            // ---------------------------------------------------------
            if (!isMobile()) {
                const ZOOM_STEP = 0.1;
                mapContainer.addEventListener("wheel", function (e) {
                    e.preventDefault(); 

                    let currentZoom = map.getZoom();
                    let newZoom = currentZoom;

                    if (e.deltaY < 0) newZoom += ZOOM_STEP;   // í™•ëŒ€
                    else newZoom -= ZOOM_STEP;                // ì¶•ì†Œ

                    newZoom = Math.round(newZoom * 100) / 100;
                    newZoom = Math.min(Math.max(newZoom, 1), 21);

                    map.setZoom(newZoom);
                }, { passive: false });
            }
            // ---------------------------------------------------------

            let groundOverlay = null; 
            let currentBuildingId = null; 
            let currentPositionMarker = null;

            // =========================================================
            // ë¹Œë”©ë³„ ë°ì´í„° ì •ì˜ (ìƒëµ ì—†ì´ ìœ ì§€)
            // =========================================================
            const buildings = {
                'ky': { 
                    polygonCoords: [
                        new naver.maps.LatLng(37.571350, 126.977670),
                        new naver.maps.LatLng(37.571360, 126.978059),
                        new naver.maps.LatLng(37.571275, 126.978063),
                        new naver.maps.LatLng(37.571275, 126.978173),
                        new naver.maps.LatLng(37.570870, 126.978184),
                        new naver.maps.LatLng(37.570872, 126.978082),
                        new naver.maps.LatLng(37.570543, 126.978094),
                        new naver.maps.LatLng(37.570539, 126.977702),
                    ],
                    floors: ['b1', '1f', '2f'],
                    images: {
                        'b1': 'https://raw.githubusercontent.com/candream99/disabledmap/main/kb/ky_1.jpg',
                        '1f': 'https://raw.githubusercontent.com/candream99/disabledmap/main/kb/ky11.png', 
                        '2f': 'https://raw.githubusercontent.com/candream99/disabledmap/main/kb/ky_1.jpg',
                    },
                    imageBounds: new naver.maps.LatLngBounds(
                        new naver.maps.LatLng(37.570512, 126.977632), 
                        new naver.maps.LatLng(37.571415, 126.978244)  
                    ),
                    currentFloor: '1f', 
                    polygon: null,
                    accessInfo: {
                        'ì£¼ì¶œì…êµ¬ ê²½ì‚¬ë¡œ': true, 'ì¥ì• ì¸ í™”ì¥ì‹¤': true, 'ì§•ì• ì¸ ì£¼ì°¨ì¥': true,
                        'ì—˜ë¦¬ë² ì´í„°': true, 'ì£¼ì¶œì…êµ¬ ë‹¨ì°¨': false 
                    },
                    buildingInfo: {
                        name: 'êµë³´ë¹Œë”©', image_url: 'https://raw.githubusercontent.com/candream99/disabledmap/main/kb/kyobo_gwanghwamun.jpg', 
                        address: 'ì„œìš¸ ì¢…ë¡œêµ¬ ìƒˆë¬¸ì•ˆë¡œ 45', operating_hours: '09:00 - 18:00 (ì›”ìš”ì¼ íœ´ë¬´)'
                    }
                },
                'dt': { 
                    polygonCoords: [
                        new naver.maps.LatLng(37.571470, 126.978762), new naver.maps.LatLng(37.571476, 126.979161),
                        new naver.maps.LatLng(37.570627, 126.979181), new naver.maps.LatLng(37.570557, 126.979117),
                        new naver.maps.LatLng(37.570553, 126.978777),
                    ],
                    floors: ['b4', '1f'], 
                    images: {
                        'b4': 'https://raw.githubusercontent.com/candream99/disabledmap/main/dt/dt_b4.png',
                        '1f': 'https://raw.githubusercontent.com/candream99/disabledmap/main/dt/dt1.png',
                    },
                    imageBounds: new naver.maps.LatLngBounds(
                        new naver.maps.LatLng(37.570459, 126.978649), 
                        new naver.maps.LatLng(37.571626, 126.979210)  
                    ),
                    currentFloor: '1f', polygon: null,
                    accessInfo: {
                        'ì£¼ì¶œì…êµ¬ ê²½ì‚¬ë¡œ': false, 'ì¥ì• ì¸ í™”ì¥ì‹¤': true, 
                        'ì¥ì• ì¸ ì£¼ì°¨ì¥': false, 'ì—˜ë¦¬ë² ì´í„°': true, 'ì£¼ì¶œì…êµ¬ ë‹¨ì°¨': true 
                    },
                    buildingInfo: {
                        name: 'ê´‘í™”ë¬¸ Díƒ€ì›Œ', image_url: 'https://raw.githubusercontent.com/candream99/disabledmap/main/dt/d_tower.jpg', 
                        address: 'ì„œìš¸ ì¢…ë¡œêµ¬ ì†¡ì›”ê¸¸ 2', operating_hours: '10:00 - 19:00 (ë§¤ì¼ ìš´ì˜)'
                    }
                }
            };
            // =========================================================

            /**
             * íŠ¹ì • ìš”ì†Œ ë‚´ë¶€ì—ì„œ í„°ì¹˜ ì´ë™(ë“œë˜ê·¸)ì„ ë§‰ì•„
             * ë¸Œë¼ìš°ì €ì˜ ê¸°ë³¸ ì˜¤ë²„ìŠ¤í¬ë¡¤ ë° í™”ë©´ ì´ë™ì„ ë°©ì§€í•©ë‹ˆë‹¤.
             */
            function preventTouchMove(elementId) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.addEventListener('touchmove', function(e) {
                        e.preventDefault();
                    }, { passive: false });
                }
            }

            // ---------------------------------------------------------
            // ëª¨ë°”ì¼ì—ì„œë§Œ í„°ì¹˜ ì´ë™ ì ê¸ˆ ì‹¤í–‰ (ìœ ì§€)
            // ---------------------------------------------------------
            if (isMobile()) {
                preventTouchMove('searchBox');
                preventTouchMove('floorControls');
                // íŒì—… ë‚´ë¶€ ìŠ¤í¬ë¡¤ì€ í—ˆìš©í•˜ë˜, íŒì—… ìì²´ë¥¼ ë“œë˜ê·¸í•˜ì—¬ í™”ë©´ ì „ì²´ê°€ ì›€ì§ì´ëŠ” ê²ƒì€ ë°©ì§€
                preventTouchMove('accessPopup'); 
            }
            // ---------------------------------------------------------
            
            // ---------------------------------------------------------
            // enterIndoorMode í•¨ìˆ˜ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
            // ---------------------------------------------------------
            function enterIndoorMode(buildingId) {
                searchBox.style.display = 'none';
                coordDisplay.style.top = '10px';

                const config = buildings[buildingId];
                if (config && config.polygonCoords && config.polygonCoords.length > 0) {
                    const bounds = new naver.maps.LatLngBounds();
                    config.polygonCoords.forEach(coord => bounds.extend(coord));
                    const centerPoint = bounds.getCenter();
                    
                    map.setCenter(centerPoint);
                    map.setZoom(18); // ìš”ì²­ëŒ€ë¡œ í•­ìƒ 18ë¡œ ê³ ì •
                }

                currentBuildingId = buildingId;
                labelLayer.setMap(null);
                floorControlsContainer.style.display = 'flex';
                coordDisplay.textContent = 'ì¼ë°˜ì§€ë„ë¡œ ëŒì•„ê°€ë ¤ë©´ ì‹¤ë‚´ì§€ë„ë¥¼ í´ë¦­í•˜ì„¸ìš”';
            }

            // ---------------------------------------------------------
            // exitIndoorMode í•¨ìˆ˜ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
            // ---------------------------------------------------------
            function exitIndoorMode() {
                if (!currentBuildingId) return;
                if (groundOverlay) {
                    groundOverlay.setMap(null);
                }
                
                popup.style.display = 'none';
                accessBtn.classList.remove('active');
                
                for (const id in buildings) {
                    if (buildings[id].polygon) {
                        buildings[id].polygon.setMap(map);
                        buildings[id].polygon.setOptions({ fillColor: 'transparent' }); 
                    }
                }
            
                floorControlsContainer.style.display = 'none';
                labelLayer.setMap(map);
                currentBuildingId = null; 
            
                searchBox.style.display = 'flex';
                coordDisplay.style.top = '78px'; // ëª¨ë“  í™˜ê²½ì—ì„œ 78px ìœ ì§€
                coordDisplay.textContent = 'ê±´ë¬¼ì„ í´ë¦­í•˜ë©´ ì‹¤ë‚´ì§€ë„ë¥¼ ë³¼ ìˆ˜ ìˆì–´ìš”';
            }
            
            // ---------------------------------------------------------
            // showFloor í•¨ìˆ˜ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
            // ---------------------------------------------------------
            function showFloor(buildingId, floor) {
                const config = buildings[buildingId];
                if (!config || !config.images[floor]) return;

                currentBuildingId = buildingId;
                config.currentFloor = floor; 
                
                if (groundOverlay) groundOverlay.setMap(null);
                for (const id in buildings) {
                    if (id !== buildingId && buildings[id].polygon) {
                        buildings[id].polygon.setMap(null);
                    }
                }

                if (currentPositionMarker) {
                    currentPositionMarker.setMap(null);
                    geolocationBtn.classList.remove('active'); 
                }

                groundOverlay = new naver.maps.GroundOverlay(
                    config.images[floor],
                    config.imageBounds,
                    { map: map, clickable: true, opacity: 1 }
                );

                document.querySelectorAll('#floorControls .floor-btn:not(#accessInfoBtn)').forEach(btn => btn.classList.remove('active'));
                const floorBtn = document.querySelector(`#floorControls .floor-btn[data-floor="${floor}"]`);
                if (floorBtn) floorBtn.classList.add('active');

                naver.maps.Event.addListener(groundOverlay, 'click', function (e) {
                    e.stopOverlays = true;
                    exitIndoorMode(); 
                });
            }

            // ---------------------------------------------------------
            // renderFloorButtons í•¨ìˆ˜ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
            // ---------------------------------------------------------
            function renderFloorButtons(buildingId) {
                const config = buildings[buildingId];
                document.querySelectorAll('#floorControls .floor-btn:not(#accessInfoBtn)').forEach(btn => btn.remove());
                const defaultFloor = config.floors.includes('1f') ? '1f' : config.floors[0];
                config.currentFloor = defaultFloor;
                config.floors.forEach(floor => {
                    const btn = document.createElement('button');
                    btn.className = 'floor-btn map-btn-circle'; 
                    btn.dataset.floor = floor;
                    btn.textContent = floor.toUpperCase();
                    
                    floorControlsContainer.prepend(btn);

                    if (floor === defaultFloor) {
                        btn.classList.add('active');
                    }

                    btn.addEventListener('click', () => {
                        showFloor(buildingId, floor);
                    });
                });
            }

            // ---------------------------------------------------------
            // updateAccessPopup í•¨ìˆ˜ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
            // ---------------------------------------------------------
            function updateAccessPopup(buildingId) {
                const config = buildings[buildingId];
                const accessInfo = config?.accessInfo;
                const buildingInfo = config?.buildingInfo;
                
                buildingInfoSection.innerHTML = '';
                accessFacilitySection.innerHTML = '';

                if (buildingInfo) {
                    buildingInfoSection.innerHTML = `
                        <img id="buildingImage" src="${buildingInfo.image_url}" alt="${buildingInfo.name} ì‚¬ì§„">
                        <div id="buildingTextInfo">
                            <div id="buildingName">${buildingInfo.name}</div>
                            <div class="info-item">
                                <i>ğŸ“</i>
                                <span>${buildingInfo.address}</span>
                            </div>
                            <div class="info-item">
                                <i>ğŸ•’</i>
                                <span>${buildingInfo.operating_hours}</span>
                            </div>
                        </div>
                    `;
                } else {
                    buildingInfoSection.innerHTML = '<div>ê±´ë¬¼ ê¸°ë³¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
                
                if (!accessInfo) {
                    accessFacilitySection.innerHTML = '<div>ê±´ë¬¼ì— ëŒ€í•œ ë¬´ì¥ì•  ì‹œì„¤ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }

                let html = '';
                html += '<div style="font-size:1.0rem; font-weight:700; margin-bottom:12px; color:#1e3a8a;">ë¬´ì¥ì•  ì‹œì„¤ì •ë³´</div>';

                for (const facility in accessInfo) {
                    const isAvailable = accessInfo[facility];
                    let statusText, statusClass;

                    if (facility.includes('ë‹¨ì°¨')) {
                        statusText = isAvailable ? 'ìˆìŒ' : 'ì—†ìŒ';
                        statusClass = isAvailable ? 'status-negative' : 'status-positive'; 
                    } else {
                        statusText = isAvailable ? 'ìˆìŒ' : 'ì—†ìŒ';
                        statusClass = isAvailable ? 'status-positive' : 'status-negative';
                    }

                    html += `
                        <div class="access-item">
                            <span>â€¢ ${facility}</span>
                            <span class="access-status ${statusClass}">${statusText}</span>
                        </div>
                    `;
                }
                accessFacilitySection.innerHTML = html;
            }

            // ---------------------------------------------------------
            // setupBuilding í•¨ìˆ˜ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
            // ---------------------------------------------------------
            function setupBuilding(buildingId, config) {
                const polygon = new naver.maps.Polygon({
                    map: map,
                    paths: [config.polygonCoords],
                    fillColor: 'transparent',
                    fillOpacity: 0.5,
                    strokeColor: '#C490E4',
                    strokeOpacity: 1,
                    strokeWeight: 2,
                    clickable: true,
                });
                config.polygon = polygon; 

                naver.maps.Event.addListener(polygon, 'mouseover', function() {
                    if (!groundOverlay || groundOverlay.getMap() === null) {
                        polygon.setOptions({ fillColor: '#C490E4' });
                        coordDisplay.textContent = 'í´ë¦­í•´ì„œ ì‹¤ë‚´ì§€ë„ë¥¼ ë³´ì„¸ìš”';
                    }
                });
                naver.maps.Event.addListener(polygon, 'mouseout', function() {
                    if (!groundOverlay || groundOverlay.getMap() === null) {
                        polygon.setOptions({ fillColor: 'transparent' });
                        coordDisplay.textContent = 'ê±´ë¬¼ì„ í´ë¦­í•˜ë©´ ì‹¤ë‚´ì§€ë„ë¥¼ ë³¼ ìˆ˜ ìˆì–´ìš”';
                    }
                });
                naver.maps.Event.addListener(polygon, 'click', function (e) {
                    e.stopOverlays = true;
                    
                    enterIndoorMode(buildingId);
                    polygon.setOptions({ fillColor: '#C490E4' });
                    
                    if (currentPositionMarker) {
                        currentPositionMarker.setMap(null);
                        geolocationBtn.classList.remove('active'); 
                    }

                    renderFloorButtons(buildingId);
                    
                    const defaultFloor = config.floors.includes('1f') ? '1f' : config.floors[0];
                    showFloor(buildingId, defaultFloor);
                    
                    updateAccessPopup(buildingId); 
                });
            }

            // ---------------------------------------------------------
            // Geolocation ê¸°ëŠ¥ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
            // ---------------------------------------------------------
            geolocationBtn.addEventListener('click', function() {
                // ... (Geolocation ë¡œì§ì€ ë³€ê²½ ì—†ìŒ)
                const isIndoorMode = currentBuildingId !== null;

                if (geolocationBtn.classList.contains('active')) {
                    if (currentPositionMarker) {
                        currentPositionMarker.setMap(null);
                    }
                    geolocationBtn.classList.remove('active');
                    
                    if (isIndoorMode) {
                        coordDisplay.textContent = 'ì¼ë°˜ì§€ë„ë¡œ ëŒì•„ê°€ë ¤ë©´ ì‹¤ë‚´ì§€ë„ë¥¼ í´ë¦­í•˜ì„¸ìš”';
                    } else {
                        coordDisplay.textContent = 'ê±´ë¬¼ì„ í´ë¦­í•˜ë©´ ì‹¤ë‚´ì§€ë„ë¥¼ ë³¼ ìˆ˜ ìˆì–´ìš”';
                    }
                    return;
                }
                
                if (navigator.geolocation) {
                    coordDisplay.textContent = 'í˜„ì¬ ìœ„ì¹˜ë¥¼ ì°¾ëŠ” ì¤‘ì…ë‹ˆë‹¤...';
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            const currentLatLng = new naver.maps.LatLng(lat, lng);

                            map.setCenter(currentLatLng);
                            map.setZoom(17); 

                            if (currentPositionMarker) {
                                currentPositionMarker.setMap(null);
                            }

                            currentPositionMarker = new naver.maps.Marker({
                                map: map,
                                position: currentLatLng,
                                icon: {
                                    content: 
                                        '<div style="width:12px; height:12px; background-color:#007bff; border-radius:50%; border:2px solid #ffffff; box-shadow:0 0 5px rgba(0,0,0,0.5);"></div>',
                                    size: new naver.maps.Size(12, 12),
                                    anchor: new naver.maps.Point(6, 6)
                                },
                                zIndex: 9999
                            });
                            
                            if (isIndoorMode) {
                                coordDisplay.textContent = 'í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤. ì‹¤ë‚´ì§€ë„ëŠ” ê·¸ëŒ€ë¡œ í‘œì‹œë©ë‹ˆë‹¤.';
                            } else {
                                coordDisplay.textContent = 'í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤! ê±´ë¬¼ì„ í´ë¦­í•˜ë©´ ì‹¤ë‚´ì§€ë„ë¥¼ ë³¼ ìˆ˜ ìˆì–´ìš”';
                            }
                            geolocationBtn.classList.add('active'); 

                        },
                        function(error) {
                            console.error("Geolocation Error:", error);
                            let errorMsg = 'ìœ„ì¹˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.';
                            if (error.code === 1) {
                                errorMsg = 'ìœ„ì¹˜ ì •ë³´ ì ‘ê·¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.';
                            } else if (error.code === 2) {
                                errorMsg = 'ìœ„ì¹˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                            }
                            
                            if (isIndoorMode) {
                                coordDisplay.textContent = `[ì—ëŸ¬] ${errorMsg}. ì‹¤ë‚´ì§€ë„ë¡œ ëŒì•„ê°€ë ¤ë©´ í´ë¦­í•˜ì„¸ìš”`;
                            } else {
                                coordDisplay.textContent = `[ì—ëŸ¬] ${errorMsg}. ê±´ë¬¼ì„ í´ë¦­í•˜ë©´ ì‹¤ë‚´ì§€ë„ë¥¼ ë³¼ ìˆ˜ ìˆì–´ìš”`;
                            }
                            
                            if (currentPositionMarker) {
                                currentPositionMarker.setMap(null);
                            }
                            geolocationBtn.classList.remove('active');
                        },
                        { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 } 
                    );
                } else {
                    coordDisplay.textContent = 'Geolocation ë¯¸ì§€ì›: ê±´ë¬¼ì„ í´ë¦­í•˜ë©´ ì‹¤ë‚´ì§€ë„ë¥¼ ë³¼ ìˆ˜ ìˆì–´ìš”';
                }
            });


            // =========================================================
            // ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            // =========================================================

            for (const id in buildings) {
                setupBuilding(id, buildings[id]);
            }

            naver.maps.Event.addListener(map, 'click', function (e) {
                if (!groundOverlay || groundOverlay.getMap() === null) {
                    coordDisplay.textContent = 'ê±´ë¬¼ì„ í´ë¦­í•˜ë©´ ì‹¤ë‚´ì§€ë„ë¥¼ ë³¼ ìˆ˜ ìˆì–´ìš”';
                }
            });

            // ---------------------------------------------------------
            // â­ [ìµœì¢… ìˆ˜ì •] íŒì—… ìœ„ì¹˜ ë° ëª¨ë°”ì¼ ë„ˆë¹„ ì¡°ì • ë¡œì§
            // ---------------------------------------------------------
            accessBtn.addEventListener('click', function() {
                if (!currentBuildingId) {
                    coordDisplay.textContent = 'ë¬´ì¥ì•  ì‹œì„¤ ì •ë³´ëŠ” ê±´ë¬¼ì„ í´ë¦­í•˜ì—¬ ì‹¤ë‚´ ëª¨ë“œ ì§„ì… í›„ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”.';
                    return;
                }

                const isOpen = popup.style.display === 'block';
                
                if (!isOpen) {
                    const buttonRect = accessBtn.getBoundingClientRect();
                    const popupGap = 5;
                    const minMarginRight = '10px'; // í™”ë©´ ìš°ì¸¡ ìµœì†Œ ì—¬ë°±

                    // 1. íŒì—… ì¢Œì¸¡ ìœ„ì¹˜ (ìš”ì²­ëŒ€ë¡œ ë²„íŠ¼ ìš°ì¸¡ì— ê³ ì •)
                    const newPopupLeft = buttonRect.right + popupGap;
                    
                    popup.style.bottom = '20px'; 
                    popup.style.top = 'auto'; 
                    popup.style.left = newPopupLeft + 'px';
                    
                    if (isMobile()) {
                        // 2. ëª¨ë°”ì¼ (768px ì´í•˜): ì¢Œì¸¡ ê³ ì •, ìš°ì¸¡ì„ 10px ë„ì›Œ ìœ ë™ì ìœ¼ë¡œ ë„ˆë¹„ ì„¤ì •
                        // 'right' ì†ì„±ê¹Œì§€ ì„¤ì •í•˜ë©´ 'left'ì™€ 'right' ì‚¬ì´ì˜ ê³µê°„ì„ íŒì—…ì´ ì±„ìš°ê²Œ ë˜ì–´ ë„ˆë¹„ê°€ ìœ ë™ì ì´ê³  ì˜ë¦¼ì´ ë°©ì§€ë¨.
                        popup.style.right = minMarginRight; 
                        popup.style.width = 'auto'; 
                        popup.style.maxWidth = 'none'; // CSSì˜ max-width ë¬´ì‹œ
                    } else {
                        // 3. ë°ìŠ¤í¬í†± (769px ì´ìƒ): ì¢Œì¸¡ ê³ ì •, ìš°ì¸¡ í•´ì œ, CSSì˜ max-width(350px) ì‚¬ìš©
                        popup.style.right = 'auto'; 
                        popup.style.width = 'auto';
                        popup.style.maxWidth = '350px'; // ë°ìŠ¤í¬í†± max-widthë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì ìš©
                    }

                    // íŒì—… ì—´ê¸°
                    popup.style.display = 'block';
                    this.classList.add('active');
                } else {
                    // íŒì—… ë‹«ê¸°
                    popup.style.display = 'none';
                    this.classList.remove('active');
                }
            });

            // ë¬´ì¥ì•  ì‹œì„¤ì •ë³´ íŒì—… ë‹«ê¸° ì´ë²¤íŠ¸ (X ë²„íŠ¼ í´ë¦­)
            if (popupClose) {
                popupClose.onclick = function() {
                    popup.style.display = 'none';
                    accessBtn.classList.remove('active');
                };
            }
        };

        // API ë¡œë“œ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ë©”ì‹œì§€
        script.onerror = function () {
            console.error('ë„¤ì´ë²„ ì§€ë„ API ë¡œë“œ ì‹¤íŒ¨! URL ë˜ëŠ” Keyë¥¼ í™•ì¸í•˜ì„¸ìš”.');
        };

        document.head.appendChild(script);
        
    </script>
</body>
</html>

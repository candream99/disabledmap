<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>네이버 벡터맵 테스트 - 다중 건물 지원</title>
    <style>
        body { margin: 0;
padding: 0; height: 100vh; font-family: 'Malgun Gothic', sans-serif; }
        #map { width: 100%;
height: 100%; }
        #status {
            position: absolute;
top: 10px; left: 10px;
            background: rgba(255, 99, 71, 0.9);
            color: white; padding: 10px 15px;
            border-radius: 5px; font-size: 14px;
            z-index: 1000;
box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* ------------------------------------------------ */
        /* ★★★ 검색창 관련 스타일 추가 ★★★ */
        /* ------------------------------------------------ */
        #searchBox {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 20px); /* 10px 마진 고려 */
            max-width: 500px;
            height: 48px;
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            padding: 0 10px;
            z-index: 2000;
        }
        #hamburgerBtn {
            width: 24px;
            height: 24px;
            background: none;
            border: none;
            padding: 0;
            margin-right: 10px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            align-items: center;
        }
        .burger-line {
            display: block;
            width: 18px;
            height: 2px;
            background-color: #333;
            border-radius: 1px;
        }
        #searchPlaceholder {
            flex-grow: 1;
            font-size: 16px;
            color: #a0a0a0; /* 회색 텍스트 */
            pointer-events: none; /* 클릭 방지 */
            user-select: none;
        }
        /* ------------------------------------------------ */

        #coordDisplay {
            position: absolute;
            /* 일반 모드: searchBox 아래 (48px + 10px top + 10px gap) */
            top: 68px; 
            left: 50%;
            transform: translateX(-50%);
            /* 일반 모드에서는 너비를 작게 설정 */
            width: auto; 
            max-width: none; 
            background: rgba(0, 0, 0, 0.75);
            color: #FFC107;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            z-index: 1500;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            min-width: 200px;
            text-align: center;
            transition: all 0.3s ease; /* 전환 효과 추가 */
        }
        
        /* 실내 모드 스타일 (JS에서 동적으로 적용할 스타일) */
        .indoor-mode-coord {
            top: 10px !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            width: auto !important;
            text-align: center;
        }

        /* 공통 원형 버튼 스타일 */
        .map-btn-circle {
            width: 40px;
            height: 40px;
            padding: 0;
            cursor: pointer;
            background: #ffffff;
            border: none; 
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            color: #000;
            font-weight: normal;
            font-size: 14px;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            line-height: 1;
        }

        /* 현재 위치 버튼 스타일 */
        #geolocationBtn {
            position: absolute;
            bottom: 18px; 
            left: 10px;
            z-index: 1500;
            font-size: 0; 
        }

        /* ----- Geolocation 아이콘 스타일 ----- */
        #geolocationBtn .geo-icon {
            display: block;
            width: 18px;
            height: 18px;
            border: 2px solid #333; 
            border-radius: 50%;
            position: relative;
            box-sizing: border-box;
            background-color: transparent;
        }

        #geolocationBtn .geo-icon::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 4px;
            height: 4px;
            background-color: #333; 
            border-radius: 50%;
        }

        #geolocationBtn.active .geo-icon {
            border: none;
            background-color: transparent;
            width: 0;
            height: 0;
            transform: none; 
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 12px solid #007bff; /* 활성화 시 파란색으로 변경 */
            margin-bottom: 6px; 
        }

        #geolocationBtn.active .geo-icon::after {
            content: none; 
        }
        /* ------------------------------------- */
        
        /* 층 컨트롤 컨테이너 스타일 */
        #floorControls {
            position: absolute;
            /* Geo 버튼과의 간격 30px 확보 */
            bottom: 88px; 
            left: 10px;
            display: none;
            flex-direction: column-reverse; 
            /* 층 버튼 사이의 간격은 10px로 유지 */
            gap: 8px; 
            z-index: 1500;
            background: transparent;
            padding: 0;
            box-shadow: none;
        }

        /* 층 버튼/액세스 버튼 스타일 (공통 원형 스타일 상속) */
        .floor-btn {
            font-size: 14px;
        }

        /* 클릭된 버튼 활성 스타일 */
        .map-btn-circle.active {
            background: #007bff; 
            color: #fff;
            font-weight: bold;
        }

        /* ------------------------------------- */
        /* 무장애 시설 버튼 이미지 스타일 */
        /* ------------------------------------- */
        #accessInfoBtn {
            /* 층 버튼과의 간격을 30px (10px gap + 20px margin) 확보 */
            margin-bottom: 18px; 
            font-size: 0;
            line-height: 0; 
        }
        
        /* Icon (span inside button) */
        #accessInfoBtn .i-icon {
            display: block;
            width: 25px; 
            height: 25px;
            background-size: contain; 
            background-repeat: no-repeat;
            background-position: center; 
            
            /* 기본 이미지 (흰색 배경) */
            background-image: url('https://raw.githubusercontent.com/candream99/disabledmap/main/i_button.png');
        }

        /* 활성화 시 이미지 (파란색 배경) */
        #accessInfoBtn.active .i-icon {
            background-image: url('https://raw.githubusercontent.com/candream99/disabledmap/main/i_button2.png');
        }
        /* ------------------------------------- */
        
        /* 무장애 팝업 */
        #accessPopup {
            position: absolute;
            left: auto;
            width: 240px; /* 너비 확장 */
            background: white;
            padding: 10px;
            border-radius: 6px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
            display: none;
            z-index: 2000;
        }
        
        /* 무장애 시설 정보 항목 스타일 */
        .access-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .access-status {
            font-weight: 600;
            min-width: 40px;
            text-align: right;
        }

        .status-positive {
            color: #10b981; /* 초록색 */
        }

        .status-negative {
            color: #ef4444; /* 빨간색 */
        }

    </style>
</head>
<body>
    <div id="status">API 키 확인 중...</div>

    <!-- ★★★ 검색창 추가 ★★★ -->
    <div id="searchBox">
        <button id="hamburgerBtn" title="메뉴">
            <span class="burger-line"></span>
            <span class="burger-line"></span>
            <span class="burger-line"></span>
        </button>
        <div id="searchPlaceholder">건물이름을 검색하세요</div>
    </div>
    
    <div id="coordDisplay" class="outdoor-mode-coord">건물을 클릭하면 실내지도를 볼 수 있어요</div>
    
    <button id="geolocationBtn" class="map-btn-circle" title="현재 위치 찾기"><span class="geo-icon"></span></button>
    
    <div id="floorControls">
        <button id="accessInfoBtn" class="floor-btn map-btn-circle" data-floor="access" title="무장애 시설 정보"><span class="i-icon"></span></button>
        </div>

    <!-- 팝업 내용을 동적으로 채우기 위해 기본 마크업을 단순화 -->
    <div id="accessPopup" style="display:none;">
        <span id="accessPopupClose" style="position:absolute; top:6px; right:10px; font-size:22px; cursor:pointer; color:#777;">×</span>
        <div style="font-size:1.0rem; font-weight:700; margin-bottom:12px; color:#1e3a8a;">무장애 시설 정보</div>
        <div id="accessPopupContent">
            <!-- 동적으로 채워질 내용 -->
        </div>
    </div>

    <div id="map"></div>

    <script>
        // 현재 코드에서는 alert() 사용을 피하고, 사용자에게 정보를 전달할 때는 UI 요소 (coordDisplay)를 활용하는 것이 좋습니다.
        // 하지만 기존 코드에 alert()이 포함되어 있으므로, Geolocation 오류 메시지만 UI에 맞게 수정했습니다.
        
        const NCP_KEY_ID = 'q1d23mmkof';
        const script = document.createElement('script');
        script.src = `https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=${NCP_KEY_ID}&vmode=3`;

        script.onload = function () {
            document.getElementById('status').textContent = 'API 로드 성공!';
            document.getElementById('status').style.background = 'rgba(60, 179, 113, 0.9)';
            
            // 전역 DOM 요소 변수
            const searchBox = document.getElementById('searchBox'); // ★★★ searchBox DOM 추가 ★★★
            const coordDisplay = document.getElementById('coordDisplay');
            const floorControlsContainer = document.getElementById('floorControls');
            const popup = document.getElementById('accessPopup');
            const popupContent = document.getElementById('accessPopupContent'); // 팝업 내용 컨테이너 추가
            const accessBtn = document.getElementById('accessInfoBtn');
            const popupClose = document.getElementById('accessPopupClose');
            const geolocationBtn = document.getElementById('geolocationBtn');

            // 지도의 중심 좌표를 두 건물을 모두 볼 수 있도록 조정
            const mapOptions = {
                center: new naver.maps.LatLng(37.5710, 126.9784),
                zoom: 17, 
                zoomControl: false, 
                mapTypes: new naver.maps.MapTypeRegistry({
                    normal: naver.maps.NaverStyleMapTypeOptions.getVectorMap(),
                }),
            };
            const map = new naver.maps.Map('map', mapOptions);
            map.setMapTypeId('normal');
            const labelLayer = new naver.maps.LabelLayer();
            labelLayer.setMap(map);
            document.getElementById('status').style.display = 'none';

            let groundOverlay = null; 
            let currentBuildingId = null; 
            let currentPositionMarker = null; 

            // =========================================================
            // 빌딩별 데이터 정의 (무장애 시설 정보 추가)
            // =========================================================
            const buildings = {
                'ky': { // 건물 1 (예시: 경희궁)
                    polygonCoords: [
                        new naver.maps.LatLng(37.571350, 126.977670),
                        new naver.maps.LatLng(37.571360, 126.978059),
                        new naver.maps.LatLng(37.571275, 126.978063),
                        new naver.maps.LatLng(37.571275, 126.978173),
                        new naver.maps.LatLng(37.570870, 126.978184),
                        new naver.maps.LatLng(37.570872, 126.978082),
                        new naver.maps.LatLng(37.570543, 126.978094),
                        new naver.maps.LatLng(37.570539, 126.977702),
                    ],
                    floors: ['b1', '1f', '2f'],
                    images: {
                        'b1': 'https://raw.githubusercontent.com/candream99/disabledmap/main/kb/ky_1.jpg',
                        '1f': 'https://raw.githubusercontent.com/candream99/disabledmap/main/kb/ky11.png', 
                        '2f': 'https://raw.githubusercontent.com/candream99/disabledmap/main/kb/ky_1.jpg',
                    },
                    imageBounds: new naver.maps.LatLngBounds(
                        new naver.maps.LatLng(37.570512, 126.977632), 
                        new naver.maps.LatLng(37.571415, 126.978244)  
                    ),
                    currentFloor: '1f', 
                    polygon: null,
                    // 무장애 시설 정보 추가 (true: 있음, false: 없음)
                    accessInfo: {
                        '주출입구 경사로': true,
                        '장애인 화장실': true,
                        '점자블록': true,
                        '엘리베이터': true,
                        '주출입구 단차': false // 단차가 없음을 긍정으로 해석하거나, 단차 여부를 명시
                    }
                },
                'dt': { // 건물 2 (예시: 돈의문)
                    polygonCoords: [
                        new naver.maps.LatLng(37.571470, 126.978762),
                        new naver.maps.LatLng(37.571476, 126.979161),
                        new naver.maps.LatLng(37.570627, 126.979181),
                        new naver.maps.LatLng(37.570557, 126.979117),
                        new naver.maps.LatLng(37.570553, 126.978777),
                    ],
                    floors: ['b4', '1f'], 
                    images: {
                        'b4': 'https://raw.githubusercontent.com/candream99/disabledmap/main/dt/dt_b4.png',
                        '1f': 'https://raw.githubusercontent.com/candream99/disabledmap/main/dt/dt1.png',
                    },
                    imageBounds: new naver.maps.LatLngBounds(
                        new naver.maps.LatLng(37.570459, 126.978649), 
                        new naver.maps.LatLng(37.571626, 126.979210)  
                    ),
                    currentFloor: '1f',
                    polygon: null,
                    // 무장애 시설 정보 추가
                    accessInfo: {
                        '주출입구 경사로': false,
                        '장애인 화장실': true,
                        '점자블록': false,
                        '엘리베이터': true,
                        '주출입구 단차': true // 단차가 있음을 부정으로 해석하거나, 단차 여부를 명시
                    }
                }
            };

            // =========================================================
            // 핵심 로직 함수
            // =========================================================

            /**
             * 실내 모드 진입 시 UI 변경
             */
            function enterIndoorMode(buildingId) {
                // 검색창 숨기기
                searchBox.style.display = 'none';

                // coordDisplay를 실내 모드 위치로 변경 (상단 중앙)
                coordDisplay.classList.add('indoor-mode-coord');
                
                // 기타 실내 모드 진입 로직 실행
                currentBuildingId = buildingId;
                labelLayer.setMap(null);
                floorControlsContainer.style.display = 'flex'; 
                coordDisplay.textContent = '일반지도로 돌아가려면 실내지도를 클릭하세요'; 
            }

            /**
             * 실내 모드를 종료하고 일반 지도로 돌아갑니다.
             */
            function exitIndoorMode() {
                if (!currentBuildingId) return; 
            
                if (groundOverlay) {
                    groundOverlay.setMap(null);
                }
                
                // 팝업창 닫기 및 'i' 버튼 active 해제 (실내모드 종료 시 모든 UI 요소 초기화)
                popup.style.display = 'none';
                accessBtn.classList.remove('active');
                
                // 모든 건물 폴리곤 복원
                for (const id in buildings) {
                    if (buildings[id].polygon) {
                        buildings[id].polygon.setMap(map); 
                        buildings[id].polygon.setOptions({ fillColor: 'transparent' }); 
                    }
                }
            
                floorControlsContainer.style.display = 'none'; // 컨트롤 숨기기
                labelLayer.setMap(map);
                currentBuildingId = null; // 건물 상태 초기화
            
                // ★★★ 일반 모드로 복귀 시 UI 변경 ★★★
                searchBox.style.display = 'flex'; // 검색창 표시
                coordDisplay.classList.remove('indoor-mode-coord'); // 실내 모드 스타일 제거
            
                // 문구 변경
                coordDisplay.textContent = '건물을 클릭하면 실내지도를 볼 수 있어요'; 
            }

            // 층 지도(GroundOverlay) 표시
            function showFloor(buildingId, floor) {
                const config = buildings[buildingId];
                if (!config || !config.images[floor]) return;

                currentBuildingId = buildingId;
                config.currentFloor = floor; // 현재 층 상태 업데이트
                
                if (groundOverlay) groundOverlay.setMap(null);

                // 다른 건물 폴리곤 숨기기
                for (const id in buildings) {
                    if (id !== buildingId && buildings[id].polygon) {
                        buildings[id].polygon.setMap(null); // 다른 건물 폴리곤 숨기기
                    }
                }

                // 현재 위치 마커가 있다면 제거 (실내 모드 진입 시)
                if (currentPositionMarker) {
                    currentPositionMarker.setMap(null);
                    geolocationBtn.classList.remove('active'); 
                }

                groundOverlay = new naver.maps.GroundOverlay(
                    config.images[floor],
                    config.imageBounds,
                    {
                        map: map,
                        clickable: true,
                        opacity: 1,
                    }
                );

                // 버튼 상태 업데이트: 층 버튼만 비활성화 후 선택된 버튼 활성화
                // 'i' 버튼의 active 상태는 건드리지 않습니다.
                document.querySelectorAll('#floorControls .floor-btn:not(#accessInfoBtn)').forEach(btn => btn.classList.remove('active'));
                
                const floorBtn = document.querySelector(`#floorControls .floor-btn[data-floor="${floor}"]`);
                if (floorBtn) floorBtn.classList.add('active');

                // 실내 모드 종료 리스너 (GroundOverlay 클릭 시)
                naver.maps.Event.addListener(groundOverlay, 'click', function (e) {
                    e.stopOverlays = true;
                    exitIndoorMode(); 
                });
            }

            // 층 버튼 동적 생성 및 렌더링
            function renderFloorButtons(buildingId) {
                const config = buildings[buildingId];
                
                // 기존 층 버튼만 제거 (i 버튼 제외)
                document.querySelectorAll('#floorControls .floor-btn:not(#accessInfoBtn)').forEach(btn => btn.remove());
                
                const defaultFloor = config.floors.includes('1f') ? '1f' : config.floors[0];
                config.currentFloor = defaultFloor;

                // 새로운 층 버튼 생성 및 추가
                config.floors.forEach(floor => {
                    const btn = document.createElement('button');
                    btn.className = 'floor-btn map-btn-circle'; 
                    btn.dataset.floor = floor;
                    btn.textContent = floor.toUpperCase();
                    
                    // 'i' 버튼 바로 위에 오도록 prepend
                    floorControlsContainer.prepend(btn);

                    if (floor === defaultFloor) {
                        btn.classList.add('active');
                    }

                    btn.addEventListener('click', () => {
                        // 층 버튼 클릭 시 'i' 팝업이나 상태에 전혀 영향을 주지 않습니다.
                        showFloor(buildingId, floor);
                    });
                });
            }

            /**
             * 무장애 시설 정보 팝업 내용을 동적으로 업데이트합니다.
             * @param {string} buildingId 현재 건물의 ID
             */
            function updateAccessPopup(buildingId) {
                const accessInfo = buildings[buildingId]?.accessInfo;
                if (!accessInfo) {
                    popupContent.innerHTML = '<div>건물에 대한 무장애 시설 정보가 없습니다.</div>';
                    return;
                }

                let html = '';
                for (const facility in accessInfo) {
                    const isAvailable = accessInfo[facility];
                    let statusText, statusClass;

                    // '단차'는 '없음'을 긍정적인 상황(장애물 없음)으로 간주하고, 나머지는 '있음'을 긍정적인 상황으로 간주합니다.
                    if (facility.includes('단차')) {
                        statusText = isAvailable ? '있음' : '없음';
                        // 단차가 '없음'이면 초록색, '있음'이면 빨간색
                        statusClass = isAvailable ? 'status-negative' : 'status-positive'; 
                    } else {
                        statusText = isAvailable ? '있음' : '없음';
                        // 경사로, 화장실, 블록, 엘리베이터가 '있음'이면 초록색, '없음'이면 빨간색
                        statusClass = isAvailable ? 'status-positive' : 'status-negative';
                    }

                    html += `
                        <div class="access-item">
                            <span>• ${facility}</span>
                            <span class="access-status ${statusClass}">${statusText}</span>
                        </div>
                    `;
                }
                popupContent.innerHTML = html;
            }


            // 건물별 Polygon 생성 및 리스너 설정
            function setupBuilding(buildingId, config) {
                const polygon = new naver.maps.Polygon({
                    map: map,
                    paths: [config.polygonCoords],
                    fillColor: 'transparent',
                    fillOpacity: 0.5,
                    strokeColor: '#C490E4',
                    strokeOpacity: 1,
                    strokeWeight: 2,
                    clickable: true,
                });
                config.polygon = polygon; 

                // 마우스 오버 리스너 
                naver.maps.Event.addListener(polygon, 'mouseover', function() {
                    if (!groundOverlay || groundOverlay.getMap() === null) {
                        polygon.setOptions({ fillColor: '#C490E4' });
                        coordDisplay.textContent = '클릭해서 실내지도를 보세요';
                    }
                });

                // 마우스 아웃 리스너 
                naver.maps.Event.addListener(polygon, 'mouseout', function() {
                    if (!groundOverlay || groundOverlay.getMap() === null) {
                        polygon.setOptions({ fillColor: 'transparent' });
                        coordDisplay.textContent = '건물을 클릭하면 실내지도를 볼 수 있어요';
                    }
                });

                // 클릭 리스너 (실내 모드 진입)
                naver.maps.Event.addListener(polygon, 'click', function (e) {
                    e.stopOverlays = true;
                    
                    // ★★★ 실내 모드 진입 시 UI 변경 함수 호출 ★★★
                    enterIndoorMode(buildingId);

                    polygon.setOptions({ fillColor: '#C490E4' });
                    
                    // 현재 위치 마커가 있다면 제거
                    if (currentPositionMarker) {
                        currentPositionMarker.setMap(null);
                        geolocationBtn.classList.remove('active'); 
                    }

                    // 해당 건물의 층 버튼 렌더링
                    renderFloorButtons(buildingId);
                    
                    // 기본 층(1F 또는 첫 층) 표시
                    const defaultFloor = config.floors.includes('1f') ? '1f' : config.floors[0];
                    showFloor(buildingId, defaultFloor);
                    
                    // 무장애 시설 정보 팝업 내용 업데이트
                    updateAccessPopup(buildingId); 
                });
            }

            // =========================================================
            // 현재 위치 (Geolocation) 기능
            // =========================================================
            geolocationBtn.addEventListener('click', function() {
                const isIndoorMode = currentBuildingId !== null;

                // 1. 이미 활성화 상태라면 (파란색 버튼) -> 비활성화하고 마커 제거
                if (geolocationBtn.classList.contains('active')) {
                    if (currentPositionMarker) {
                        currentPositionMarker.setMap(null);
                    }
                    geolocationBtn.classList.remove('active');
                    
                    if (isIndoorMode) {
                        coordDisplay.textContent = '일반지도로 돌아가려면 실내지도를 클릭하세요';
                    } else {
                        coordDisplay.textContent = '건물을 클릭하면 실내지도를 볼 수 있어요';
                    }
                    return;
                }

                // 2. Geolocation 시작
                if (navigator.geolocation) {
                    coordDisplay.textContent = '현재 위치를 찾는 중입니다...';
                    
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            const currentLatLng = new naver.maps.LatLng(lat, lng);

                            map.setCenter(currentLatLng);
                            map.setZoom(17); 

                            // 기존 마커 제거
                            if (currentPositionMarker) {
                                currentPositionMarker.setMap(null);
                            }

                            // 새로운 현재 위치 마커 생성 (파란색 도트)
                            currentPositionMarker = new naver.maps.Marker({
                                map: map,
                                position: currentLatLng,
                                icon: {
                                    content: '<div style="width:12px; height:12px; background-color:#007bff; border-radius:50%; border:2px solid #ffffff; box-shadow:0 0 5px rgba(0,0,0,0.5);"></div>',
                                    size: new naver.maps.Size(12, 12),
                                    anchor: new naver.maps.Point(6, 6)
                                },
                                zIndex: 9999
                            });
                            
                            // 문구 업데이트
                            if (isIndoorMode) {
                                coordDisplay.textContent = '현재 위치로 이동했습니다. 실내지도는 그대로 표시됩니다.';
                            } else {
                                coordDisplay.textContent = '현재 위치로 이동했습니다! 건물을 클릭하면 실내지도를 볼 수 있어요';
                            }
                            geolocationBtn.classList.add('active'); 

                        },
                        function(error) {
                            console.error("Geolocation Error:", error);
                            // alert 대신 coordDisplay를 활용하여 메시지 출력
                            let errorMsg = '위치 정보를 찾을 수 없거나 접근이 거부되었습니다.';
                            if (error.code === 1) {
                                errorMsg = '위치 정보 접근 권한이 거부되었습니다.';
                            } else if (error.code === 2) {
                                errorMsg = '위치 정보를 찾을 수 없습니다.';
                            }
                            
                            if (isIndoorMode) {
                                coordDisplay.textContent = `[에러] ${errorMsg}. 실내지도로 돌아가려면 클릭하세요`;
                            } else {
                                coordDisplay.textContent = `[에러] ${errorMsg}. 건물을 클릭하면 실내지도를 볼 수 있어요`;
                            }
                            
                            if (currentPositionMarker) {
                                currentPositionMarker.setMap(null);
                            }
                            geolocationBtn.classList.remove('active'); 
                        },
                        { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 } 
                    );
                } else {
                    coordDisplay.textContent = 'Geolocation 미지원: 건물을 클릭하면 실내지도를 볼 수 있어요';
                }
            });


            // =========================================================
            // 초기화 및 이벤트 리스너 설정
            // =========================================================

            // 모든 건물 설정
            for (const id in buildings) {
                setupBuilding(id, buildings[id]);
            }

            // 지도 클릭 리스너 (기본 문구 유지)
            naver.maps.Event.addListener(map, 'click', function (e) {
                if (!groundOverlay || groundOverlay.getMap() === null) {
                    coordDisplay.textContent = '건물을 클릭하면 실내지도를 볼 수 있어요';
                }
            });
            
            // 무장애시설 버튼 ('i' 버튼) 클릭 리스너 
            accessBtn.addEventListener('click', function() {
                // 실내 모드가 아닐 경우 팝업을 열지 않습니다.
                if (!currentBuildingId) {
                    coordDisplay.textContent = '무장애 시설 정보는 건물을 클릭하여 실내 모드 진입 후 확인할 수 있어요.';
                    return;
                }

                const isOpen = popup.style.display === 'block';
                
                if (!isOpen) {
                    // i버튼의 위치 계산
                    const buttonRect = accessBtn.getBoundingClientRect();
                    // 팝업창의 bottom 위치를 i버튼 상단에서 30px 위로 설정
                    const popupTop = buttonRect.top;
                    const popupLeft = buttonRect.right + 20;
                    popup.style.top = popupTop + 'px'; 
                    popup.style.left = popupLeft + 'px';
                    
                    // 팝업 열기
                    popup.style.display = 'block';
                    this.classList.add('active');
                } else {
                    // 팝업 닫기
                    popup.style.display = 'none';
                    this.classList.remove('active');
                }
            });

            // 무장애 시설정보 팝업 닫기 이벤트 (X 버튼 클릭)
            if (popupClose) {
                popupClose.onclick = () => {
                    popup.style.display = 'none';
                    accessBtn.classList.remove('active');
                };
            }
        };

        // API 로드 실패 시 에러 메시지
        script.onerror = function () {
            document.getElementById('status').textContent = 'API 로드 실패! URL 또는 Key 확인!';
            document.getElementById('status').background = 'red';
        };

        document.head.appendChild(script);
        
    </script>
</body>
</html>

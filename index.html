<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>ë„¤ì´ë²„ ë²¡í„°ë§µ í…ŒìŠ¤íŠ¸ - ë‹¤ì¤‘ ê±´ë¬¼ ì§€ì›</title>

    <style>
        body { margin: 0; padding: 0; height: 100vh; font-family: 'Malgun Gothic', sans-serif; }
        #map { width: 100%; height: 100%; }

        #coordDisplay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.75);
            color: #FFC107;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            z-index: 1500;
        }

        .map-btn-circle {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: none;
            background: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }

        /* í˜„ì¬ ìœ„ì¹˜ ë²„íŠ¼ */
        #geolocationBtn {
            position: absolute;
            bottom: 20px;
            left: 10px;
            z-index: 1500;
            font-size: 0;
        }

        #geolocationBtn .geo-icon {
            width: 18px; height: 18px;
            border-radius: 50%;
            border: 2px solid #333;
            position: relative;
        }

        #geolocationBtn .geo-icon::after {
            content: "";
            width: 4px; height: 4px;
            background: #333;
            border-radius: 50%;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
        }

        #geolocationBtn.active .geo-icon {
            border: none;
            background: none;
            width: 0; height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 12px solid #fff;
        }

        #geolocationBtn.active .geo-icon::after { content: none; }

        /* ì¸µ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ */
        #floorControls {
            position: absolute;
            bottom: 95px;
            left: 10px;
            display: none;
            flex-direction: column-reverse;
            gap: 10px;
            z-index: 1500;
        }

        /* i ë²„íŠ¼ */
        #accessInfoBtn { margin-bottom: 20px; }

        #accessInfoBtn .i-icon {
            width: 25px; height: 25px;
            background-size: contain;
            background-repeat: no-repeat;
            background-image: url("https://raw.githubusercontent.com/candream99/disabledmap/main/i_button.png");
        }

        #accessInfoBtn.active .i-icon {
            background-image: url("https://raw.githubusercontent.com/candream99/disabledmap/main/i_button2.png");
        }

        /* ë¬´ì¥ì•  íŒì—… */
        #accessPopup {
            position: absolute;
            bottom: 180px;
            left: 10px;
            width: 260px;
            background: #fff;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
            display: none;
            z-index: 2000;
        }

        /* ëª¨ë°”ì¼ì—ì„œ ë²„íŠ¼ í•˜ë‹¨ ê³ ì • */
        @media (max-width: 768px) {
            #geolocationBtn {
                bottom: calc(env(safe-area-inset-bottom, 10px) + 10px);
                left: calc(env(safe-area-inset-left, 10px) + 5px);
            }

            #floorControls {
                bottom: calc(env(safe-area-inset-bottom, 10px) + 95px);
                left: calc(env(safe-area-inset-left, 10px) + 5px);
            }
        }
    </style>
</head>

<body>

    <div id="coordDisplay">ê±´ë¬¼ì„ í´ë¦­í•˜ë©´ ì‹¤ë‚´ì§€ë„ë¥¼ ë³¼ ìˆ˜ ìˆì–´ìš”</div>

    <!-- í˜„ì¬ ìœ„ì¹˜ ë²„íŠ¼ -->
    <button id="geolocationBtn" class="map-btn-circle">
        <span class="geo-icon"></span>
    </button>

    <!-- ì¸µ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ -->
    <div id="floorControls">
        <button id="accessInfoBtn" class="map-btn-circle floor-btn">
            <span class="i-icon"></span>
        </button>
    </div>

    <!-- ë¬´ì¥ì•  íŒì—… -->
    <div id="accessPopup">
        <span id="accessPopupClose" style="position:absolute; top:8px; right:12px; font-size:22px; cursor:pointer;">Ã—</span>
        <div style="font-size:1.2rem; font-weight:700; margin-bottom:15px;">ë¬´ì¥ì•  ì‹œì„¤ ì •ë³´</div>
        <div style="display:flex; margin-bottom:8px;"><span>â€¢ ì£¼ì¶œì…êµ¬ ê²½ì‚¬ë¡œ</span><span style="margin-left:auto; color:#10b981;">ìˆìŒ</span></div>
        <div style="display:flex; margin-bottom:8px;"><span>â€¢ ì¥ì• ì¸ í™”ì¥ì‹¤</span><span style="margin-left:auto; color:#10b981;">ìˆìŒ</span></div>
        <div style="display:flex; margin-bottom:8px;"><span>â€¢ ì ìë¸”ë¡</span><span style="margin-left:auto; color:#10b981;">ìˆìŒ</span></div>
        <div style="display:flex; margin-bottom:8px;"><span>â€¢ ì—˜ë¦¬ë² ì´í„°</span><span style="margin-left:auto; color:#10b981;">ìˆìŒ</span></div>
        <div style="display:flex;"><span>â€¢ ì£¼ì¶œì…êµ¬ ë‹¨ì°¨</span><span style="margin-left:auto; color:#ef4444;">ìˆìŒ</span></div>
    </div>

    <div id="map"></div>

<script>
const script = document.createElement("script");
script.src = "https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=q1d23mmkof&vmode=3";

script.onload = function () {

    const coordDisplay = document.getElementById("coordDisplay");
    const floorControls = document.getElementById("floorControls");
    const popup = document.getElementById("accessPopup");
    const popupClose = document.getElementById("accessPopupClose");
    const iBtn = document.getElementById("accessInfoBtn");
    const geoBtn = document.getElementById("geolocationBtn");

    const map = new naver.maps.Map("map", {
        center: new naver.maps.LatLng(37.5710, 126.9784),
        zoom: 17,
        zoomControl: false,
        mapTypes: new naver.maps.MapTypeRegistry({
            normal: naver.maps.NaverStyleMapTypeOptions.getVectorMap(),
        }),
    });

    /* -----------------------------
       ê±´ë¬¼ polygon / ì´ë¯¸ì§€ ì„¤ì •
    ----------------------------- */
    const buildings = {
        ky: {
            polygonCoords: [
                new naver.maps.LatLng(37.571350, 126.977670),
                new naver.maps.LatLng(37.571360, 126.978059),
                new naver.maps.LatLng(37.571275, 126.978063),
                new naver.maps.LatLng(37.571275, 126.978173),
                new naver.maps.LatLng(37.570870, 126.978184),
                new naver.maps.LatLng(37.570872, 126.978082),
                new naver.maps.LatLng(37.570543, 126.978094),
                new naver.maps.LatLng(37.570539, 126.977702),
            ],
            floors: ["b1", "1f", "2f"],
            images: {
                "b1": "https://raw.githubusercontent.com/candream99/disabledmap/main/kb/ky_1.jpg",
                "1f": "https://raw.githubusercontent.com/candream99/disabledmap/main/kb/ky1.jpg",
                "2f": "https://raw.githubusercontent.com/candream99/disabledmap/main/kb/ky_1.jpg",
            },
            imageBounds: new naver.maps.LatLngBounds(
                new naver.maps.LatLng(37.570512, 126.977632),
                new naver.maps.LatLng(37.571415, 126.978244)
            ),
        },

        dt: {
            polygonCoords: [
                new naver.maps.LatLng(37.571470, 126.978762),
                new naver.maps.LatLng(37.571476, 126.979161),
                new naver.maps.LatLng(37.570627, 126.979181),
                new naver.maps.LatLng(37.570557, 126.979117),
                new naver.maps.LatLng(37.570553, 126.978777),
            ],
            floors: ["b4", "1f"],
            images: {
                "b4": "https://raw.githubusercontent.com/candream99/disabledmap/main/dt/dt_b4.png",
                "1f": "https://raw.githubusercontent.com/candream99/disabledmap/main/dt/dt1.png",
            },
            imageBounds: new naver.maps.LatLngBounds(
                new naver.maps.LatLng(37.570459, 126.978649),
                new naver.maps.LatLng(37.571626, 126.979210)
            ),
        }
    };

    let currentBuilding = null;
    let overlay = null;
    let currentMarker = null;

    /* -----------------------------
       ì‹¤ë‚´ëª¨ë“œ ì¢…ë£Œ
    ----------------------------- */
    function exitIndoorMode() {
        if (overlay) overlay.setMap(null);

        popup.style.display = "none";
        iBtn.classList.remove("active");

        floorControls.style.display = "none";

        currentBuilding = null;
        coordDisplay.textContent = "ê±´ë¬¼ì„ í´ë¦­í•˜ë©´ ì‹¤ë‚´ì§€ë„ë¥¼ ë³¼ ìˆ˜ ìˆì–´ìš”";
    }

    /* -----------------------------
       ì¸µ ë³´ì—¬ì£¼ê¸°
    ----------------------------- */
    function showFloor(buildingId, floor) {
        const config = buildings[buildingId];
        if (!config) return;

        if (overlay) overlay.setMap(null);

        overlay = new naver.maps.GroundOverlay(
            config.images[floor],
            config.imageBounds,
            { map, opacity: 1, clickable: true }
        );

        currentBuilding = buildingId;

        document.querySelectorAll(
            "#floorControls .floor-btn:not(#accessInfoBtn)"
        ).forEach(btn => btn.classList.remove("active"));

        const activeBtn = document.querySelector(
            `#floorControls .floor-btn[data-floor="${floor}"]`
        );
        if (activeBtn) activeBtn.classList.add("active");

        naver.maps.Event.addListener(overlay, "click", exitIndoorMode);
    }

    /* -----------------------------
       ì¸µ ë²„íŠ¼ ìƒì„±
    ----------------------------- */
    function renderFloorButtons(buildingId) {
        const config = buildings[buildingId];
        document.querySelectorAll("#floorControls .floor-btn:not(#accessInfoBtn)")
            .forEach(btn => btn.remove());

        config.floors.forEach(f => {
            const b = document.createElement("button");
            b.className = "map-btn-circle floor-btn";
            b.dataset.floor = f;
            b.textContent = f.toUpperCase();
            floorControls.prepend(b);

            b.onclick = () => showFloor(buildingId, f);
        });
    }

    /* -----------------------------
       ê±´ë¬¼ í´ë¦¬ê³¤ ìƒì„±
    ----------------------------- */
    for (const id in buildings) {
        const config = buildings[id];

        const poly = new naver.maps.Polygon({
            map,
            paths: [config.polygonCoords],
            fillColor: "transparent",
            strokeColor: "#C490E4",
            strokeWeight: 3,
            clickable: true
        });

        config.polygon = poly;

        naver.maps.Event.addListener(poly, "mouseover", () => {
            if (!overlay || !overlay.getMap())
                poly.setOptions({ fillColor: "#C490E4" });
        });

        naver.maps.Event.addListener(poly, "mouseout", () => {
            if (!overlay || !overlay.getMap())
                poly.setOptions({ fillColor: "transparent" });
        });

        naver.maps.Event.addListener(poly, "click", () => {
            floorControls.style.display = "flex";

            renderFloorButtons(id);
            showFloor(id, config.floors.includes("1f") ? "1f" : config.floors[0]);

            coordDisplay.textContent = "ì¼ë°˜ì§€ë„ë¡œ ëŒì•„ê°€ë ¤ë©´ ì‹¤ë‚´ì§€ë„ë¥¼ í´ë¦­í•˜ì„¸ìš”";
        });
    }


    /* -----------------------------
       ìœ„ì¹˜ ì°¾ê¸° ë²„íŠ¼
    ----------------------------- */
    geoBtn.onclick = () => {
        if (geoBtn.classList.contains("active")) {
            if (currentMarker) currentMarker.setMap(null);
            geoBtn.classList.remove("active");
            return;
        }

        navigator.geolocation?.getCurrentPosition(pos => {
            const latlng = new naver.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
            map.setCenter(latlng);

            if (currentMarker) currentMarker.setMap(null);

            currentMarker = new naver.maps.Marker({
                map,
                position: latlng,
                icon: {
                    content:
                      '<div style="width:12px;height:12px;background:#007bff;border-radius:50%;border:2px solid white;"></div>',
                    anchor: new naver.maps.Point(6, 6)
                }
            });

            geoBtn.classList.add("active");
        });
    };

    /* -----------------------------
       ğŸ”¥ i ë²„íŠ¼ íŒì—… ìœ„ì¹˜ ë³´ì •
    ----------------------------- */
    iBtn.onclick = () => {
        const isOpen = popup.style.display === "block";

        if (!isOpen) {
            const rect = iBtn.getBoundingClientRect();
            const winHeight = window.innerHeight;

            const bottom = (winHeight - rect.top) + 30;
            popup.style.bottom = bottom + "px";

            popup.style.display = "block";
            iBtn.classList.add("active");
        } else {
            popup.style.display = "none";
            iBtn.classList.remove("active");
        }
    };

    popupClose.onclick = () => {
        popup.style.display = "none";
        iBtn.classList.remove("active");
    };

};

document.head.appendChild(script);
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>네이버 벡터맵 테스트 (feat. 호랭이) - 실내 지도 (ver.2)</title>
    <style>
        body { margin: 0; padding: 0; height: 100vh; font-family: 'Malgun Gothic', sans-serif; }
        #map { width: 100%; height: 100%; }
        #status {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 99, 71, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        #labelToggleBtn {
            position: absolute;
            top: 10px;
            left: 170px;
            background: #4A90E2;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background 0.3s ease;
        }
        #labelToggleBtn:hover {
            background: #357ABD;
        }
        #coordDisplay {
            position: absolute;
            top: 50px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: #FFC107;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            min-width: 250px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="status">API 키 확인 중...</div>
    <button id="labelToggleBtn">라벨 숨기기</button>
    <div id="coordDisplay">지도를 클릭하면 좌표가 나와요!</div>
    <div id="map"></div>
    

    <script>
        const NCP_KEY_ID = 'q1d23mmkof';
        const SCRIPT_URL = `https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=${NCP_KEY_ID}&vmode=3`;

        const script = document.createElement('script');
        script.src = SCRIPT_URL;

        script.onload = function() {
            document.getElementById('status').textContent = 'API 로드 성공! 벡터 지도 초기화 중...';
            document.getElementById('status').style.background = 'rgba(60, 179, 113, 0.9)';

            const mapOptions = {
                center: new naver.maps.LatLng(37.570945, 126.97788), // 광화문 교보빌딩 중심으로!
                zoom: 18, // 확대해서 건물 잘 보이게!
                zoomControl: true,
                zoomControlOptions: {
                    position: naver.maps.Position.TOP_RIGHT
                },
                mapTypes: new naver.maps.MapTypeRegistry({
                    'normal': naver.maps.NaverStyleMapTypeOptions.getVectorMap()
                })
            };

            const map = new naver.maps.Map('map', mapOptions);
            map.setMapTypeId('normal');
            
            const labelLayer = new naver.maps.LabelLayer();
            labelLayer.setMap(map);

            document.getElementById('status').style.display = 'none';

            const labelToggleBtn = document.getElementById('labelToggleBtn');
            let isLabelVisible = true;

            labelToggleBtn.addEventListener('click', function() {
                if (isLabelVisible) {
                    labelLayer.setMap(null);
                    labelToggleBtn.textContent = '라벨 보이기';
                    isLabelVisible = false;
                    console.log("라벨 숨김!");
                } else {
                    labelLayer.setMap(map);
                    labelToggleBtn.textContent = '라벨 숨기기';
                    isLabelVisible = true;
                    console.log("라벨 보임!");
                }
            });

            // ⭐ 지도 클릭 시 좌표 표시 기능 (폴리곤 내 클릭 방지 로직 추가) ⭐
            naver.maps.Event.addListener(map, 'click', function(e) {
                // ⭐ 클릭된 지점이 kyoboBuildingPolygon 안에 있는지 확인 ⭐
                // e.overlay가 kyoboBuildingPolygon이거나, e.point가 kyoboBuildingPolygon 내부에 있으면 무시
                // GroundOverlay 클릭 시에도 무시
                if (e.overlay === kyoboBuildingPolygon || e.overlay === floorPlanOverlay || naver.maps.geometry.isPointInPolygon(e.latlng, kyoboBuildingPolygon.getPaths().getAt(0))) {
                    console.log("교보빌딩 폴리곤 내부 클릭! 좌표 표시 안 함.");
                    return; // 폴리곤 내부이거나 폴리곤 자체 클릭 시 좌표 표시 안 하고 종료
                }

                const lat = e.latlng.lat().toFixed(6);
                const lng = e.latlng.lng().toFixed(6);
                document.getElementById('coordDisplay').textContent = `위도: ${lat}, 경도: ${lng}`;
                console.log(`클릭된 좌표: 위도 ${lat}, 경도 ${lng}`);
            });

            // ==============================================================================
            // ⭐⭐⭐ 광화문 교보빌딩 실내 지도 기능 최종판! ⭐⭐⭐
            // ==============================================================================

            // 1. 광화문 교보빌딩 폴리곤 좌표 (시계 반대 방향)
            const kyoboBuildingCoords = [
                new naver.maps.LatLng(37.571348, 126.977671), // 좌상
                new naver.maps.LatLng(37.571354, 126.978059), // 우상
                new naver.maps.LatLng(37.570541, 126.978091), // 우하
                new naver.maps.LatLng(37.570538, 126.977698)  // 좌하
            ];

            // 폴리곤 객체 생성
            const kyoboBuildingPolygon = new naver.maps.Polygon({
                map: map,
                paths: [kyoboBuildingCoords],
                strokeColor: '#B388FF', // 연보라색 외곽선
                strokeOpacity: 1,
                strokeWeight: 3,
                fillColor: '#FFFFFF',
                fillOpacity: 0 // 초기에는 채우기 투명
            });

            // 폴리곤의 LatLngBounds 계산 (GroundOverlay를 위한 범위)
            // ⭐⭐⭐ minLng, maxLng 초기화 방식 수정! ⭐⭐⭐
            let minLat = kyoboBuildingCoords[0].lat(), maxLat = kyoboBuildingCoords[0].lat();
            let minLng = kyoboBuildingCoords[0].lng(), maxLng = kyoboBuildingCoords[0].lng();
            
            kyoboBuildingCoords.forEach(coord => {
                minLat = Math.min(minLat, coord.lat());
                maxLat = Math.max(maxLat, coord.lat());
                minLng = Math.min(minLng, coord.lng());
                maxLng = Math.max(maxLng, coord.lng());
            });
            const kyoboBounds = new naver.maps.LatLngBounds(
                new naver.maps.LatLng(minLat, minLng),
                new naver.maps.LatLng(maxLat, maxLng)
            );

            // 평면도 이미지 GroundOverlay 생성 (초기에는 숨겨둠)
            const floorPlanImageUrl = 'https://via.placeholder.com/600x400/B388FF/FFFFFF?text=Floor+Plan'; // 임의 이미지
            const floorPlanOverlay = new naver.maps.GroundOverlay(
                floorPlanImageUrl,
                kyoboBounds,
                { map: null } // 처음엔 지도에 보이지 않게 (map: null)
            );

            let isFloorPlanVisible = false; // 평면도가 보이는지 상태 관리

            // 2. 마우스 오버/아웃 효과
            naver.maps.Event.addListener(kyoboBuildingPolygon, 'mouseover', function() {
                if (!isFloorPlanVisible) { // 평면도가 보일 땐 호버 효과 무시
                    kyoboBuildingPolygon.setOptions({
                        fillColor: '#B388FF', // 보라색
                        fillOpacity: 0.4 // 반투명
                    });
                }
            });

            naver.maps.Event.addListener(kyoboBuildingPolygon, 'mouseout', function() {
                if (!isFloorPlanVisible) { // 평면도가 보일 땐 호버 효과 무시
                    kyoboBuildingPolygon.setOptions({
                        fillOpacity: 0 // 다시 투명
                    });
                }
            });

            // 3. 클릭 시 평면도 표시 & 4. 평면도 클릭 시 복귀
            // ⭐ 폴리곤 클릭 이벤트 ⭐
            naver.maps.Event.addListener(kyoboBuildingPolygon, 'click', function(e) {
                // 일반 지도 클릭 이벤트가 발생하지 않도록 전파 중단 (옵션)
                e.stop(); 
                if (isFloorPlanVisible) {
                    // 평면도가 보이는 상태에서 클릭하면 숨기기
                    floorPlanOverlay.setMap(null);
                    kyoboBuildingPolygon.setOptions({
                        fillOpacity: 0 // 폴리곤 채우기 다시 투명하게
                    });
                    isFloorPlanVisible = false;
                    console.log("평면도 숨기고 지도 복귀!");
                } else {
                    // 평면도가 안 보이는 상태에서 클릭하면 표시하기
                    floorPlanOverlay.setMap(map);
                    kyoboBuildingPolygon.setOptions({
                         fillColor: '#B388FF', // 보라색
                         fillOpacity: 0.6 // 평면도 활성화 시 폴리곤 색상 좀 더 진하게
                    });
                    isFloorPlanVisible = true;
                    console.log("평면도 표시!");
                    // 지도를 평면도 중심으로 이동하여 더 잘 보이게
                    map.setCenter(kyoboBounds.getCenter());
                    map.setZoom(19); // 좀 더 확대
                }
            });

            // ⭐ GroundOverlay 자체를 클릭해도 원복되도록 이벤트 추가 ⭐
            naver.maps.Event.addListener(floorPlanOverlay, 'click', function(e) {
                e.stop(); // GroundOverlay 클릭 시 map 클릭 이벤트가 발생하지 않도록 전파 중단
                floorPlanOverlay.setMap(null);
                kyoboBuildingPolygon.setOptions({
                    fillOpacity: 0
                });
                isFloorPlanVisible = false;
                console.log("평면도 클릭하여 숨김!");
            });


            console.log("광화문 교보빌딩 실내 지도 기능이 최종 구현되었습니다.");
        };

        script.onerror = function() {
            document.getElementById('status').textContent = 'API 로드 실패! 네이버 Key ID 또는 웹 서비스 URL을 확인해주세요. ㅠㅠ';
            document.getElementById('status').style.background = 'red';
            console.error("네이버 지도 API 로드 실패!");
        };
        document.head.appendChild(script);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë„¤ì´ë²„ ë²¡í„°ë§µ - ë¬´ì¥ì•  ì‹œì„¤ì •ë³´ í†µí•©</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { margin: 0; padding: 0; height: 100vh; font-family: 'Malgun Gothic', sans-serif; }
        #map { width: 100%; height: 100%; }

        /* ìƒíƒœ ë° ì¢Œí‘œ í‘œì‹œ ìŠ¤íƒ€ì¼ (ê¸°ì¡´ ë„¤ì´ë²„ ì½”ë“œ ìœ ì§€) */
        #status {
            position: absolute; top: 10px; left: 10px; background: rgba(255, 99, 71, 0.9); color: white; padding: 10px 15px; border-radius: 5px; font-size: 14px; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        #coordDisplay {
            position: absolute; top: 50px; left: 10px; background: rgba(0, 0, 0, 0.7); color: #FFC107; padding: 10px 15px; border-radius: 5px; font-size: 14px; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2); min-width: 250px; text-align: center;
        }

        /* â­ ë¬´ì¥ì•  ì •ë³´ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ (ì™¼ìª½ ìƒë‹¨ - êµ¬ê¸€ ì½”ë“œ ê¸°ë°˜) â­ */
        #accessibility-button-container {
            position: absolute;
            top: 10px; 
            left: 10px; /* statusì™€ ìœ„ì¹˜ ì¶©ëŒ í”¼í•˜ê¸° ìœ„í•´ ì¡°ì • */
            z-index: 999;
            display: none; 
        }
        
        /* ë¬´ì¥ì•  ì •ë³´ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        #accessibility-button {
            background-color: white;
            border: 1px solid #ccc; 
            border-radius: 3px;     
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            padding: 8px 12px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            color: #4285F4; 
            transition: background-color 0.1s, color 0.1s;
        }
        #accessibility-button.active {
            background-color: #4285F4;
            color: white; 
            border-color: #4285F4; 
        }

        /* ë¬´ì¥ì•  ì •ë³´ íŒì—…ì°½ */
        #accessibility-popup {
            position: absolute;
            top: 55px; 
            left: 10px; 
            z-index: 1000; 
            width: 300px;
            max-width: calc(100% - 20px); 
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
            display: none; 
            padding: 15px; 
            box-sizing: border-box;
        }
        
        #popup-close-btn {
            position: absolute;
            top: 10px;
            right: 15px; 
            font-size: 24px;
            cursor: pointer;
            color: #777;
            font-weight: 300;
            line-height: 1;
        }
        
        /* ë¬´ì¥ì•  ì‹œì„¤ ì •ë³´ ë‚´ë¶€ ìŠ¤íƒ€ì¼ */
        .accessibility-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 15px;
            color: #1e3a8a;
        }
        .accessibility-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: 1rem;
        }
        .accessibility-item i {
            width: 24px;
            text-align: center;
            margin-right: 10px;
            color: #2563eb;
        }
        .accessibility-status {
            margin-left: auto;
            font-weight: 600;
        }
        .status-yes {
            color: #10b981;
        }
        .status-no {
            color: #ef4444;
        }
    </style>
</head>
<body>
    <div id="status">API í‚¤ í™•ì¸ ì¤‘...</div>
    <div id="coordDisplay">ì§€ë„ë¥¼ í´ë¦­í•˜ë©´ ì¢Œí‘œê°€ ë‚˜ì™€ìš”!</div>
    <div id="map"></div>
    
    <div id="accessibility-button-container">
        <button id="accessibility-button">ë¬´ì¥ì•  ì‹œì„¤ì •ë³´</button>
    </div>

    <div id="accessibility-popup">
        <span id="popup-close-btn">Ã—</span>
        <div id="popup-content">
            </div>
    </div>

    <script>
        const NCP_KEY_ID = 'q1d23mmkof';
        
        // â­ ê±´ë¬¼ ë°ì´í„° í†µí•© (ê°„ì†Œí™”: êµë³´ë¹Œë”© ì •ë³´ë§Œ ì‚¬ìš©) â­
        const BUILDING_CONFIGS = {
            'KYOBOCENTER': {
                name: 'êµë³´ë¹Œë”©',
                accessibility: { ramp: true, disabledToilet: true, braille: true, elevator: true, stepFree: false },
                floorInfo: {
                    imageUrl: 'https://raw.githubusercontent.com/candream99/disabledmap/main/kb/ky_1.jpg',
                    imageBounds: { north: 37.571365, south: 37.570535, west: 126.977631, east: 126.978099 }
                }
            }
        };

        let map;
        let groundOverlay = null;
        let labelLayer;
        let polygon; 

        // â­ ë¬´ì¥ì•  ì‹œì„¤ ê´€ë ¨ DOM ì°¸ì¡° â­
        let accessButton;
        let accessPopup;
        let accessBtnContainer;
        let popupContent;

        // === í—¬í¼ í•¨ìˆ˜ ===
        
        // â­ êµ¬ê¸€ ì½”ë“œì—ì„œ ê°€ì ¸ì˜¨ HTML ìƒì„± í•¨ìˆ˜ â­
        function generateAccessibilityHTML(data) {
            const getStatus = (key) => ({
                text: data[key] ? 'ìˆìŒ' : 'ì—†ìŒ',
                class: data[key] ? 'status-yes' : 'status-no'
            });
            // ë‹¨ì°¨ëŠ” true(ë‹¨ì°¨ ì—†ìŒ)ì¼ ë•Œ 'ì—†ìŒ'ìœ¼ë¡œ í‘œì‹œí•´ì•¼ í•¨.
            const stepFreeText = data.stepFree ? 'ì—†ìŒ' : 'ìˆìŒ';
            const stepFreeClass = data.stepFree ? 'status-yes' : 'status-no';

            return `
                <div class="accessibility-info">
                    <div class="accessibility-title">ë¬´ì¥ì•  ì‹œì„¤ ì •ë³´</div>
                    <div class="accessibility-item">
                        <i class="fas fa-wheelchair"></i>
                        <span>ì£¼ì¶œì…êµ¬ ê²½ì‚¬ë¡œ</span>
                        <span class="accessibility-status ${getStatus('ramp').class}">${getStatus('ramp').text}</span>
                    </div>
                    <div class="accessibility-item">
                        <i class="fas fa-restroom"></i>
                        <span>ì¥ì• ì¸ í™”ì¥ì‹¤</span>
                        <span class="accessibility-status ${getStatus('disabledToilet').class}">${getStatus('disabledToilet').text}</span>
                    </div>
                    <div class="accessibility-item">
                        <i class="fas fa-braille"></i>
                        <span>ì ìë¸”ë¡</span>
                        <span class="accessibility-status ${getStatus('braille').class}">${getStatus('braille').text}</span>
                    </div>
                    <div class="accessibility-item">
                        <i class="fas fa-elevator"></i>
                        <span>ì—˜ë¦¬ë² ì´í„°</span>
                        <span class="accessibility-status ${getStatus('elevator').class}">${getStatus('elevator').text}</span>
                    </div>
                    <div class="accessibility-item">
                        <i class="fas fa-accessible-icon"></i>
                        <span>ì£¼ì¶œì…êµ¬ ë‹¨ì°¨</span>
                        <span class="accessibility-status ${stepFreeClass}">${stepFreeText}</span>
                    </div>
                </div>
            `;
        }
        
        // â­ ë¬´ì¥ì•  ë²„íŠ¼ í™œì„±í™” ìƒíƒœ í† ê¸€ í•¨ìˆ˜ â­
        function toggleAccessibilityButtonState(isActive) {
            if (accessButton) {
                if (isActive) {
                    accessButton.classList.add('active');
                } else {
                    accessButton.classList.remove('active');
                }
            }
        }

        // â­ GroundOverlay í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ (ì‹¤ë‚´ ëª¨ë“œ ì¢…ë£Œ) í•¨ìˆ˜ ì •ì˜ â­
        function setupGroundOverlayClickListener(gOverlay) {
            naver.maps.Event.addListener(gOverlay, 'click', function(e) {
                e.stopOverlays = true; 
                
                // ì‹¤ë‚´ ëª¨ë“œ ì¢…ë£Œ
                gOverlay.setMap(null); 
                groundOverlay = null; 
                labelLayer.setMap(map);
                
                // â­ ë¬´ì¥ì•  ë²„íŠ¼ ë° íŒì—… ìˆ¨ê¹€ â­
                accessBtnContainer.style.display = 'none';
                accessPopup.style.display = 'none';
                toggleAccessibilityButtonState(false);

                polygon.setOptions({
                    fillColor: 'transparent' 
                });
                document.getElementById('coordDisplay').textContent = 'ì§€ë„ë¥¼ í´ë¦­í•˜ë©´ ì¢Œí‘œê°€ ë‚˜ì™€ìš”!';
                console.log("í‰ë©´ë„ í´ë¦­: ì‹¤ë‚´ ëª¨ë“œ ì¢…ë£Œ. ì§€ë„ ë¼ë²¨ ë³µêµ¬.");
            });
        }

        // â­ ì‹¤ë‚´ ëª¨ë“œ ì§„ì…/ì¸µ ë³€ê²½ í•¨ìˆ˜ (GroundOverlayë¥¼ ìƒˆë¡œ ìƒì„±) â­
        function showIndoorMode() {
            const buildingId = 'KYOBOCENTER'; // í˜„ì¬ëŠ” ë‹¨ì¼ ê±´ë¬¼
            const config = BUILDING_CONFIGS[buildingId];

            // 1. ì´ì „ GroundOverlayê°€ ìˆë‹¤ë©´ ì œê±°
            if (groundOverlay) {
                groundOverlay.setMap(null); 
                groundOverlay = null;
            }

            // 2. ì´ë¯¸ì§€ ê²½ê³„ ì„¤ì • (Naver Maps í˜•ì‹ì— ë§ê²Œ LatLngBounds ìƒì„±)
            const bounds = config.floorInfo.imageBounds;
            const swLatLng = new naver.maps.LatLng(bounds.south, bounds.west);
            const neLatLng = new naver.maps.LatLng(bounds.north, bounds.east);
            const imageBounds = new naver.maps.LatLngBounds(swLatLng, neLatLng);

            // 3. ìƒˆ GroundOverlay ìƒì„± ë° ì§€ë„ì— ë°”ë¡œ í‘œì‹œ
            groundOverlay = new naver.maps.GroundOverlay(
                config.floorInfo.imageUrl, 
                imageBounds,          
                {
                    map: map,
                    clickable: true, 
                    opacity: 1
                }
            );
            
            // 4. ìƒˆ ê°ì²´ì— í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
            setupGroundOverlayClickListener(groundOverlay);
            
            // 5. ë¬´ì¥ì•  ì •ë³´ ì—…ë°ì´íŠ¸
            popupContent.innerHTML = generateAccessibilityHTML(config.accessibility);


            document.getElementById('coordDisplay').textContent = 'ğŸ¢ ì‹¤ë‚´ ëª¨ë“œ í™œì„±í™”. ì´ë¯¸ì§€ë¥¼ í´ë¦­í•˜ë©´ ì¼ë°˜ ì§€ë„ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.';
            console.log("ì‹¤ë‚´ ëª¨ë“œ í™œì„±í™” ë° í‰ë©´ë„ í‘œì‹œ.");
        }


        // === ì§€ë„ ì´ˆê¸°í™” ë©”ì¸ í•¨ìˆ˜ ===

        const script = document.createElement('script');
        script.src = `https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=${NCP_KEY_ID}&vmode=3`;
        
        script.onload = function() {
            document.getElementById('status').textContent = 'API ë¡œë“œ ì„±ê³µ!\në²¡í„° ì§€ë„ ì´ˆê¸°í™” ì¤‘...'; 
            document.getElementById('status').style.background = 'rgba(60, 179, 113, 0.9)';
            
            // 1. ì§€ë„ ì´ˆê¸° ì˜µì…˜ ì„¤ì • ë° ìƒì„±
            const mapOptions = {
                center: new naver.maps.LatLng(37.570946, 126.97788),
                zoom: 18,
                zoomControl: true,
                zoomControlOptions: {
                    position: naver.maps.Position.TOP_RIGHT
                },
                mapTypes: new naver.maps.MapTypeRegistry({
                    'normal': naver.maps.NaverStyleMapTypeOptions.getVectorMap()
                })
            };
            map = new naver.maps.Map('map', mapOptions);
            map.setMapTypeId('normal');

            // 2. ë¼ë²¨ ë ˆì´ì–´ ì„¤ì • 
            labelLayer = new naver.maps.LabelLayer();
            labelLayer.setMap(map);

            document.getElementById('status').style.display = 'none';

            // â­ 3. DOM ìš”ì†Œ ì°¸ì¡° ë° ì´ë²¤íŠ¸ ì—°ê²° (ë¬´ì¥ì•  ë²„íŠ¼) â­
            accessButton = document.getElementById('accessibility-button');
            accessPopup = document.getElementById('accessibility-popup');
            accessBtnContainer = document.getElementById('accessibility-button-container');
            popupContent = document.getElementById('popup-content');
            const closeBtn = document.getElementById('popup-close-btn');

            // íŒì—… ì´ë²¤íŠ¸ ì„¤ì •
            accessButton.onclick = () => { 
                const isPopupVisible = accessPopup.style.display === 'block';
                if (isPopupVisible) {
                    accessPopup.style.display = 'none';
                    toggleAccessibilityButtonState(false);
                } else {
                    accessPopup.style.display = 'block';
                    toggleAccessibilityButtonState(true);
                }
            };
            closeBtn.onclick = () => { 
                accessPopup.style.display = 'none';
                toggleAccessibilityButtonState(false); 
            };
            
            // 4. ë‹¤ê°í˜•(Polygon) ê¸°ëŠ¥
            const polygonCoords = [
                new naver.maps.LatLng(37.571348, 126.977671),
                new naver.maps.LatLng(37.571354, 126.978059),
                new naver.maps.LatLng(37.570541, 126.978091),
                new naver.maps.LatLng(37.570538, 126.977698)
            ];
            polygon = new naver.maps.Polygon({
                map: map, paths: [polygonCoords], fillColor: 'transparent', fillOpacity: 0.5,
                strokeColor: '#C490E4', strokeOpacity: 1, strokeWeight: 3, clickable: true 
            });
            
            // ë§ˆìš°ìŠ¤ ì˜¤ë²„(Hover) íš¨ê³¼
            naver.maps.Event.addListener(polygon, 'mouseover', function() {
                polygon.setOptions({ fillColor: '#C490E4' });
                document.getElementById('coordDisplay').textContent = 'ì—¬ê¸°ëŠ” ë‹¤ê°í˜• ë‚´ë¶€ì…ë‹ˆë‹¤! (ë§ˆìš°ìŠ¤ ì˜¤ë²„)';
            });

            // ë§ˆìš°ìŠ¤ ì•„ì›ƒ ì‹œ
            naver.maps.Event.addListener(polygon, 'mouseout', function() {
                if (groundOverlay === null) {
                    polygon.setOptions({ fillColor: 'transparent' });
                    document.getElementById('coordDisplay').textContent = 'ì§€ë„ë¥¼ í´ë¦­í•˜ë©´ ì¢Œí‘œê°€ ë‚˜ì™€ìš”!';
                }
            });


            // ë‹¤ê°í˜•(Polygon) í´ë¦­ ì´ë²¤íŠ¸: ì‹¤ë‚´ ëª¨ë“œ ì§„ì…
            naver.maps.Event.addListener(polygon, 'click', function(e) {
                e.stopOverlays = true; 

                // ì‹¤ë‚´ ëª¨ë“œ ì‹œì‘
                labelLayer.setMap(null); 
                
                // â­ ë¬´ì¥ì•  ë²„íŠ¼ í‘œì‹œ â­
                accessBtnContainer.style.display = 'block'; 

                polygon.setOptions({ fillColor: '#C490E4' });
                
                // ì‹¤ë‚´ ëª¨ë“œ ì§„ì… ì‹œ GroundOverlay í‘œì‹œ
                showIndoorMode(); 

                console.log("ë‹¤ê°í˜• ë‚´ë¶€ í´ë¦­: ì‹¤ë‚´ ëª¨ë“œ ì§„ì…. ì§€ë„ ë¼ë²¨ ìˆ¨ê¹€.");
            });

            // â­ ì§€ë„ í´ë¦­ ì´ë²¤íŠ¸ (ë‹¤ê°í˜• ë°–ì„ í´ë¦­í–ˆì„ ë•Œë§Œ ì‘ë™)
            naver.maps.Event.addListener(map, 'click', function(e) {
                // groundOverlayê°€ nullì¼ ë•Œ (ì‹¤ë‚´ ëª¨ë“œê°€ ì•„ë‹ ë•Œ)ë§Œ ì¢Œí‘œ í‘œì‹œ ê¸°ëŠ¥ ì‹¤í–‰
                if (groundOverlay === null) { 
                    const lat = e.latlng.lat().toFixed(6);
                    const lng = e.latlng.lng().toFixed(6);
                    document.getElementById('coordDisplay').textContent = `ìœ„ë„: ${lat}, ê²½ë„: ${lng}`;
                    console.log(`í´ë¦­ëœ ì¢Œí‘œ: ìœ„ë„ ${lat}, ê²½ë„ ${lng}`);
                } else {
                    console.log("ì‹¤ë‚´ ëª¨ë“œ ì¤‘: ì§€ë„ í´ë¦­ ë¬´ì‹œë¨.");
                }
            });

            console.log("ë„¤ì´ë²„ ë²¡í„°ë§µ ë¡œë“œ ë° ì´ˆê¸°í™” ì„±ê³µ! ëª¨ë“  ê¸°ëŠ¥ í†µí•© ì™„ë£Œ.");
        };
        
        script.onerror = function() {
            document.getElementById('status').textContent = 'API ë¡œë“œ ì‹¤íŒ¨!\në„¤ì´ë²„ Key ID ë˜ëŠ” ì›¹ ì„œë¹„ìŠ¤ URLì„ í™•ì¸í•´ì£¼ì„¸ìš”. ã… ã… ';
            document.getElementById('status').style.background = 'red';
            console.error("ë„¤ì´ë²„ ì§€ë„ API ë¡œë“œ ì‹¤íŒ¨!");
        };
        document.head.appendChild(script);
    </script>
</body>
</html>

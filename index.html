<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë„¤ì´ë²„ ë²¡í„°ë§µ í…ŒìŠ¤íŠ¸ - ë¬´ì¥ì•  ì‹œì„¤ íŒì—… ìµœì¢…ë³¸ (ì™„ì „ ë³µêµ¬)</title>
    <style>
        /* ------------------------------------------------ */
        /* ê¸°ë³¸/ê³µí†µ ìŠ¤íƒ€ì¼ */
        /* ------------------------------------------------ */
        body { 
            margin: 0;
            padding: 0; 
            height: 100vh;
            font-family: 'Malgun Gothic', sans-serif;
            overflow: hidden; 
        }
        #map { width: 100%; height: 100%; }

        /* ê²€ìƒ‰ì°½ ìŠ¤íƒ€ì¼ */
        #searchBox {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 80vw; 
            max-width: 500px; 
            height: 48px;
            background: #ffffff;
            border-radius: 24px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            padding: 0 15px; 
            z-index: 2000;
        }
        
        /* coordDisplay ìŠ¤íƒ€ì¼ (ê³µí†µ) */
        #coordDisplay {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 80vw;
            max-width: 500px;
            height: 24px;
            background: rgba(255, 255, 255, 0.9);
            color: #000000;
            border-radius: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0 15px; 
            font-size: 14px;
            z-index: 1500;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2); 
            transition: all 0.3s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: unset; 
        }

        /* ê³µí†µ ì›í˜• ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .map-btn-circle {
            width: 40px;
            height: 40px;
            padding: 0;
            cursor: pointer;
            background: #ffffff;
            border: none; 
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            color: #000;
            font-weight: normal;
            font-size: 14px;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            line-height: 1;
        }
        
        /* ì¸µ ë²„íŠ¼/ì•¡ì„¸ìŠ¤ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ê³µí†µ ì›í˜• ìŠ¤íƒ€ì¼ ìƒì†) */
        .floor-btn {
            font-size: 14px;
        }
        
        /* ë¬´ì¥ì•  ì‹œì„¤ íŒì—… ìŠ¤íƒ€ì¼ */
        #accessPopup {
            position: absolute;
            background: #fff;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            width: 90%; 
            max-width: 300px;
            box-sizing: border-box; 
        }

        /* ------------------------------------------------ */
        /* ğŸ–¥ï¸ ë°ìŠ¤í¬í†± ìŠ¤íƒ€ì¼ (769px ì´ìƒ) - ë²„íŠ¼ ìœ„ì¹˜ ìš°ì¸¡ìœ¼ë¡œ ë³€ê²½ */
        /* ------------------------------------------------ */
        @media screen and (min-width: 769px) {
            
            /* í˜„ì¬ ìœ„ì¹˜ ë²„íŠ¼ ìœ„ì¹˜ ë³€ê²½ (ìš°ì¸¡ í•˜ë‹¨) */
            #geolocationBtn {
                position: absolute; /* ì ˆëŒ€ ìœ„ì¹˜ ì§€ì • */
                bottom: 30px; 
                right: 30px;
                left: auto;
            }

            /* ì¸µ ì»¨íŠ¸ë¡¤ ì»¨í…Œì´ë„ˆ ìœ„ì¹˜ ë³€ê²½ (ìš°ì¸¡ í•˜ë‹¨ ìœ„) */
            #floorControls {
                position: absolute; /* ì ˆëŒ€ ìœ„ì¹˜ ì§€ì • */
                bottom: 80px; 
                right: 30px;
                left: auto;
                flex-direction: column-reverse;
            }
            
            /* ë¬´ì¥ì•  íŒì—… ìŠ¤íƒ€ì¼ ìˆ˜ì • (ìš°ì¸¡ ì •ë ¬) */
            #accessPopup {
                right: 80px;
                left: auto;
                max-width: 300px;
            }
        }

        /* ------------------------------------------------ */
        /* ğŸ“± ëª¨ë°”ì¼ ìŠ¤íƒ€ì¼ (768px ì´í•˜) - ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
        /* ------------------------------------------------ */
        @media screen and (max-width: 768px) {
            
            /* coordDisplay ì¼ë°˜ ëª¨ë“œ ìœ„ì¹˜ (searchBox ì•„ë˜) */
            #coordDisplay.outdoor-mode-coord {
                top: 78px;
            }

            /* í˜„ì¬ ìœ„ì¹˜ ë²„íŠ¼ ìœ„ì¹˜ ìœ ì§€ (ì¢Œì¸¡ í•˜ë‹¨) */
            #geolocationBtn {
                position: absolute;
                bottom: 18px;
                left: 10px;
                z-index: 1500;
            }

            /* ì¸µ ì»¨íŠ¸ë¡¤ ì»¨í…Œì´ë„ˆ ìœ„ì¹˜ ìœ ì§€ (ì¢Œì¸¡ í•˜ë‹¨ ìœ„) */
            #floorControls {
                position: absolute;
                bottom: 88px;
                left: 10px;
                flex-direction: column-reverse;
            }
            
            /* ë¬´ì¥ì•  íŒì—… ìŠ¤íƒ€ì¼ ìœ ì§€ (JSì—ì„œ ì™¼ìª½ ìœ„ì¹˜ ê³„ì‚°, í•˜ë‹¨ ê³ ì •) */
            #accessPopup {
                bottom: 20px; /* ëª¨ë°”ì¼ì—ì„œ í•˜ë‹¨ ê³ ì • */
                top: auto;
                left: auto; 
                width: 90%;
                max-width: 240px;
            }
        }
        
        /* ê¸°íƒ€ UI ìŠ¤íƒ€ì¼ */
        #floorControls {
            display: none;
            gap: 8px;
            z-index: 1500;
            background: transparent;
            padding: 0;
            box-shadow: none;
        }
        #accessInfoBtn {
            margin-bottom: 18px;
            font-size: 0;
            line-height: 0; 
        }
        /* ... ê¸°íƒ€ ìƒì„¸ ìŠ¤íƒ€ì¼ì€ ì›ë³¸ê³¼ ë™ì¼ ... */
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div id="searchBox">
        <button id="hamburgerBtn" title="ë©”ë‰´">
            <span class="burger-line"></span>
            <span class="burger-line"></span>
            <span class="burger-line"></span>
        </button>
        <div id="searchPlaceholder">ê±´ë¬¼ì´ë¦„ì„ ê²€ìƒ‰í•˜ì„¸ìš”</div>
    </div>
    
    <div id="coordDisplay" 
class="outdoor-mode-coord">ê±´ë¬¼ì„ 
 í´ë¦­í•˜ë©´ ì‹¤ë‚´ì§€ë„ë¥¼ ë³¼ ìˆ˜ ìˆì–´ìš”</div>
    
 
    <button id="geolocationBtn" class="map-btn-circle" title="í˜„ì¬ ìœ„ì¹˜ ì°¾ê¸°"><span class="geo-icon"></span></button>
    
    <div id="floorControls">
        <button id="accessInfoBtn" class="floor-btn map-btn-circle" data-floor="access" title="ë¬´ì¥ì•  ì‹œì„¤ ì •ë³´"><span class="i-icon"></span></button>
    </div>

    <div id="accessPopup" style="display:none;">
        <span id="accessPopupClose" style="position:absolute; top:6px; right:10px; font-size:22px; cursor:pointer;
color:#777;">Ã—</span>
        
        <div id="accessPopupBody">
            <div id="buildingInfoSection" class="popup-section">
                </div>
            
            <div id="accessFacilitySection" class="popup-section">
                </div>
        </div>
    </div>

    <script>
        
        var NCP_KEY_ID = 'q1d23mmkof';
        var script = document.createElement('script');
        script.src = 'https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=' + NCP_KEY_ID + '&vmode=3';

        script.onload = function () {
            // ğŸš¨ ë³€ìˆ˜ ì„ ì–¸: ëª¨ë‘ varë¡œ ë³€ê²½í•˜ì—¬ í˜¸í™˜ì„± í™•ë³´
            var mapContainer = document.getElementById('map');
            var searchBox = document.getElementById('searchBox');
            var coordDisplay = document.getElementById('coordDisplay');
            var floorControlsContainer = document.getElementById('floorControls');
            var popup = document.getElementById('accessPopup');
            var buildingInfoSection = document.getElementById('buildingInfoSection');
            var accessFacilitySection = document.getElementById('accessFacilitySection');
            var accessBtn = document.getElementById('accessInfoBtn');
            var popupClose = document.getElementById('accessPopupClose');
            var geolocationBtn = document.getElementById('geolocationBtn');
            
            var groundOverlay = null;
            var currentBuildingId = null;
            var currentPositionMarker = null;
            
            // ---------------------------------------------------------
            // í™˜ê²½ ê°ì§€ í•¨ìˆ˜
            // ---------------------------------------------------------
            function isMobile() {
                var width = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
                return width <= 768;
            }


            // =========================================================
            // ë¹Œë”©ë³„ ë°ì´í„° ì •ì˜ (ë°ì´í„° ë³€í™” ì—†ìŒ)
            // =========================================================
            var buildings = {
                'ky': { 
                    polygonCoords: [
                        new naver.maps.LatLng(37.571350, 126.977670),
                        new naver.maps.LatLng(37.571360, 126.978059),
                        new naver.maps.LatLng(37.571275, 126.978063),
                        new naver.maps.LatLng(37.571275, 126.978173),
                        new naver.maps.LatLng(37.570870, 126.978184),
                        new naver.maps.LatLng(37.570872, 126.978082),
                        new naver.maps.LatLng(37.570543, 126.978094),
                        new naver.maps.LatLng(37.570539, 126.977702),
                    ],
                    floors: ['b1', '1f', '2f'],
                    images: {
                        'b1': 'https://raw.githubusercontent.com/candream99/disabledmap/main/kb/ky_1.jpg',
                        '1f': 'https://raw.githubusercontent.com/candream99/disabledmap/main/kb/ky11.png', 
                        '2f': 'https://raw.githubusercontent.com/candream99/disabledmap/main/kb/ky_1.jpg',
                    },
                    imageBounds: new naver.maps.LatLngBounds(
                        new naver.maps.LatLng(37.570512, 126.977632), 
                        new naver.maps.LatLng(37.571415, 126.978244) 
                    ),
                    currentFloor: '1f', 
                    polygon: null,
                    accessInfo: {
                        'ì£¼ì¶œì…êµ¬ ê²½ì‚¬ë¡œ': true,
                        'ì¥ì• ì¸ í™”ì¥ì‹¤': true,
                        'ì§•ì• ì¸ ì£¼ì°¨ì¥': true,
                        'ì—˜ë¦¬ë² ì´í„°': true,
                        'ì£¼ì¶œì…êµ¬ ë‹¨ì°¨': false
                    },
                    buildingInfo: {
                        name: 'êµë³´ë¹Œë”©',
                        image_url: 'https://raw.githubusercontent.com/candream99/disabledmap/main/kb/kyobo_gwanghwamun.jpg', 
                        address: 'ì„œìš¸ ì¢…ë¡œêµ¬ ìƒˆë¬¸ì•ˆë¡œ 45',
                        operating_hours: '09:00 - 18:00 (ì›”ìš”ì¼ íœ´ë¬´)'
                    }
                },
                'dt': {
                    polygonCoords: [
                        new naver.maps.LatLng(37.571470, 126.978762),
                        new naver.maps.LatLng(37.571476, 126.979161),
                        new naver.maps.LatLng(37.570627, 126.979181),
                        new naver.maps.LatLng(37.570557, 126.979117),
                        new naver.maps.LatLng(37.570553, 126.978777),
                    ],
                    floors: ['b4', '1f'], 
                    images: {
                        'b4': 'https://raw.githubusercontent.com/candream99/disabledmap/main/dt/dt_b4.png',
                        '1f': 'https://raw.githubusercontent.com/candream99/disabledmap/main/dt/dt1.png',
                    },
                    imageBounds: new naver.maps.LatLngBounds(
                        new naver.maps.LatLng(37.570459, 126.978649), 
                        new naver.maps.LatLng(37.571626, 126.979210) 
                    ),
                    currentFloor: '1f',
                    polygon: null,
                    accessInfo: {
                        'ì£¼ì¶œì…êµ¬ ê²½ì‚¬ë¡œ': false,
                        'ì¥ì• ì¸ í™”ì¥ì‹¤': true, 
                        'ì¥ì• ì¸ ì£¼ì°¨ì¥': false,
                        'ì—˜ë¦¬ë² ì´í„°': true,
                        'ì£¼ì¶œì…êµ¬ ë‹¨ì°¨': true 
                    },
                    buildingInfo: {
                        name: 'ê´‘í™”ë¬¸ Díƒ€ì›Œ',
                        image_url: 'https://raw.githubusercontent.com/candream99/disabledmap/main/dt/d_tower.jpg', 
                        address: 'ì„œìš¸ ì¢…ë¡œêµ¬ ì†¡ì›”ê¸¸ 2',
                        operating_hours: '10:00 - 19:00 (ë§¤ì¼ ìš´ì˜)'
                    }
                }
            };
            // =========================================================
            // ì§€ë„ ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            // =========================================================
            
            var mapOptions = {
                center: new naver.maps.LatLng(37.5710, 126.9784),
                zoom: 17, 
                zoomControl: false, 
                scrollWheelZoom: false,
                pinchZoom: true,
                mapTypes: new naver.maps.MapTypeRegistry({
                    normal: naver.maps.NaverStyleMapTypeOptions.getVectorMap(),
                }),
            };
            
            var map = new naver.maps.Map('map', mapOptions);
            map.setMapTypeId('normal');
            var labelLayer = new naver.maps.LabelLayer();
            labelLayer.setMap(map);

            // ë§ˆìš°ìŠ¤ íœ  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ë°ìŠ¤í¬í†± ì „ìš© ê¸°ëŠ¥)
            if (!isMobile()) {
                var ZOOM_STEP = 0.1;
                mapContainer.addEventListener("wheel", function (e) {
                    e.preventDefault();

                    var currentZoom = map.getZoom();
                    var newZoom = currentZoom;

                    if (e.deltaY < 0) newZoom += ZOOM_STEP;
                    else newZoom -= ZOOM_STEP;

                    newZoom = Math.round(newZoom * 100) / 100;
                    newZoom = Math.min(Math.max(newZoom, 1), 21);

                    map.setZoom(newZoom);
                }, false); // passive: false ëŒ€ì‹  false ì‚¬ìš© (í˜¸í™˜ì„±)
            }
            
            // ëª¨ë°”ì¼ í„°ì¹˜ ì´ë²¤íŠ¸ ë²„ë¸”ë§/ìŠ¤í¬ë¡¤ ë°©ì§€ (ëª¨ë°”ì¼ ì „ìš© ê¸°ëŠ¥)
            if (isMobile()) {
                function preventTouchMove(elementId) {
                    var element = document.getElementById(elementId);
                    if (element) {
                        element.addEventListener('touchmove', function(e) {
                            e.preventDefault();
                        }, false); // passive: false ëŒ€ì‹  false ì‚¬ìš© (í˜¸í™˜ì„±)
                    }
                }
                preventTouchMove('searchBox');
                preventTouchMove('floorControls');
            }

            // =========================================================
            // ğŸš¨ ëˆ„ë½ëœ í•µì‹¬ ê¸°ëŠ¥ í•¨ìˆ˜ (ë³µêµ¬) ğŸš¨
            // =========================================================
            
            /** ì¸µ ë²„íŠ¼ ë Œë”ë§ */
            function renderFloorButtons(buildingId) {
                var config = buildings[buildingId];
                var floors = config.floors;
                var floorControlsHTML = '';
                
                // accessInfoBtnì´ ê°€ì¥ ì•„ë˜(CSS flex-direction: column-reverse ë•Œë¬¸ì—) ìœ„ì¹˜í•˜ë„ë¡ ë¨¼ì € HTML ì¶”ê°€
                floorControlsHTML += '<button id="accessInfoBtn" class="floor-btn map-btn-circle" data-floor="access" title="ë¬´ì¥ì•  ì‹œì„¤ ì •ë³´"><span class="i-icon"></span></button>';

                for (var i = 0; i < floors.length; i++) {
                    var floor = floors[i];
                    var isActive = (floor === config.currentFloor) ? ' active' : '';
                    floorControlsHTML += 
                        '<button class="floor-btn map-btn-circle' + isActive + '" data-floor="' + floor + '">' + 
                        floor.toUpperCase() + 
                        '</button>';
                }
                
                floorControlsContainer.innerHTML = floorControlsHTML;
                
                // ìƒˆë¡œ ìƒì„±ëœ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë‹¤ì‹œ ì—°ê²°
                var floorButtons = floorControlsContainer.querySelectorAll('.floor-btn');
                for (var j = 0; j < floorButtons.length; j++) {
                    floorButtons[j].addEventListener('click', function() {
                        var floorId = this.getAttribute('data-floor');
                        if (floorId === 'access') {
                            // ë¬´ì¥ì•  ì •ë³´ ë²„íŠ¼ ì¬ì„¤ì •
                            accessBtn = this;
                            accessBtn.click(); // ë²„íŠ¼ í´ë¦­ ë¡œì§ ì¬í™œìš©
                        } else {
                            showFloor(floorId, buildingId);
                        }
                    });
                }
                
                // accessBtn ë³€ìˆ˜ ì—…ë°ì´íŠ¸ (ìƒˆë¡œ ìƒì„±ëœ 'access' ë²„íŠ¼ìœ¼ë¡œ)
                accessBtn = document.getElementById('accessInfoBtn');
            }
            
            /** íŠ¹ì • ì¸µì˜ ì‹¤ë‚´ ì§€ë„ë¥¼ í‘œì‹œ */
            function showFloor(floorId, buildingId) {
                if (floorId === 'access') return; // 'i' ë²„íŠ¼ì€ ì—¬ê¸°ì„œ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
                
                var config = buildings[buildingId];
                if (config.currentFloor === floorId) return; // ê°™ì€ ì¸µ í´ë¦­ ì‹œ ë¬´ì‹œ
                
                // ì´ë¯¸ì§€ URL ê°€ì ¸ì˜¤ê¸°
                var imageUrl = config.images[floorId];
                if (!imageUrl) {
                    coordDisplay.textContent = 'ì„ íƒí•˜ì‹  ì¸µì˜ ì´ë¯¸ì§€ ë°ì´í„°ê°€ ì—†ì–´ìš”.';
                    return;
                }

                // ê¸°ì¡´ ì˜¤ë²„ë ˆì´ ì œê±°
                if (groundOverlay) {
                    groundOverlay.setMap(null);
                }
                
                // ìƒˆ ì˜¤ë²„ë ˆì´ ìƒì„± ë° í‘œì‹œ
                groundOverlay = new naver.maps.GroundOverlay(
                    imageUrl,
                    config.imageBounds,
                    { opacity: 1, visible: true }
                );
                groundOverlay.setMap(map);
                
                // í˜„ì¬ ì¸µ ì •ë³´ ì—…ë°ì´íŠ¸
                config.currentFloor = floorId;
                
                // ì¸µ ë²„íŠ¼ UI ì—…ë°ì´íŠ¸
                renderFloorButtons(buildingId);
                
                // íŒì—… ë‹«ê¸° (ì¸µì´ ë°”ë€Œì—ˆìœ¼ë¯€ë¡œ)
                popup.style.display = 'none';
                if (accessBtn) {
                    accessBtn.classList.remove('active');
                }
            }

            /** ì‹¤ë‚´ ëª¨ë“œ ì§„ì… ì‹œ UI ë³€ê²½ */
            function enterIndoorMode(buildingId) {
                // ... (ì´ì „ ì½”ë“œì™€ ë™ì¼í•œ ë¡œì§) ...
                searchBox.style.display = 'none';
                coordDisplay.style.top = '10px';
                coordDisplay.classList.remove('outdoor-mode-coord');

                var config = buildings[buildingId];
                if (config && config.polygonCoords && config.polygonCoords.length > 0) {
                    var bounds = new naver.maps.LatLngBounds();
                    config.polygonCoords.forEach(function(coord) {
                        bounds.extend(coord);
                    });
                    var centerPoint = bounds.getCenter();
                    map.setCenter(centerPoint);
                    map.setZoom(18); 
                }
                currentBuildingId = buildingId;
                labelLayer.setMap(null);
                
                // ì¸µ ë²„íŠ¼ ë° ë¬´ì¥ì•  ì‹œì„¤ ì •ë³´ ë Œë”ë§
                renderFloorButtons(buildingId);
                showFloor(config.currentFloor, buildingId);
                floorControlsContainer.style.display = 'flex';
                
                coordDisplay.textContent = 'ì¼ë°˜ì§€ë„ë¡œ ëŒì•„ê°€ë ¤ë©´ ì‹¤ë‚´ì§€ë„ë¥¼ í´ë¦­í•˜ì„¸ìš”';
            }

            /** ì‹¤ë‚´ ëª¨ë“œ ì¢…ë£Œ ì‹œ UI ë³€ê²½ */
            function exitIndoorMode() {
                if (!currentBuildingId) return;
                if (groundOverlay) {
                    groundOverlay.setMap(null);
                }
                
                popup.style.display = 'none';
                if (accessBtn) {
                    accessBtn.classList.remove('active');
                }
                
                var id;
                for (id in buildings) {
                    if (buildings.hasOwnProperty(id) && buildings[id].polygon) {
                        buildings[id].polygon.setMap(map);
                        buildings[id].polygon.setOptions({ fillColor: 'transparent' });
                    }
                }
            
                floorControlsContainer.style.display = 'none';
                labelLayer.setMap(map);
                currentBuildingId = null;
            
                searchBox.style.display = 'flex';
                coordDisplay.style.top = '78px';
                coordDisplay.classList.add('outdoor-mode-coord');
                coordDisplay.textContent = 'ê±´ë¬¼ì„ í´ë¦­í•˜ë©´ ì‹¤ë‚´ì§€ë„ë¥¼ ë³¼ ìˆ˜ ìˆì–´ìš”';
            }

            /** ë¬´ì¥ì•  ì‹œì„¤ íŒì—… ë‚´ìš© ì—…ë°ì´íŠ¸ */
            function updateAccessPopup(buildingId) {
                var config = buildings[buildingId];
                if (!config) return;
                
                // 1. ê±´ë¬¼ ì •ë³´ ì„¹ì…˜
                var info = config.buildingInfo;
                buildingInfoSection.innerHTML = 
                    '<img src="' + info.image_url + '" alt="' + info.name + '" style="width:100%; border-radius:8px; margin-bottom:10px;">' +
                    '<h3 style="margin:0 0 5px 0;">' + info.name + '</h3>' +
                    '<p style="margin:0; font-size:14px; color:#555;">' + info.address + '</p>' +
                    '<p style="margin:5px 0 0 0; font-size:12px; color:#888;">' + info.operating_hours + '</p>';
                
                // 2. ë¬´ì¥ì•  ì‹œì„¤ ì„¹ì…˜
                var access = config.accessInfo;
                var facilityHTML = '<h4 style="margin:15px 0 10px 0;">ë¬´ì¥ì•  ì‹œì„¤ ì •ë³´</h4><ul style="list-style:none; padding:0; margin:0;">';
                
                var key;
                for (key in access) {
                    if (access.hasOwnProperty(key)) {
                        var status = access[key] ? 'O' : 'X';
                        var color = access[key] ? 'green' : 'red';
                        facilityHTML += 
                            '<li style="display:flex; justify-content:space-between; padding:5px 0; border-bottom:1px solid #eee; font-size:15px;">' + 
                            '<span>' + key + '</span>' + 
                            '<span style="font-weight:bold; color:' + color + ';">' + status + '</span>' +
                            '</li>';
                    }
                }
                facilityHTML += '</ul>';
                accessFacilitySection.innerHTML = facilityHTML;
            }

            /** ê° ê±´ë¬¼ì— í´ë¦¬ê³¤ ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • */
            function setupBuilding(id, config) {
                var polygon = new naver.maps.Polygon({
                    map: map,
                    paths: config.polygonCoords,
                    fillColor: 'transparent',
                    fillOpacity: 0.8,
                    strokeColor: '#000000',
                    strokeOpacity: 0.0, // í‰ì†Œì—ëŠ” íˆ¬ëª…
                    strokeWeight: 1,
                    zIndex: 1000
                });

                config.polygon = polygon;

                // í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                naver.maps.Event.addListener(polygon, 'click', function() {
                    if (currentBuildingId === id) {
                        exitIndoorMode();
                    } else {
                        // ë‹¤ë¥¸ ê±´ë¬¼ì„ í´ë¦­í–ˆì„ ê²½ìš°, ê¸°ì¡´ ëª¨ë“œ ì¢…ë£Œ í›„ ìƒˆ ëª¨ë“œ ì§„ì…
                        if (currentBuildingId) {
                            exitIndoorMode();
                        }
                        // í´ë¦¬ê³¤ ìƒ‰ìƒ ë³€ê²½ (ì‹¤ë‚´ ëª¨ë“œ ì§„ì… í‘œì‹œ)
                        polygon.setOptions({ fillColor: 'rgba(0, 100, 255, 0.2)' });
                        enterIndoorMode(id);
                        // íŒì—… ë‚´ìš© ì—…ë°ì´íŠ¸ (íŒì—…ì€ ìë™ìœ¼ë¡œ ì—´ë¦¬ì§€ ì•ŠìŒ)
                        updateAccessPopup(id); 
                    }
                });
            }

            // =========================================================
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ëª¨ë°”ì¼/ë°ìŠ¤í¬í†± ë¶„ë¦¬ ë¡œì§ í¬í•¨)
            // =========================================================
            
            // ë¬´ì¥ì•  ì‹œì„¤ ë²„íŠ¼ í´ë¦­ ë¦¬ìŠ¤ë„ˆ (ë¡œì§ ë¶„ë¦¬)
            // ğŸš¨ accessBtnì— ë¦¬ìŠ¤ë„ˆë¥¼ í•œ ë²ˆë§Œ ì—°ê²°
            if (accessBtn) {
                accessBtn.addEventListener('click', function() {
                    if (!currentBuildingId) {
                        coordDisplay.textContent = 'ë¬´ì¥ì•  ì‹œì„¤ ì •ë³´ëŠ” ê±´ë¬¼ì„ í´ë¦­í•˜ì—¬ ì‹¤ë‚´ ëª¨ë“œ ì§„ì… í›„ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”.';
                        return;
                    }

                    var isOpen = popup.style.display === 'block';
                    
                    if (!isOpen) {
                        var buttonRect = accessBtn.getBoundingClientRect();
                        
                        // ğŸš¨ ëª¨ë°”ì¼ ë° ë°ìŠ¤í¬í†± ìœ„ì¹˜ ê³„ì‚° ë¶„ê¸°
                        if (isMobile()) {
                            // ëª¨ë°”ì¼: ë²„íŠ¼ ì˜†ì— í‘œì‹œ, í•˜ë‹¨ 20px ê³ ì •
                            var newPopupLeft = buttonRect.right + 5;
                            popup.style.bottom = '20px';
                            popup.style.left = newPopupLeft + 'px'; 
                            popup.style.top = 'auto';
                            popup.style.right = 'auto';
                            
                        } else {
                            // ë°ìŠ¤í¬í†±: ìš°ì¸¡ í•˜ë‹¨ì—ì„œ ë²„íŠ¼ê³¼ ê°™ì€ ë†’ì´ì— í‘œì‹œ (CSSì—ì„œ right 80px ì„¤ì •)
                            popup.style.bottom = '80px'; 
                            popup.style.top = 'auto';
                            popup.style.left = 'auto';
                        }
                        
                        popup.style.display = 'block';
                        this.classList.add('active');
                    } else {
                        popup.style.display = 'none';
                        this.classList.remove('active');
                    }
                });
            }


            // í˜„ì¬ ìœ„ì¹˜ ë²„íŠ¼ í´ë¦­ ë¦¬ìŠ¤ë„ˆ (ê¸°ëŠ¥ ë³µêµ¬)
            if (geolocationBtn) {
                geolocationBtn.addEventListener('click', function() {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(function(position) {
                            var lat = position.coords.latitude;
                            var lng = position.coords.longitude;
                            var latlng = new naver.maps.LatLng(lat, lng);
                            
                            map.setCenter(latlng);
                            map.setZoom(18);

                            // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
                            if (currentPositionMarker) {
                                currentPositionMarker.setMap(null);
                            }

                            // ìƒˆ ë§ˆì»¤ ìƒì„±
                            currentPositionMarker = new naver.maps.Marker({
                                map: map,
                                position: latlng,
                                icon: {
                                    url: 'https://navermaps.github.io/maps.js/docs/img/example/pin_default.png',
                                    size: new naver.maps.Size(24, 37),
                                    anchor: new naver.maps.Point(12, 37)
                                },
                                title: 'í˜„ì¬ ìœ„ì¹˜'
                            });
                            coordDisplay.textContent = 'í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.';
                        }, function(error) {
                            coordDisplay.textContent = 'ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message;
                        });
                    } else {
                        coordDisplay.textContent = 'ë¸Œë¼ìš°ì €ê°€ Geolocationì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                    }
                });
            }

            // ëª¨ë“  ê±´ë¬¼ ì„¤ì •
            var id;
            for (id in buildings) {
                if (buildings.hasOwnProperty(id)) {
                    setupBuilding(id, buildings[id]);
                }
            }

            // ì§€ë„ í´ë¦­ ë¦¬ìŠ¤ë„ˆ (ê¸°ë³¸ ë¬¸êµ¬ ìœ ì§€)
            naver.maps.Event.addListener(map, 'click', function (e) {
                if (!groundOverlay || groundOverlay.getMap() === null) {
                    coordDisplay.textContent = 'ê±´ë¬¼ì„ í´ë¦­í•˜ë©´ ì‹¤ë‚´ì§€ë„ë¥¼ ë³¼ ìˆ˜ ìˆì–´ìš”';
                }
            });
            
            // ë¬´ì¥ì•  ì‹œì„¤ì •ë³´ íŒì—… ë‹«ê¸° ì´ë²¤íŠ¸ (X ë²„íŠ¼ í´ë¦­)
            if (popupClose) {
                popupClose.onclick = function() {
                    popup.style.display = 'none';
                    if (accessBtn) {
                        accessBtn.classList.remove('active');
                    }
                };
            }
            
        }; // script.onload ì¢…ë£Œ

        // API ë¡œë“œ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ë©”ì‹œì§€
        script.onerror = function () {
            console.error('ë„¤ì´ë²„ ì§€ë„ API ë¡œë“œ ì‹¤íŒ¨! URL ë˜ëŠ” Keyë¥¼ í™•ì¸í•˜ì„¸ìš”.');
        };

        document.head.appendChild(script);
        
    </script>
</body>
</html>

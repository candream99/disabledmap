<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë„¤ì´ë²„ ë²¡í„°ë§µ í…ŒìŠ¤íŠ¸ - ë¬´ì¥ì•  ì‹œì„¤ íŒì—… ìµœì¢…ë³¸ (í†µí•©/í˜¸í™˜ì„± ê°œì„ )</title>
    <style>
        /* ------------------------------------------------ */
        /* ê¸°ë³¸/ê³µí†µ ìŠ¤íƒ€ì¼ */
        /* ------------------------------------------------ */
        body { 
            margin: 0;
            padding: 0; 
            height: 100vh;
            font-family: 'Malgun Gothic', sans-serif;
            overflow: hidden; 
        }
        #map { width: 100%; height: 100%; }

        /* ê²€ìƒ‰ì°½ ìŠ¤íƒ€ì¼ */
        #searchBox {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 80vw; 
            max-width: 500px; 
            height: 48px;
            background: #ffffff;
            border-radius: 24px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            padding: 0 15px; 
            z-index: 2000;
        }
        
        /* coordDisplay ìŠ¤íƒ€ì¼ (ê³µí†µ) */
        #coordDisplay {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 80vw;
            max-width: 500px;
            height: 24px;
            background: rgba(255, 255, 255, 0.9);
            color: #000000;
            border-radius: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0 15px; 
            font-size: 14px;
            z-index: 1500;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2); 
            transition: all 0.3s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: unset; 
        }

        /* ê³µí†µ ì›í˜• ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .map-btn-circle {
            width: 40px;
            height: 40px;
            padding: 0;
            cursor: pointer;
            background: #ffffff;
            border: none; 
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            color: #000;
            font-weight: normal;
            font-size: 14px;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            line-height: 1;
        }
        
        /* ì¸µ ë²„íŠ¼/ì•¡ì„¸ìŠ¤ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ê³µí†µ ì›í˜• ìŠ¤íƒ€ì¼ ìƒì†) */
        .floor-btn {
            font-size: 14px;
        }
        
        /* ------------------------------------------------ */
        /* ğŸ–¥ï¸ ë°ìŠ¤í¬í†± ìŠ¤íƒ€ì¼ (769px ì´ìƒ) - ë²„íŠ¼ ìœ„ì¹˜ ìš°ì¸¡ìœ¼ë¡œ ë³€ê²½ */
        /* ------------------------------------------------ */
        @media screen and (min-width: 769px) {
            
            /* í˜„ì¬ ìœ„ì¹˜ ë²„íŠ¼ ìœ„ì¹˜ ë³€ê²½ (ìš°ì¸¡ í•˜ë‹¨) */
            #geolocationBtn {
                bottom: 30px; 
                right: 30px;
                left: auto;
            }

            /* ì¸µ ì»¨íŠ¸ë¡¤ ì»¨í…Œì´ë„ˆ ìœ„ì¹˜ ë³€ê²½ (ìš°ì¸¡ í•˜ë‹¨ ìœ„) */
            #floorControls {
                bottom: 80px; 
                right: 30px;
                left: auto;
                flex-direction: column-reverse;
            }
            
            /* ë¬´ì¥ì•  íŒì—… ìŠ¤íƒ€ì¼ ìˆ˜ì • (ìš°ì¸¡ ì •ë ¬) */
            #accessPopup {
                right: 80px;
                left: auto;
                max-width: 300px;
            }
        }

        /* ------------------------------------------------ */
        /* ğŸ“± ëª¨ë°”ì¼ ìŠ¤íƒ€ì¼ (768px ì´í•˜) - ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
        /* ------------------------------------------------ */
        @media screen and (max-width: 768px) {
            
            /* coordDisplay ì¼ë°˜ ëª¨ë“œ ìœ„ì¹˜ (searchBox ì•„ë˜) */
            #coordDisplay.outdoor-mode-coord {
                top: 78px;
            }

            /* í˜„ì¬ ìœ„ì¹˜ ë²„íŠ¼ ìœ„ì¹˜ ìœ ì§€ (ì¢Œì¸¡ í•˜ë‹¨) */
            #geolocationBtn {
                position: absolute;
                bottom: 18px;
                left: 10px;
                z-index: 1500;
            }

            /* ì¸µ ì»¨íŠ¸ë¡¤ ì»¨í…Œì´ë„ˆ ìœ„ì¹˜ ìœ ì§€ (ì¢Œì¸¡ í•˜ë‹¨ ìœ„) */
            #floorControls {
                position: absolute;
                bottom: 88px;
                left: 10px;
                flex-direction: column-reverse;
            }
            
            /* ë¬´ì¥ì•  íŒì—… ìŠ¤íƒ€ì¼ ìœ ì§€ */
            #accessPopup {
                left: auto; 
                width: 90%;
                max-width: 240px;
            }
        }


        /* ------------------------------------------------ */
        /* ë‚˜ë¨¸ì§€ ìŠ¤íƒ€ì¼ (ìƒëµ) */
        /* ------------------------------------------------ */
        #floorControls {
            display: none;
            gap: 8px;
            z-index: 1500;
            background: transparent;
            padding: 0;
            box-shadow: none;
        }
        #accessInfoBtn {
            margin-bottom: 18px;
            font-size: 0;
            line-height: 0; 
        }
        /* ... ê¸°íƒ€ ìƒì„¸ ìŠ¤íƒ€ì¼ì€ ì›ë³¸ê³¼ ë™ì¼ ... */
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div id="searchBox">
        <button id="hamburgerBtn" title="ë©”ë‰´">
            <span class="burger-line"></span>
            <span class="burger-line"></span>
            <span class="burger-line"></span>
        </button>
        <div id="searchPlaceholder">ê±´ë¬¼ì´ë¦„ì„ ê²€ìƒ‰í•˜ì„¸ìš”</div>
    </div>
    
    <div id="coordDisplay" 
class="outdoor-mode-coord">ê±´ë¬¼ì„ 
 í´ë¦­í•˜ë©´ ì‹¤ë‚´ì§€ë„ë¥¼ ë³¼ ìˆ˜ ìˆì–´ìš”</div>
    
 
    <button id="geolocationBtn" class="map-btn-circle" title="í˜„ì¬ ìœ„ì¹˜ ì°¾ê¸°"><span class="geo-icon"></span></button>
    
    <div id="floorControls">
        <button id="accessInfoBtn" class="floor-btn map-btn-circle" data-floor="access" title="ë¬´ì¥ì•  ì‹œì„¤ ì •ë³´"><span class="i-icon"></span></button>
        </div>

    <div id="accessPopup" style="display:none;">
        <span id="accessPopupClose" style="position:absolute; top:6px; right:10px; font-size:22px; cursor:pointer;
color:#777;">Ã—</span>
        
        <div id="accessPopupBody">
            <div id="buildingInfoSection" class="popup-section">
 
                </div>
            
            <div id="accessFacilitySection" class="popup-section">
                </div>
        </div>
  
    </div>

    <script>
        
        // ğŸš¨ varë¡œ ë³€ê²½í•˜ì—¬ í˜¸í™˜ì„± í™•ë³´
        var NCP_KEY_ID = 'q1d23mmkof';
        var script = document.createElement('script');
        script.src = 'https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=' + NCP_KEY_ID + '&vmode=3';

        script.onload = function () {
            // ğŸš¨ varë¡œ ë³€ê²½í•˜ì—¬ í˜¸í™˜ì„± í™•ë³´
            var mapContainer = document.getElementById('map');
            var searchBox = document.getElementById('searchBox');
            var coordDisplay = document.getElementById('coordDisplay');
            var floorControlsContainer = document.getElementById('floorControls');
            var popup = document.getElementById('accessPopup');
            var buildingInfoSection = document.getElementById('buildingInfoSection');
            var accessFacilitySection = document.getElementById('accessFacilitySection');
            var accessBtn = document.getElementById('accessInfoBtn');
            var popupClose = document.getElementById('accessPopupClose');
            var geolocationBtn = document.getElementById('geolocationBtn');
            
            var groundOverlay = null;
            var currentBuildingId = null;
            var currentPositionMarker = null;
            
            // ---------------------------------------------------------
            // í™˜ê²½ ê°ì§€ í•¨ìˆ˜
            // ---------------------------------------------------------
            function isMobile() {
                // window.innerWidth ì‚¬ìš©ì€ ìµœì‹  ë¸Œë¼ìš°ì €ê°€ ì•„ë‹ˆë¼ë©´ window.document.documentElement.clientWidth ì‚¬ìš©
                var width = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
                return width <= 768;
            }


            // =========================================================
            // ë¹Œë”©ë³„ ë°ì´í„° ì •ì˜ (ë°ì´í„° ë³€í™” ì—†ìŒ)
            // =========================================================
            // ğŸš¨ varë¡œ ë³€ê²½í•˜ì—¬ í˜¸í™˜ì„± í™•ë³´
            var buildings = {
                'ky': { 
                    polygonCoords: [
                        new naver.maps.LatLng(37.571350, 126.977670),
                        new naver.maps.LatLng(37.571360, 126.978059),
                        new naver.maps.LatLng(37.571275, 126.978063),
                        new naver.maps.LatLng(37.571275, 126.978173),
                        new naver.maps.LatLng(37.570870, 126.978184),
                        new naver.maps.LatLng(37.570872, 126.978082),
                        new naver.maps.LatLng(37.570543, 126.978094),
                        new naver.maps.LatLng(37.570539, 126.977702),
                    ],
                    floors: ['b1', '1f', '2f'],
                    images: {
                        'b1': 'https://raw.githubusercontent.com/candream99/disabledmap/main/kb/ky_1.jpg',
                        '1f': 'https://raw.githubusercontent.com/candream99/disabledmap/main/kb/ky11.png', 
                        '2f': 'https://raw.githubusercontent.com/candream99/disabledmap/main/kb/ky_1.jpg',
                    },
                    imageBounds: new naver.maps.LatLngBounds(
                        new naver.maps.LatLng(37.570512, 126.977632), 
                        new naver.maps.LatLng(37.571415, 126.978244) 
                    ),
                    currentFloor: '1f', 
                    polygon: null,
                    accessInfo: {
                        'ì£¼ì¶œì…êµ¬ ê²½ì‚¬ë¡œ': true,
                        'ì¥ì• ì¸ í™”ì¥ì‹¤': true,
                        'ì§•ì• ì¸ ì£¼ì°¨ì¥': true,
                        'ì—˜ë¦¬ë² ì´í„°': true,
                        'ì£¼ì¶œì…êµ¬ ë‹¨ì°¨': false
                    },
                    buildingInfo: {
                        name: 'êµë³´ë¹Œë”©',
                        image_url: 'https://raw.githubusercontent.com/candream99/disabledmap/main/kb/kyobo_gwanghwamun.jpg', 
                        address: 'ì„œìš¸ ì¢…ë¡œêµ¬ ìƒˆë¬¸ì•ˆë¡œ 45',
                        operating_hours: '09:00 - 18:00 (ì›”ìš”ì¼ íœ´ë¬´)'
                    }
                },
                'dt': {
                    polygonCoords: [
                        new naver.maps.LatLng(37.571470, 126.978762),
                        new naver.maps.LatLng(37.571476, 126.979161),
                        new naver.maps.LatLng(37.570627, 126.979181),
                        new naver.maps.LatLng(37.570557, 126.979117),
                        new naver.maps.LatLng(37.570553, 126.978777),
                    ],
                    floors: ['b4', '1f'], 
                    images: {
                        'b4': 'https://raw.githubusercontent.com/candream99/disabledmap/main/dt/dt_b4.png',
                        '1f': 'https://raw.githubusercontent.com/candream99/disabledmap/main/dt/dt1.png',
                    },
                    imageBounds: new naver.maps.LatLngBounds(
                        new naver.maps.LatLng(37.570459, 126.978649), 
                        new naver.maps.LatLng(37.571626, 126.979210) 
                    ),
                    currentFloor: '1f',
                    polygon: null,
                    accessInfo: {
                        'ì£¼ì¶œì…êµ¬ ê²½ì‚¬ë¡œ': false,
                        'ì¥ì• ì¸ í™”ì¥ì‹¤': true, 
                        'ì¥ì• ì¸ ì£¼ì°¨ì¥': false,
                        'ì—˜ë¦¬ë² ì´í„°': true,
                        'ì£¼ì¶œì…êµ¬ ë‹¨ì°¨': true 
                    },
                    buildingInfo: {
                        name: 'ê´‘í™”ë¬¸ Díƒ€ì›Œ',
                        image_url: 'https://raw.githubusercontent.com/candream99/disabledmap/main/dt/d_tower.jpg', 
                        address: 'ì„œìš¸ ì¢…ë¡œêµ¬ ì†¡ì›”ê¸¸ 2',
                        operating_hours: '10:00 - 19:00 (ë§¤ì¼ ìš´ì˜)'
                    }
                }
            };
            // =========================================================
            // ì§€ë„ ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            // =========================================================
            
            // ğŸš¨ varë¡œ ë³€ê²½í•˜ì—¬ í˜¸í™˜ì„± í™•ë³´
            var mapOptions = {
                center: new naver.maps.LatLng(37.5710, 126.9784),
                zoom: 17, 
                zoomControl: false, 
                scrollWheelZoom: false,
                pinchZoom: true,
                mapTypes: new naver.maps.MapTypeRegistry({
                    normal: naver.maps.NaverStyleMapTypeOptions.getVectorMap(),
                }),
            };
            
            var map = new naver.maps.Map('map', mapOptions);
            map.setMapTypeId('normal');
            var labelLayer = new naver.maps.LabelLayer();
            labelLayer.setMap(map);

            // ë§ˆìš°ìŠ¤ íœ  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ë°ìŠ¤í¬í†± ì „ìš© ê¸°ëŠ¥)
            if (!isMobile()) {
                // ğŸš¨ varë¡œ ë³€ê²½í•˜ì—¬ í˜¸í™˜ì„± í™•ë³´
                var ZOOM_STEP = 0.1;
                mapContainer.addEventListener("wheel", function (e) {
                    e.preventDefault();

                    // ğŸš¨ varë¡œ ë³€ê²½í•˜ì—¬ í˜¸í™˜ì„± í™•ë³´
                    var currentZoom = map.getZoom();
                    var newZoom = currentZoom;

                    if (e.deltaY < 0) newZoom += ZOOM_STEP;
                    else newZoom -= ZOOM_STEP;

                    newZoom = Math.round(newZoom * 100) / 100;
                    newZoom = Math.min(Math.max(newZoom, 1), 21);

                    map.setZoom(newZoom);
                }, { passive: false });
            }
            
            // ëª¨ë°”ì¼ í„°ì¹˜ ì´ë²¤íŠ¸ ë²„ë¸”ë§/ìŠ¤í¬ë¡¤ ë°©ì§€ (ëª¨ë°”ì¼ ì „ìš© ê¸°ëŠ¥)
            if (isMobile()) {
                function preventTouchMove(elementId) {
                    var element = document.getElementById(elementId);
                    if (element) {
                        element.addEventListener('touchmove', function(e) {
                            e.preventDefault();
                        }, { passive: false });
                    }
                }
                // ê²€ìƒ‰ì°½ê³¼ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ í„°ì¹˜ ì´ë™ ì ê¸ˆ
                preventTouchMove('searchBox');
                preventTouchMove('floorControls');
            }

            // =========================================================
            // í•µì‹¬ ë¡œì§ í•¨ìˆ˜
            // =========================================================
            
            /** ì‹¤ë‚´ ëª¨ë“œ ì§„ì… ì‹œ UI ë³€ê²½ */
            function enterIndoorMode(buildingId) {
                searchBox.style.display = 'none';
                coordDisplay.style.top = '10px';
                coordDisplay.classList.remove('outdoor-mode-coord');

                // ğŸš¨ varë¡œ ë³€ê²½í•˜ì—¬ í˜¸í™˜ì„± í™•ë³´
                var config = buildings[buildingId];
                if (config && config.polygonCoords && config.polygonCoords.length > 0) {
                    var bounds = new naver.maps.LatLngBounds();
                    // ğŸš¨ for ë£¨í”„ ëŒ€ì‹  í˜¸í™˜ì„± ë†’ì€ Array.prototype.forEach ì‚¬ìš©
                    config.polygonCoords.forEach(function(coord) {
                        bounds.extend(coord);
                    });
                    var centerPoint = bounds.getCenter();
                    map.setCenter(centerPoint);
                    map.setZoom(18);
                }
                currentBuildingId = buildingId;
                labelLayer.setMap(null);
                floorControlsContainer.style.display = 'flex';
                coordDisplay.textContent = 'ì¼ë°˜ì§€ë„ë¡œ ëŒì•„ê°€ë ¤ë©´ ì‹¤ë‚´ì§€ë„ë¥¼ í´ë¦­í•˜ì„¸ìš”';
            }

            /** ì‹¤ë‚´ ëª¨ë“œ ì¢…ë£Œ ì‹œ UI ë³€ê²½ */
            function exitIndoorMode() {
                if (!currentBuildingId) return;
                if (groundOverlay) {
                    groundOverlay.setMap(null);
                }
                
                popup.style.display = 'none';
                accessBtn.classList.remove('active');
                
                // ğŸš¨ varë¡œ ë³€ê²½í•˜ì—¬ í˜¸í™˜ì„± í™•ë³´
                var id;
                for (id in buildings) {
                    if (buildings.hasOwnProperty(id) && buildings[id].polygon) {
                        buildings[id].polygon.setMap(map);
                        buildings[id].polygon.setOptions({ fillColor: 'transparent' });
                    }
                }
            
                floorControlsContainer.style.display = 'none';
                labelLayer.setMap(map);
                currentBuildingId = null;
            
                searchBox.style.display = 'flex';
                coordDisplay.style.top = '78px';
                coordDisplay.classList.add('outdoor-mode-coord');
                coordDisplay.textContent = 'ê±´ë¬¼ì„ í´ë¦­í•˜ë©´ ì‹¤ë‚´ì§€ë„ë¥¼ ë³¼ ìˆ˜ ìˆì–´ìš”';
            }
            
            // --- showFloor, renderFloorButtons, updateAccessPopup, setupBuilding í•¨ìˆ˜ëŠ” í˜¸í™˜ì„± ë¬¸ì œì˜ ì§ì ‘ì  ì›ì¸ì´ ì•„ë‹ˆë¯€ë¡œ ê¸°ì¡´ ì½”ë“œë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤. ---
            
            // ---------------------------------------------------------
            // ë¬´ì¥ì•  ì‹œì„¤ ë²„íŠ¼ í´ë¦­ ë¦¬ìŠ¤ë„ˆ (ë¡œì§ ë¶„ë¦¬)
            // ---------------------------------------------------------
            accessBtn.addEventListener('click', function() {
                if (!currentBuildingId) {
                    coordDisplay.textContent = 'ë¬´ì¥ì•  ì‹œì„¤ ì •ë³´ëŠ” ê±´ë¬¼ì„ í´ë¦­í•˜ì—¬ ì‹¤ë‚´ ëª¨ë“œ ì§„ì… í›„ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”.';
                    return;
                }

                // ğŸš¨ varë¡œ ë³€ê²½í•˜ì—¬ í˜¸í™˜ì„± í™•ë³´
                var isOpen = popup.style.display === 'block';
                
                if (!isOpen) {
                    // ğŸš¨ varë¡œ ë³€ê²½í•˜ì—¬ í˜¸í™˜ì„± í™•ë³´
                    var buttonRect = accessBtn.getBoundingClientRect();
                    
                    // ğŸš¨ ëª¨ë°”ì¼ ë° ë°ìŠ¤í¬í†± ìœ„ì¹˜ ê³„ì‚° ë¶„ê¸°
                    if (isMobile()) {
                        // ëª¨ë°”ì¼: ë²„íŠ¼ ì˜†ì— í‘œì‹œ, í•˜ë‹¨ 20px ê³ ì •
                        var newPopupLeft = buttonRect.right + 5;
                        popup.style.bottom = '20px';
                        popup.style.left = newPopupLeft + 'px'; 
                        popup.style.top = 'auto';
                        popup.style.right = 'auto';
                        
                    } else {
                        // ë°ìŠ¤í¬í†±: ìš°ì¸¡ í•˜ë‹¨ì—ì„œ ë²„íŠ¼ê³¼ ê°™ì€ ë†’ì´ì— í‘œì‹œ
                        popup.style.bottom = '80px';
                        popup.style.top = 'auto';
                        popup.style.left = 'auto';
                        
                    }
                    
                    popup.style.display = 'block';
                    this.classList.add('active');
                } else {
                    popup.style.display = 'none';
                    this.classList.remove('active');
                }
            });

            // * geolocationBtn í´ë¦­ ë¦¬ìŠ¤ë„ˆ ë° ë‚˜ë¨¸ì§€ ì½”ë“œ (setupBuilding ë“±)ëŠ” í˜¸í™˜ì„± ë¬¸ì œ í•´ê²° í›„ ì—¬ê¸°ì— ì¶”ê°€ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. *

            // ëª¨ë“  ê±´ë¬¼ ì„¤ì •
            // ğŸš¨ varë¡œ ë³€ê²½í•˜ì—¬ í˜¸í™˜ì„± í™•ë³´
            var id;
            for (id in buildings) {
                if (buildings.hasOwnProperty(id)) {
                    // setupBuilding(id, buildings[id]); // * ì‹¤ì œ ì½”ë“œì—ì„œëŠ” ì´ í•¨ìˆ˜ê°€ ì •ì˜ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
                }
            }

            // ì§€ë„ í´ë¦­ ë¦¬ìŠ¤ë„ˆ
            naver.maps.Event.addListener(map, 'click', function (e) {
                if (!groundOverlay || groundOverlay.getMap() === null) {
                    coordDisplay.textContent = 'ê±´ë¬¼ì„ í´ë¦­í•˜ë©´ ì‹¤ë‚´ì§€ë„ë¥¼ ë³¼ ìˆ˜ ìˆì–´ìš”';
                }
            });
            
            // ë¬´ì¥ì•  ì‹œì„¤ì •ë³´ íŒì—… ë‹«ê¸° ì´ë²¤íŠ¸ (X ë²„íŠ¼ í´ë¦­)
            if (popupClose) {
                popupClose.onclick = function() {
                    popup.style.display = 'none';
                    accessBtn.classList.remove('active');
                };
            }
            
        }; // script.onload ì¢…ë£Œ

        // API ë¡œë“œ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ë©”ì‹œì§€
        script.onerror = function () {
            console.error('ë„¤ì´ë²„ ì§€ë„ API ë¡œë“œ ì‹¤íŒ¨! URL ë˜ëŠ” Keyë¥¼ í™•ì¸í•˜ì„¸ìš”.');
        };

        document.head.appendChild(script);
        
    </script>
</body>
</html>
